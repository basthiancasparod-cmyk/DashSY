<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard de Operaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #0D1117;
            --surface: #161B22;
            --primary: #58A6FF;
            --secondary: #1F6FEB;
            --text-primary: #C9D1D9;
            --text-secondary: #8B949E;
            --border: #30363D;
            --success: #3FB950;
            --danger: #F85149;
            --warning: #D29922;
            --info: #4299e1;
        }
        html, body {
            overscroll-behavior-y: contain;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
        }
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
        }
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem 1rem calc(6rem + env(safe-area-inset-bottom));
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(5rem + env(safe-area-inset-bottom));
            background-color: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 0.75rem;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            transition: color 0.2s;
            padding: 0 0.5rem;
            border: none;
            background: none;
        }
        .nav-item.active {
            color: var(--primary);
        }
        .nav-item svg {
            width: 24px;
            height: 24px;
        }
        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
        }
        .card {
            background-color: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 1.25rem;
        }
        .card.clickable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .card.clickable:hover {
            background-color: #222831;
        }
        .btn-fab {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 9999px;
            border: none;
            padding: 1rem;
            box-shadow: 0 10px 20px rgba(88, 166, 255, 0.2), 0 6px 6px rgba(88, 166, 255, 0.23);
            position: fixed;
            bottom: calc(6rem + env(safe-area-inset-bottom));
            right: 1.5rem;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            min-width: 900px;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        th {
            background-color: var(--surface);
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--surface); color: var(--text-primary); border-radius: 24px; border: 1px solid var(--border); width: calc(100% - 2rem); max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { background: transparent; padding: 1.5rem 1.5rem 1rem 1.5rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .modal-title { color: var(--text-primary); font-size: 1.25rem; }
        .close-btn { color: var(--text-secondary); background-color: rgba(255, 255, 255, 0.1); border: none; border-radius: 50%; width: 32px; height: 32px; }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .form-group label { color: var(--text-secondary); }
        .form-group input, .form-group select { background-color: var(--background); border: 1px solid var(--border); color: var(--text-primary); border-radius: 12px; padding: 0.75rem 1rem; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2); outline: none; }
        .calc-display { background-color: var(--background); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; }
        .calc-row { display: flex; justify-content: space-between; }
        .calc-row.total { font-weight: bold; border-top: 1px solid var(--border); padding-top: 0.5rem; margin-top: 0.5rem; }
        .modal-buttons { background-color: transparent; border-top: 1px solid var(--border); padding: 1rem 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem; flex-shrink: 0; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; border: none; }
        .btn-primary { background: var(--primary); color: var(--background); }
        .btn-secondary { background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-green { background: var(--success); color: var(--background); }
        ::-webkit-scrollbar { width: 4px; height: 4px;}
        ::-webkit-scrollbar-track { background: var(--surface); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        #authSection { background-color: var(--background); }
        .auth-container { background-color: var(--surface); border-radius: 24px; border: 1px solid var(--border); }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #30363D; transition: .4s; border-radius: 24px;}
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;}
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background-color: var(--surface); border: 1px solid var(--border); color: var(--text-primary); padding: 0.75rem 1.25rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); display: flex; align-items: center; gap: 0.75rem; opacity: 0; transform: translateX(100%); transition: all 0.3s ease-out; font-weight: 500; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.hide { opacity: 0; transform: translateX(100%); }
        .info-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .info-card { background: var(--background); border-radius: 12px; border: 1px solid var(--border); padding: 1rem; text-align: center; }
        .info-card-title { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .info-card-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .info-card-details { font-size: 0.8rem; color: var(--text-secondary); }
        .operation-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .operation-list-item { background: var(--background); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; font-size: 0.8rem; }
        .op-label { color: var(--text-secondary); }

        .operations-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .operation-card { background-color: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; border-left-width: 4px; }
        .operation-card.compra { border-left-color: var(--success); }
        .operation-card.venta { border-left-color: var(--danger); }
        .card-header, .card-footer { display: flex; justify-content: space-between; align-items: center; }
        .card-header .user-info { font-weight: 600; }
        .card-header .user-info .payment-method { font-weight: 400; font-size: 0.8rem; color: var(--text-secondary); }
        .status-badge { font-size: 0.75rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 600; }
        .card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 0.75rem 0; }
        .grid-item { display: flex; flex-direction: column; text-align: center; }
        .grid-item .label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .grid-item .value { font-weight: 600; font-size: 0.9rem; }
        .grid-item .value .commission { font-size: 0.7rem; color: var(--danger); }
        .value.profit-green { color: var(--success); }
        .value.profit-red { color: var(--danger); }
        .card-footer .ref-info { font-size: 0.75rem; color: var(--text-secondary); font-family: monospace; }
        .card-footer .actions { display: flex; gap: 0.5rem; }
        .card-footer .action-btn { background: none; border: none; padding: 0.5rem; }
        .card-footer .action-btn.edit { color: var(--primary); }
        .card-footer .action-btn.delete { color: var(--danger); }
        
        #page-reports .operations-list-container,
        #page-wally .operations-list-container { display: block; }
        #page-reports .table-container,
        #page-wally .table-container { display: none; }

        @media (min-width: 1024px) {
            #page-reports .operations-list-container,
            #page-wally .operations-list-container { display: none; }
            #page-reports .table-container,
            #page-wally .table-container { display: block; }
        }

        #aiOperationsCenter { position: fixed; bottom: calc(10.5rem + env(safe-area-inset-bottom)); right: 1.5rem; z-index: 1002; }
        #aiToggleBtn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #6b45d3, #7857f0);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        #aiToggleBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(120, 87, 240, 0.4);
        }
        #aiToggleBtn svg {
            width: 24px;
            height: 24px;
        }
        #aiToggleBtn:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3); }
        #aiToggleBtn.has-alerts { animation: pulse-alert 2s infinite; }
        #aiToggleBtn.critical { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); animation: pulse-critical 1s infinite; }
        #aiNotificationBadge { position: absolute; top: -5px; right: -5px; background: #f56565; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; font-weight: bold; display: none; align-items: center; justify-content: center; border: 2px solid white; }
        @keyframes pulse-alert { 0% { box-shadow: 0 0 0 0 rgba(237, 137, 54, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(237, 137, 54, 0); } 100% { box-shadow: 0 0 0 0 rgba(237, 137, 54, 0); } }
        @keyframes pulse-critical { 0% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(245, 101, 101, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0); } }
        #aiPanel {
            position: absolute;
            bottom: calc(100% + 12px);
            right: 0;
            width: 450px;
            max-height: 600px;
            background: var(--surface);
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(15px) scale(0.98);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }
        #aiPanel.show { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
        #aiHeader { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; align-items: center; gap: 12px; }
        #aiHeader h3 { margin: 0; font-size: 16px; font-weight: 600; }
        #aiStatus { display: flex; align-items: center; gap: 8px; padding: 15px 20px; background: var(--surface); border-bottom: 1px solid var(--border); }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: blink 2s infinite; }
        .status-indicator.warning { background: var(--warning); }
        .status-indicator.critical { background: var(--danger); }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
        #aiNotifications { flex: 1; overflow-y: auto; max-height: 350px; padding: 10px; }
        .notification-section { margin-bottom: 15px; }
        .notification-section h4 { font-size: 1rem; color: var(--text-secondary); margin-bottom: 10px; padding: 5px 10px; background: var(--background); border-radius: 8px; display: flex; align-items: center; gap: 8px; }
        .notification { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 10px; position: relative; animation: slideIn 0.2s ease-out; transition: all 0.2s ease; }
        .notification.info { border-left: 4px solid var(--info); }
        .notification.success { border-left: 4px solid var(--success); }
        .notification.warning { border-left: 4px solid var(--warning); }
        .notification.danger { border-left: 4px solid var(--danger); }
        .notification-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .notification-title { font-weight: 600; font-size: 14px; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .notification-time { font-size: 11px; color: var(--text-secondary); }
        .notification-content { font-size: 13px; color: var(--text-primary); line-height: 1.4; }
        .notification-metrics { margin-top: 10px; padding: 10px; background: var(--background); border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; word-break: break-word; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        #aiControls { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .ai-control-btn { flex: 1; padding: 8px 12px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .ai-control-btn.clear { background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); }
        .ai-control-btn.clear:hover { background: var(--background); }
        #aiMetrics { padding: 15px 20px; background: var(--background); border-bottom: 1px solid var(--border); }
        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .metric-item { text-align: center; padding: 10px; background: var(--surface); border-radius: 8px; border: 1px solid var(--border); }
        .metric-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .metric-value { font-size: 14px; font-weight: 700; color: var(--text-primary); }
        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-value.warning { color: var(--warning); }
        @media (max-width: 768px) { #aiPanel { width: calc(100vw - 2rem); right: -1rem; bottom: 80px; } }
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--surface);
            border-radius: 16px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            flex-grow: 1;
            min-width: 180px;
        }
        .filter-item label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            padding-left: 0.25rem;
        }
        .filter-item input,
        .filter-item select {
            background-color: var(--background);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 0.6rem 1rem;
            font-size: 0.875rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
        }
        .filter-item input:focus,
        .filter-item select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
            outline: none;
        }
        .filter-item select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%238B949E'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9' /%3E%3C/svg%3E%0A");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        @media (min-width: 768px) {
            .filter-item.search-bar {
                flex-grow: 2;
                min-width: 300px;
            }
        }
    </style>
</head>
<body class="overscroll-none">

    <div id="authSection" class="h-screen w-screen flex items-center justify-center p-4">
        <div class="auth-container w-full max-w-sm p-8">
            <div id="loginForm"><h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2><div class="form-group mb-4 text-left"><label class="text-sm font-medium mb-1 block">Correo Electrónico:</label><input type="email" id="loginEmail" placeholder="tu@correo.com" class="w-full"></div><div class="form-group mb-6 text-left"><label class="text-sm font-medium mb-1 block">Contraseña:</label><input type="password" id="loginPassword" placeholder="••••••••" class="w-full"></div><button class="btn-primary w-full py-3 rounded-xl font-semibold" onclick="loginUser()">Entrar</button><p class="text-center mt-6 text-sm text-blue-400 cursor-pointer" onclick="toggleAuthForms()">¿No tienes cuenta? Regístrate</p></div>
            <div id="registerForm" style="display: none;"><h2 class="text-2xl font-bold text-center mb-6">Crear Cuenta</h2><div class="form-group mb-4 text-left"><label class="text-sm font-medium mb-1 block">Correo Electrónico:</label><input type="email" id="registerEmail" placeholder="tu@correo.com" class="w-full"></div><div class="form-group mb-6 text-left"><label class="text-sm font-medium mb-1 block">Contraseña:</label><input type="password" id="registerPassword" placeholder="Mínimo 6 caracteres" class="w-full"></div><button class="btn-primary w-full py-3 rounded-xl font-semibold" onclick="registerUser()">Registrarse</button><p class="text-center mt-6 text-sm text-blue-400 cursor-pointer" onclick="toggleAuthForms()">¿Ya tienes cuenta? Inicia Sesión</p></div>
            <p id="authError" class="text-red-500 mt-4 text-sm"></p>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <main class="main-content">
            <div id="page-operate" class="page">
                <div class="flex justify-between items-center mb-6"><h1 id="userEmail" class="text-2xl font-bold">Cargando...</h1><input type="date" id="selectedDate" class="bg-transparent border-none text-right font-semibold text-blue-400 focus:ring-0 p-0"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="card text-center clickable" onclick="openGainsSummaryModal()">
                        <p class="text-sm font-medium text-gray-400 mb-2">GANANCIA DEL DÍA</p>
                        <div id="ganancias" class="text-4xl font-extrabold text-green-400">0.00 <span class="text-2xl font-semibold">VES</span></div>
                        <div id="ganancias_usdc" class="text-lg font-semibold text-gray-300 mt-1">0.00 <span class="font-medium">USDC</span></div>
                    </div>
                    <div class="card text-center flex flex-col justify-center clickable" onclick="openWallyGainsSummaryModal()">
                        <p class="text-sm font-medium text-gray-400 mb-2">GANANCIA WALLY</p>
                        <div class="flex justify-center items-baseline gap-x-4">
                            <div id="wallyDashboardGainsUsdc" class="text-3xl font-bold text-orange-400">0.00 <span class="text-xl font-semibold">USDC</span></div>
                            <div id="wallyDashboardGainsUsd" class="text-3xl font-bold text-purple-400">0.00 <span class="text-xl font-semibold">USD</span></div>
                        </div>
                    </div>
                </div>
                <div class="card mb-6"><div class="flex justify-between items-center text-sm mb-2"><span class="font-medium text-gray-400">Meta Diaria</span><span id="dailyGoal" class="font-semibold">0 / 0 VES</span></div><div class="w-full bg-gray-700 rounded-full h-2"><div id="dailyProgressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div></div></div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="card text-center"><p class="text-sm font-medium text-gray-400">Prom. Compra</p><p id="promCompra" class="text-xl font-bold mt-1">0.00</p></div>
                    <div class="card text-center"><p class="text-sm font-medium text-gray-400">Prom. Venta</p><p id="promVenta" class="text-xl font-bold mt-1">0.00</p></div>
                    <div class="card text-center clickable" onclick="openBankBreachModal()"><p class="text-sm font-medium text-gray-400">Brecha</p><p id="brecha" class="text-xl font-bold mt-1">0%</p></div>
                    <div class="card text-center"><p class="text-sm font-medium text-gray-400">Operaciones</p><p id="totalOps" class="text-xl font-bold mt-1">0</p></div>
                    <div class="card text-center clickable" onclick="openLotDetailsModal()"><p class="text-sm font-medium text-gray-400">Lotes Activos</p><p id="activeLotsSummary" class="text-xl font-bold mt-1">0</p></div>
                    <div class="card text-center clickable" onclick="openPendingDetailsModal()"><p class="text-sm font-medium text-gray-400">Pendientes</p><p id="pendingSummary" class="text-xl font-bold mt-1">0 USDC</p></div>
                </div>
            </div>
            <div id="page-reports" class="page">
                 <h1 class="text-2xl font-bold mb-4">Reporte de Operaciones</h1>
                 <div class="filter-controls">
                    <div class="filter-item search-bar">
                        <label for="searchOperations">Buscar</label>
                        <input type="text" id="searchOperations" placeholder="Por usuario o referencia..." onkeyup="renderOperations()">
                    </div>
                    <div class="filter-item">
                        <label for="filterOperacion">Operación</label>
                        <select id="filterOperacion" onchange="renderOperations()">
                            <option value="">Todas</option>
                            <option value="Compra">Compra</option>
                            <option value="Venta">Venta</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filterMetodoPago">Método</label>
                        <select id="filterMetodoPago" onchange="renderOperations()"></select>
                    </div>
                </div>
                 
                 <div class="table-container">
                    <div class="card p-0">
                        <table>
                            <thead>
                                <tr><th>USUARIO/MÉTODO</th><th>REF</th><th>OP</th><th>TASA</th><th>USDC</th><th>BS</th><th>GAN. VES</th><th>GAN. USDC</th><th>LOTE</th><th>ESTATUS</th><th>ACC</th></tr>
                            </thead>
                            <tbody id="operationsTable"></tbody>
                        </table>
                    </div>
                 </div>

                 <div class="operations-list-container">
                    <div id="operationsList" class="operations-list"></div>
                </div>
            </div>
            <div id="page-wally" class="page">
                <div class="flex justify-between items-center mb-6"><h1 class="text-2xl font-bold">Wally Tech</h1><input type="date" id="wallySelectedDate" class="bg-transparent border-none text-right font-semibold text-blue-400 focus:ring-0 p-0"></div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="card text-center"><p class="text-sm text-gray-400">Val. Inicial</p><input type="number" id="wallyValorInicialInput" value="0.00" onchange="saveWallyValorInicial()" class="w-full bg-transparent text-center text-lg font-bold border-0 p-0"></div>
                    <div class="card text-center"><p class="text-sm text-gray-400">Val. Actual</p><p id="wallyValorActual" class="text-lg font-bold">0.00</p></div>
                    <div class="col-span-2 card text-center"><p class="text-sm text-gray-400">Ganancias</p><p id="wallyGanancias" class="text-lg font-bold">0 USDC / 0 USD</p></div>
                </div>
                <div class="space-y-6">
                    <div>
                    <h2 class="text-lg font-semibold mb-2 text-green-400">COMPRAS (Recibo USDC)</h2>
                    <div class="card p-0">
                        <div class="table-container">
                            <table class="w-full min-w-[600px]">
                                <thead><tr><th>Usuario</th><th>Recibo USDC</th><th>Tasa</th><th>Envío USD</th><th>Gan. USDC</th><th>Acc</th></tr></thead>
                                <tbody id="wallyCompraTable"></tbody>
                            </table>
                        </div>
                        <div class="operations-list-container p-4">
                            <div id="wallyCompraList" class="operations-list"></div>
                        </div>
                    </div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold mb-2 text-red-400">VENTAS (Recibo USD)</h2>
                    <div class="card p-0">
                        <div class="table-container">
                            <table class="w-full min-w-[600px]">
                                <thead><tr><th>Usuario</th><th>Envío USDC</th><th>Tasa</th><th>Recibo USD</th><th>Gan. USD</th><th>Acc</th></tr></thead>
                                <tbody id="wallyVentaTable"></tbody>
                            </table>
                        </div>
                        <div class="operations-list-container p-4">
                            <div id="wallyVentaList" class="operations-list"></div>
                        </div>
                    </div>
                </div>
                </div>
                <button class="btn-fab" onclick="openWallyModal()" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg></button>
            </div>
            <div id="page-settings" class="page">
                <h1 class="text-2xl font-bold mb-6">Ajustes</h1>
                <div class="space-y-4"><button onclick="openConfigModal()" class="w-full text-left p-4 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors">⚙️ Configuración General</button><button onclick="logoutUser()" class="w-full text-left p-4 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors">🚪 Cerrar Sesión</button></div>
            </div>
            <button id="main-fab" class="btn-fab" onclick="openModal()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg></button>
        </main>
        <nav class="bottom-nav">
            <button id="nav-operate" class="nav-item active" onclick="showPage('operate')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V6.375c0-.621.504-1.125 1.125-1.125h.375m18 0h-4.5m-4.5 0h-4.5m0 0h-4.5m0 0l-1.5 1.5m1.5-1.5l1.5 1.5m0 0l1.5-1.5m1.5 1.5l1.5-1.5m-3-3l1.5-1.5m1.5 1.5l1.5-1.5m-4.5 9l1.5-1.5m-1.5 1.5l1.5 1.5m0 0l-1.5 1.5m1.5-1.5l1.5 1.5M9 12l1.5 1.5m-1.5-1.5L9 12m0 0l-1.5-1.5m1.5 1.5L9 12m-3 3l1.5-1.5m-1.5 1.5L6 15m0 0l-1.5-1.5m1.5 1.5L6 15m6-3l1.5 1.5m-1.5-1.5L15 12m0 0l-1.5-1.5m1.5 1.5L15 12m0 0l-1.5 1.5m-1.5-1.5l-1.5-1.5"/></svg><span>Operar</span></button>
            <button id="nav-reports" class="nav-item" onclick="showPage('reports')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg><span>Reportes</span></button>
            <button id="nav-wally" class="nav-item" onclick="showPage('wally')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Wally</span></button>
            <button id="nav-settings" class="nav-item" onclick="showPage('settings')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg><span>Ajustes</span></button>
        </nav>
    </div>
    
    <div id="toast-container"></div>
    
    <div id="operationModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 class="modal-title text-xl font-bold" id="modalTitle">Nueva Operación</h2><button class="close-btn" onclick="closeModal()">&times;</button></div><div class="modal-body"><div class="space-y-4"><div class="form-group"><label class="text-sm font-medium mb-1 block">Usuario</label><input type="text" id="usuario" placeholder="Nombre del usuario" class="w-full"></div><div class="grid grid-cols-2 gap-4"><div class="form-group"><label class="text-sm font-medium mb-1 block">Referencia</label><input type="text" id="referencia" placeholder="Nº de referencia" class="w-full"></div><div class="form-group"><label class="text-sm font-medium mb-1 block">Estatus</label><select id="estatus" class="w-full"><option value="En Curso">En Curso</option><option value="En Disputa">En Disputa</option><option value="Completado">Completado</option></select></div></div><div class="grid grid-cols-2 gap-4"><div class="form-group"><label class="text-sm font-medium mb-1 block">Operación</label><select id="operacion" onchange="calculateAll()" class="w-full"><option value="Compra">Compra</option><option value="Venta">Venta</option></select></div><div class="form-group"><label class="text-sm font-medium mb-1 block">Método de Pago</label><select id="metodoPago" onchange="calculateAll()" class="w-full"></select></div></div><hr class="border-gray-700"><div class="grid grid-cols-2 gap-4"><div class="form-group"><label class="text-sm font-medium mb-1 block">Tasa de Cambio</label><input type="number" id="tasa" step="0.01" placeholder="0.00" onkeyup="calculateAll()" class="w-full"></div><div class="form-group"><label class="text-sm font-medium mb-1 block">Monto USDC</label><input type="number" id="montoUsdc" step="0.001" placeholder="0.00" onkeyup="calculateAll()" class="w-full"></div></div><div class="flex items-center justify-between"><span id="adCommissionLabel" class="text-sm">Aplicar 0.0% comisión</span><label class="switch"><input type="checkbox" id="applyAdCommissionSwitch" onchange="calculateAll()"><span class="slider"></span></label></div><div class="calc-display space-y-2 text-sm"><div id="displayAdCommissionRow" class="calc-row" style="display: none;"><span id="displayAdCommissionLabel">Comisión Anuncio:</span><span id="displayAdCommission"></span></div><div class="calc-row"><span>Monto BS:</span><span id="displayMontoBs">0.00</span></div><div class="calc-row"><span>Comisión VES:</span><span id="displayComision">0.00</span></div><div class="calc-row total text-base"><span>Total:</span><span id="displayTotal">0.00</span></div></div><input type="hidden" id="montoBs"><input type="hidden" id="comisionVes"><input type="hidden" id="total"><input type="hidden" id="ves"><input type="hidden" id="usdc"><input type="hidden" id="lote"></div></div><div class="modal-buttons"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-green" onclick="pasteSpecial()">📋 Pegado Especial</button><button class="btn btn-primary" onclick="saveOperation()">Guardar</button></div></div></div>
    <div id="configModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 class="modal-title text-xl font-bold">Configuración</h2><button class="close-btn" onclick="closeConfigModal()">&times;</button></div><div class="modal-body"><div class="form-group"><label class="text-sm font-medium mb-1 block">Comisión por Anuncio (%):</label><input type="number" id="adCommission" step="0.1" placeholder="Ej: 0.2" class="w-full"></div> <div class="form-group mt-4"><label class="text-sm font-medium mb-1 block">Meta de Ganancia Diaria (VES):</label><input type="number" id="dailyProfitGoal" step="0.01" placeholder="Ej: 1000.00" class="w-full"></div><div class="form-group mt-4"><label class="text-sm font-medium mb-1 block">Valor Inicial Wally (USD):</label><input type="number" id="wallyInitialValueConfig" step="0.01" placeholder="0.00" class="w-full"></div></div><div class="modal-buttons"><button class="btn btn-secondary" onclick="closeConfigModal()">Cancelar</button><button class="btn btn-primary" onclick="saveConfig()">Guardar</button></div></div></div>
    <div id="wallyModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 id="wallyModalTitle" class="modal-title text-xl font-bold">Operación Wally</h2><button class="close-btn" onclick="closeWallyModal()">&times;</button></div><div class="modal-body"><div id="wallyFormContent" class="space-y-4"></div></div><div class="modal-buttons"><button class="btn btn-secondary" onclick="closeWallyModal()">Cancelar</button><button class="btn btn-green" onclick="pasteSpecialWally()">📋 Pegado Especial</button><button class="btn btn-primary" onclick="saveWallyOperation()">Guardar</button></div></div></div>
    
    <div id="bankBreachModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 class="modal-title text-xl font-bold">Brecha por Banco</h2><button class="close-btn" onclick="closeBankBreachModal()">&times;</button></div><div class="modal-body"><div id="bankBreachCards" class="info-cards-grid"></div></div></div></div>
    <div id="lotDetailsModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 class="modal-title text-xl font-bold">Lotes Activos</h2><button class="close-btn" onclick="closeLotDetailsModal()">&times;</button></div><div class="modal-body"><div id="lotDetailsCards" class="info-cards-grid"></div></div></div></div>
    <div id="pendingDetailsModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 class="modal-title text-xl font-bold">Detalles de Pendientes</h2><button class="close-btn" onclick="closePendingDetailsModal()">&times;</button></div><div class="modal-body"><div class="grid grid-cols-2 gap-4 mb-4"><div class="card text-center"><p class="text-sm font-medium text-gray-400">Recompra</p><p id="pendingRepurchaseSummary" class="text-lg font-bold mt-1">0 USDC</p></div><div class="card text-center"><p class="text-sm font-medium text-gray-400">Reventa</p><p id="pendingResaleSummary" class="text-lg font-bold mt-1">0 USDC</p></div></div><h3 class="font-semibold mb-2">Operaciones de Recompra</h3><div id="pendingRepurchaseList" class="operation-list mb-4"></div><h3 class="font-semibold mb-2">Operaciones de Reventa</h3><div id="pendingResaleList" class="operation-list"></div></div></div></div>

    <div id="gainsSummaryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header flex justify-between items-center">
            <h2 class="modal-title text-xl font-bold">Resumen de Ganancias</h2>
            <button class="close-btn" onclick="closeGainsSummaryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                
                <div class="card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">HOY</p>
                    <div id="summaryGananciasHoyVes" class="text-2xl font-bold text-green-400">0.00 VES</div>
                    <div id="summaryGananciasHoyUsdc" class="text-base font-semibold text-gray-300 mt-1">0.00 USDC</div>
                </div>

                <div class="card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">ESTA SEMANA</p>
                    <div id="summaryGananciasSemanaVes" class="text-2xl font-bold text-green-400">0.00 VES</div>
                    <div id="summaryGananciasSemanaUsdc" class="text-base font-semibold text-gray-300 mt-1">0.00 USDC</div>
                </div>

                <div class="col-span-1 sm:col-span-2 card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">ESTE MES</p>
                    <div id="summaryGananciasMesVes" class="text-3xl font-bold text-green-400">0.00 VES</div>
                    <div id="summaryGananciasMesUsdc" class="text-lg font-semibold text-gray-300 mt-1">0.00 USDC</div>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="wallyGainsSummaryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header flex justify-between items-center">
            <h2 class="modal-title text-xl font-bold">Resumen de Ganancias Wally</h2>
            <button class="close-btn" onclick="closeWallyGainsSummaryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                
                <div class="card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">HOY</p>
                    <div id="summaryWallyGananciasHoyUsdc" class="text-2xl font-bold text-orange-400">0.00 USDC</div>
                    <div id="summaryWallyGananciasHoyUsd" class="text-base font-semibold text-purple-400 mt-1">0.00 USD</div>
                </div>

                <div class="card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">ESTA SEMANA</p>
                    <div id="summaryWallyGananciasSemanaUsdc" class="text-2xl font-bold text-orange-400">0.00 USDC</div>
                    <div id="summaryWallyGananciasSemanaUsd" class="text-base font-semibold text-purple-400 mt-1">0.00 USD</div>
                </div>

                <div class="col-span-1 sm:col-span-2 card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">ESTE MES</p>
                    <div id="summaryWallyGananciasMesUsdc" class="text-3xl font-bold text-orange-400">0.00 USDC</div>
                    <div id="summaryWallyGananciasMesUsd" class="text-lg font-semibold text-purple-400 mt-1">0.00 USD</div>
                </div>

            </div>
        </div>
    </div>
</div>

    <div id="aiOperationsCenter">
        <button id="aiToggleBtn" onclick="window.aiCenter.toggle()">
            🤖
            <div id="aiNotificationBadge">0</div>
        </button>
        <div id="aiPanel">
            <div id="aiHeader">
                <span>🧠</span>
                <h3>Centro de Operaciones IA</h3>
            </div>
            <div id="aiStatus">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Sistema Activo - Monitoreando</span>
            </div>
            <div id="aiMetrics">
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">Brecha Actual</div>
                        <div class="metric-value" id="currentGap">0%</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Ganancia Hoy</div>
                        <div class="metric-value positive" id="dailyProfitAI">0 VES / 0 USDC</div>
                    </div>
                </div>
            </div>
            <div id="aiNotifications"></div>
            <div id="aiControls">
                <button class="ai-control-btn clear" onclick="window.aiCenter.clearNotifications()">
                    🗑️ Limpiar
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script type="module">
        const firebaseConfig = { apiKey: "AIzaSyAovfm0PWP5f6rvSmDva5ZQLOAcOdDNCgk", authDomain: "dashboard-operaciones-a9996.firebaseapp.com", projectId: "dashboard-operaciones-a9996", storageBucket: "dashboard-operaciones-a9996.appspot.com", messagingSenderId: "788099450381", appId: "1:788099450381:web:95cd9fa3e96ec9397a3744" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUserId = null;
        let operations = [], wallyOperations = [];
        let userConfig = {};
        let editingIndex = -1, editingWallyIndex = -1;
        // Función para obtener la fecha actual en formato YYYY-MM-DD para la zona horaria local
        const getLocalDate = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Los meses son base 0
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        let currentDate = getLocalDate();
        let currentWallyDate = getLocalDate();
        let currentLotsData = new Map();
        let currentPendingData = { recompra: 0, reventa: 0, recompraOps: [], reventaOps: [] };
        let wallyTotalGains = { usdc: 0, usd: 0 };
        const defaultProfitGoals = { daily: 1000.00 };
        const defaultAIThresholds = { brechaMin: 2.0, brechaMax: 4.0, muchoLotes: 3, recompraCritica: 100.00, reventaCritica: 100.00 };

        const authSection = document.getElementById('authSection');
        const appContainer = document.querySelector('.app-container');
        const userEmailEl = document.getElementById('userEmail');
        const authError = document.getElementById('authError');

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.getElementById(`nav-${pageName}`).classList.add('active');
            const mainFab = document.getElementById('main-fab');
            mainFab.style.display = (pageName === 'operate' || pageName === 'reports') ? 'flex' : 'none';
            const wallyPage = document.getElementById('page-wally');
            const wallyFab = wallyPage.querySelector('.btn-fab');
            wallyFab.style.display = pageName === 'wally' ? 'flex' : 'none';
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                authSection.style.display = 'none'; appContainer.style.display = 'flex';
                userEmailEl.textContent = user.email;
                loadConfig(); loadOperations(); loadWallyOperations();
                document.getElementById('selectedDate').value = currentDate;
                document.getElementById('wallySelectedDate').value = currentWallyDate;
                showPage('operate');
            } else {
                currentUserId = null;
                authSection.style.display = 'flex'; appContainer.style.display = 'none';
            }
        });

        function registerUser() { const e = document.getElementById('registerEmail').value, p = document.getElementById('registerPassword').value; authError.textContent = ''; auth.createUserWithEmailAndPassword(e, p).catch(err => { authError.textContent = 'Error: ' + err.message; }); }
        function loginUser() { const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPassword').value; authError.textContent = ''; auth.signInWithEmailAndPassword(e, p).catch(err => { authError.textContent = 'Error: ' + err.message; }); }
        function logoutUser() { auth.signOut(); }
        function toggleAuthForms() { const l = document.getElementById('loginForm'), r = document.getElementById('registerForm'); authError.textContent = ''; l.style.display = l.style.display === 'none' ? 'block' : 'none'; r.style.display = r.style.display === 'none' ? 'block' : 'none'; }

        function loadOperations() { if (!currentUserId) return; db.collection('users').doc(currentUserId).collection('operations').orderBy('timestamp', 'desc').onSnapshot(s => { operations = s.docs.map(d => ({ id: d.id, ...d.data() })); updateSummary(); }, e => console.error(e)); }
        function loadWallyOperations() { if (!currentUserId) return; db.collection('users').doc(currentUserId).collection('wallyOperations').orderBy('timestamp', 'desc').onSnapshot(s => { wallyOperations = s.docs.map(d => ({ id: d.id, ...d.data() })); updateWallySummary(); }, e => console.error(e));}
        
        function saveOperation() {
            if (!currentUserId) return;
            const originalUsdc = parseFloat(document.getElementById('montoUsdc').value) || 0;
            const operacion = document.getElementById('operacion').value;
            const applyCommission = document.getElementById('applyAdCommissionSwitch').checked;
            const commissionRate = userConfig.adCommission || 0;
            let finalUsdc = originalUsdc, appliedCommission = 0;
            if (applyCommission && commissionRate > 0 && originalUsdc > 0) {
                const commissionAmount = originalUsdc * (commissionRate / 100);
                if (operacion === 'Compra') finalUsdc = originalUsdc - commissionAmount; 
                else if (operacion === 'Venta') finalUsdc = originalUsdc + commissionAmount;
                appliedCommission = commissionRate;
            }
            const operation = { usuario: document.getElementById('usuario').value, referencia: document.getElementById('referencia').value, operacion, tasa: parseFloat(document.getElementById('tasa').value) || 0, metodoPago: document.getElementById('metodoPago').value, montoUsdc: finalUsdc, montoBs: parseFloat(document.getElementById('montoBs').value) || 0, comisionVes: parseFloat(document.getElementById('comisionVes').value) || 0, total: parseFloat(document.getElementById('total').value) || 0, ves: 0, usdc: 0, lote: '', estatus: document.getElementById('estatus').value, fecha: currentDate, timestamp: Date.now(), adCommissionPercent: appliedCommission };
            if (!operation.usuario || !operation.tasa || !originalUsdc) { showToast('Por favor, complete todos los campos obligatorios.', 'error'); return; }
            const isEditing = editingIndex > -1;
            const opId = isEditing ? operations[editingIndex].id : db.collection('users').doc(currentUserId).collection('operations').doc().id;
            operation.id = opId;
            db.collection('users').doc(currentUserId).collection('operations').doc(opId).set(operation, { merge: true }).then(() => { 
                closeModal(); 
                showToast('Operación guardada.', 'success'); 
                if (window.aiCenter) {
                    if (isEditing) window.aiCenter.onOperationEdited(operation);
                    else window.aiCenter.onOperationAdded(operation);
                }
            }).catch(e => showToast('Error al guardar.', 'error'));
        }

        // ===== INICIO: NUEVAS FUNCIONES DE CÁLCULO GLOBALES =====
        function calculateTotalGainsForPeriod(periodOps) {
            const opsCopy = JSON.parse(JSON.stringify(periodOps));
            const uniqueDates = [...new Set(opsCopy.map(op => op.fecha))];
            let totalGainVes = 0, totalGainUsdc = 0;
            for (const fecha of uniqueDates) {
                const dailyOps = opsCopy.filter(op => op.fecha === fecha).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                dailyOps.forEach(op => { if (op.operacion === 'Compra') op._unmatchedAmount = op.montoUsdc; });
                const purchases = dailyOps.filter(op => op.operacion === 'Compra');
                const sales = dailyOps.filter(op => op.operacion === 'Venta');
                sales.forEach(sale => {
                    let remainingSaleAmount = sale.montoUsdc;
                    for (const purchase of purchases) {
                        if (purchase._unmatchedAmount > 1e-5 && remainingSaleAmount > 1e-5) {
                            const amountToMatch = Math.min(remainingSaleAmount, purchase._unmatchedAmount);
                            const cost = amountToMatch * purchase.tasa;
                            const revenue = amountToMatch * sale.tasa;
                            totalGainVes += (revenue - cost);
                            totalGainUsdc += (revenue - cost) / (sale.tasa || 1);
                            remainingSaleAmount -= amountToMatch;
                            purchase._unmatchedAmount -= amountToMatch;
                        }
                        if (remainingSaleAmount < 1e-5) break;
                    }
                });
            }
            return [totalGainVes, totalGainUsdc];
        }

        function calculateWallyGainsForPeriod(periodOps) {
            const compras = periodOps.filter(op => op.operacion === 'Compra');
            const ventas = periodOps.filter(op => op.operacion === 'Venta');
            const totalGananciaUsdc = compras.reduce((s, op) => s + (op.gananciaUsdc || 0), 0);
            const totalGananciaUsd = ventas.reduce((s, op) => s + (op.gananciaUsd || 0), 0);
            return [totalGananciaUsdc, totalGananciaUsd];
        };
        // ===== FIN: NUEVAS FUNCIONES DE CÁLCULO GLOBALES =====

        function deleteOperation(index) {
            if (!currentUserId || !confirm('¿Está seguro de que desea eliminar esta operación?')) return;
            const operationId = operations[index].id;
            db.collection('users').doc(currentUserId).collection('operations').doc(operationId).delete()
                .then(() => showToast('Operación eliminada.', 'info'))
                .catch(error => showToast('Error al eliminar la operación.', 'error'));
        }
        
        function calculateAll() {
            const tasa = parseFloat(document.getElementById('tasa').value) || 0, montoUsdcOriginal = parseFloat(document.getElementById('montoUsdc').value) || 0, operacion = document.getElementById('operacion').value, metodoPago = document.getElementById('metodoPago').value, applyCommission = document.getElementById('applyAdCommissionSwitch').checked, commissionRate = userConfig.adCommission || 0;
            let montoUsdcFinal = montoUsdcOriginal, commissionAmountUsdc = 0;
            const adCommissionRow = document.getElementById('displayAdCommissionRow');
            if (applyCommission && commissionRate > 0 && montoUsdcOriginal > 0) {
                commissionAmountUsdc = montoUsdcOriginal * (commissionRate / 100);
                if (operacion === 'Compra') { montoUsdcFinal = montoUsdcOriginal - commissionAmountUsdc; document.getElementById('displayAdCommissionLabel').textContent = `Comisión (débito):`; document.getElementById('displayAdCommission').textContent = `-${commissionAmountUsdc.toFixed(3)} (${montoUsdcFinal.toFixed(3)})`; } 
                else if (operacion === 'Venta') { montoUsdcFinal = montoUsdcOriginal + commissionAmountUsdc; document.getElementById('displayAdCommissionLabel').textContent = `Comisión (costo):`; document.getElementById('displayAdCommission').textContent = `+${commissionAmountUsdc.toFixed(3)} (${montoUsdcFinal.toFixed(3)})`; }
                adCommissionRow.style.display = 'flex';
            } else { adCommissionRow.style.display = 'none'; }
            const montoBs = tasa * montoUsdcOriginal; let comisionVes = 0;
            if (operacion === 'Compra' && metodoPago === 'Pagomovil') { comisionVes = montoBs * 0.003; }
            const total = montoBs + comisionVes;
            ['displayMontoBs', 'montoBs'].forEach(id => document.getElementById(id).textContent = document.getElementById(id).value = montoBs.toFixed(2));
            ['displayComision', 'comisionVes'].forEach(id => document.getElementById(id).textContent = document.getElementById(id).value = comisionVes.toFixed(2));
            ['displayTotal', 'total'].forEach(id => document.getElementById(id).textContent = document.getElementById(id).value = total.toFixed(2));
        }
        
       function applyFIFOForDate(fecha) {
            const dailyOps = operations.filter(op => op.fecha === fecha).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            dailyOps.forEach(op => {
                op.ves = 0;
                op.usdc = 0;
                op.lote = '';
                if (op.operacion === 'Compra') {
                    op._unmatchedAmount = op.montoUsdc;
                }
            });
            const purchases = dailyOps.filter(op => op.operacion === 'Compra');
            const sales = dailyOps.filter(op => op.operacion === 'Venta');
            currentLotsData.clear();
            let lotCounter = 1;
            sales.forEach(sale => {
                const lotId = `L${lotCounter++}`;
                let remainingSaleAmount = sale.montoUsdc;
                sale.lote = lotId;
                const lot = { id: lotId, ventaOp: sale, montoTotal: sale.montoUsdc, montoConsumido: 0, comprasAsociadas: [], estado: 'activo' };
                for (const purchase of purchases) {
                    if (purchase._unmatchedAmount > 1e-5 && remainingSaleAmount > 1e-5) {
                        const amountToMatch = Math.min(remainingSaleAmount, purchase._unmatchedAmount);
                        const cost = amountToMatch * purchase.tasa;
                        const revenue = amountToMatch * sale.tasa;
                        const gainVes = revenue - cost;
                        const gainUsdc = gainVes / (sale.tasa || 1);
                        purchase.ves += gainVes;
                        purchase.usdc += gainUsdc;
                        const existingLote = purchase.lote ? purchase.lote + ', ' : '';
                        purchase.lote = `${existingLote}${lotId}(${amountToMatch.toFixed(2)})`;
                        remainingSaleAmount -= amountToMatch;
                        purchase._unmatchedAmount -= amountToMatch;
                        lot.montoConsumido += amountToMatch;
                        lot.comprasAsociadas.push({ op: purchase, monto: amountToMatch });
                    }
                    if (remainingSaleAmount < 1e-5) { break; }
                }
                if (lot.montoConsumido >= lot.montoTotal - 1e-5) {
                    lot.estado = 'cerrado';
                }
                currentLotsData.set(lotId, lot);
            });
            dailyOps.forEach(op => {
                delete op._unmatchedAmount;
            });
            let totalComprado = purchases.reduce((sum, op) => sum + op.montoUsdc, 0);
            let totalVendido = sales.reduce((sum, op) => sum + op.montoUsdc, 0);
            currentPendingData = { recompra: Math.max(0, totalVendido - totalComprado), reventa: Math.max(0, totalComprado - totalVendido), recompraOps: [], reventaOps: [] };
            if (window.aiCenter) window.aiCenter.onOperationsRecalculated();
        }
        
        function updateSummary() {
            if (!operations) return;
            applyFIFOForDate(currentDate); 
            const currentOps = operations.filter(op => op.fecha === currentDate);
            const compras = currentOps.filter(op => op.operacion === 'Compra'), ventas = currentOps.filter(op => op.operacion === 'Venta');
            const promCompra = compras.length ? compras.reduce((s, o) => s + o.tasa, 0) / compras.length : 0;
            const promVenta = ventas.length ? ventas.reduce((s, o) => s + o.tasa, 0) / ventas.length : 0;
            const brecha = promCompra > 0 ? ((promVenta - promCompra) / promCompra * 100) : 0;
            const [gananciasVes, gananciasUsdc] = calculateTotalGainsForPeriod(currentOps);
            document.getElementById('ganancias').innerHTML = `${gananciasVes.toFixed(2)} <span class="text-2xl font-semibold">VES</span>`;
            document.getElementById('ganancias_usdc').innerHTML = `${gananciasUsdc.toFixed(4)} <span class="font-medium">USDC</span>`;
            document.getElementById('promCompra').textContent = promCompra.toFixed(2);
            document.getElementById('promVenta').textContent = promVenta.toFixed(2);
            document.getElementById('brecha').textContent = brecha.toFixed(2) + '%';
            document.getElementById('totalOps').textContent = currentOps.length;
            const activeLotsCount = Array.from(currentLotsData.values()).filter(lot => lot.estado === 'activo').length;
            document.getElementById('activeLotsSummary').textContent = activeLotsCount;
            document.getElementById('pendingSummary').textContent = `${(currentPendingData.recompra + currentPendingData.reventa).toFixed(2)} USDC`;
            const dailyGoalValue = userConfig.profitGoals ? userConfig.profitGoals.daily : defaultProfitGoals.daily;
            document.getElementById('dailyGoal').textContent = `${gananciasVes.toFixed(2)} / ${dailyGoalValue.toFixed(2)} VES`;
            const progressBar = document.getElementById('dailyProgressBar');
            progressBar.style.width = `${Math.min(dailyGoalValue > 0 ? (gananciasVes / dailyGoalValue) * 100 : 0, 100)}%`;
            document.getElementById('wallyDashboardGainsUsdc').innerHTML = `${wallyTotalGains.usdc.toFixed(2)} <span class="text-2xl font-semibold">USDC</span>`;
            document.getElementById('wallyDashboardGainsUsd').innerHTML = `${wallyTotalGains.usd.toFixed(2)} <span class="font-medium">USD</span>`;
            renderOperations();
        }

        function renderOperations() {
            const tableBody = document.getElementById('operationsTable');
            const listContainer = document.getElementById('operationsList');
            const searchTerm = document.getElementById('searchOperations').value.toLowerCase();
            const filterOperacion = document.getElementById('filterOperacion').value;
            const filterMetodo = document.getElementById('filterMetodoPago').value;
            const filteredOps = operations.filter(op => (op.fecha === currentDate) && (op.usuario.toLowerCase().includes(searchTerm) || (op.referencia && op.referencia.toLowerCase().includes(searchTerm))) && (filterOperacion === '' || op.operacion === filterOperacion) && (filterMetodo === '' || op.metodoPago === filterMetodo));
            tableBody.innerHTML = '';
            listContainer.innerHTML = '';
            filteredOps.forEach((op, index) => {
                const globalIndex = operations.indexOf(op);
                const commissionIndicator = op.adCommissionPercent > 0 ? `<span class="text-xs ${op.operacion === 'Venta' ? 'text-green-400' : 'text-red-400'}">(${op.operacion === 'Venta' ? '+' : '-'}${op.adCommissionPercent}%)</span>` : '';
                const mobileCommissionIndicator = op.adCommissionPercent > 0 ? `<span class="commission">(${op.operacion === 'Venta' ? '+' : '-'}${op.adCommissionPercent}%)</span>` : '';
                const tableRowHtml = `<tr class="hover:bg-[var(--surface)]"><td class="text-left"><div class="font-semibold">${op.usuario}</div><div class="text-xs text-gray-400">${op.metodoPago}</div></td><td>${op.referencia || ''}</td><td>${op.operacion.substring(0,1)}</td><td>${(op.tasa || 0).toFixed(2)}</td><td><div class="flex flex-col items-center">${(op.montoUsdc || 0).toFixed(3)} ${commissionIndicator}</div></td><td>${(op.montoBs || 0).toFixed(2)}</td><td class="font-semibold ${op.ves >= 0 ? 'text-green-400':'text-red-400'}">${(op.ves || 0).toFixed(2)}</td><td class="font-semibold ${op.usdc >= 0 ? 'text-green-400':'text-red-400'}">${(op.usdc || 0).toFixed(4)}</td><td>${op.lote || ''}</td><td><span class="px-2 py-1 text-xs font-semibold rounded-full ${op.estatus === 'Completado' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${op.estatus}</span></td><td><button class="text-blue-400 p-1" onclick="editOperation(${globalIndex})">✏️</button><button class="text-red-400 p-1" onclick="deleteOperation(${globalIndex})">🗑️</button></td></tr>`;
                const cardHtml = `<div class="operation-card ${op.operacion.toLowerCase()}"><div class="card-header"><div class="user-info">${op.usuario}<div class="payment-method">${op.metodoPago}</div></div><span class="status-badge ${op.estatus === 'Completado' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${op.estatus}</span></div><div class="card-grid"><div class="grid-item"><span class="label">Monto USDC</span><span class="value">${(op.montoUsdc || 0).toFixed(3)} ${mobileCommissionIndicator}</span></div><div class="grid-item"><span class="label">Monto BS</span><span class="value">${(op.montoBs || 0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Tasa</span><span class="value">${(op.tasa || 0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Ganancia VES</span><span class="value ${(op.ves || 0) >= 0 ? 'profit-green' : 'profit-red'}">${(op.ves || 0).toFixed(2)}</span></div></div><div class="card-footer"><div class="ref-info">REF: ${op.referencia || 'N/A'}<br>LOTE: ${op.lote || 'N/A'}</div><div class="actions"><button class="action-btn edit" onclick="editOperation(${globalIndex})"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg></button><button class="action-btn delete" onclick="deleteOperation(${globalIndex})"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.033-2.134H8.033c-1.12 0-2.033.954-2.033 2.134v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></button></div></div></div>`;
                tableBody.innerHTML += tableRowHtml;
                listContainer.innerHTML += cardHtml;
            });
        }

        function editOperation(index) {
            editingIndex = index; const op = operations[index];
            document.getElementById('modalTitle').textContent = 'Editar Operación';
            let originalMontoUsdc = op.montoUsdc;
            if (op.adCommissionPercent > 0) {
                if (op.operacion === 'Compra') { originalMontoUsdc = op.montoUsdc / (1 - op.adCommissionPercent / 100); } 
                else { originalMontoUsdc = op.montoUsdc / (1 + op.adCommissionPercent / 100); }
                document.getElementById('applyAdCommissionSwitch').checked = true;
            } else { document.getElementById('applyAdCommissionSwitch').checked = false; }
            document.getElementById('usuario').value = op.usuario; document.getElementById('referencia').value = op.referencia;
            document.getElementById('operacion').value = op.operacion; document.getElementById('tasa').value = op.tasa;
            document.getElementById('metodoPago').value = op.metodoPago; document.getElementById('montoUsdc').value = originalMontoUsdc.toFixed(3);
            document.getElementById('estatus').value = op.estatus; calculateAll(); openModal();
        }
        
        function openModal() { document.getElementById('operationModal').classList.add('show'); if(editingIndex === -1) clearForm();}
        function closeModal() { document.getElementById('operationModal').classList.remove('show'); editingIndex = -1; }
        function clearForm() { 
            const form = document.getElementById('operationModal'); 
            form.querySelectorAll('input, select').forEach(i => { 
                if(i.type !== 'checkbox') i.value = ''; 
                else i.checked = false; 
            }); 
            document.getElementById('operacion').value = "Compra"; 
            document.getElementById('estatus').value = "En Curso";
            calculateAll(); 
        }

        function loadConfig() { if (!currentUserId) return; db.collection('users').doc(currentUserId).collection('settings').doc('userConfig').get().then(doc => { const defaultConfig = { adCommission: 0.2, profitGoals: defaultProfitGoals, wallyInitialValue: 0, aiThresholds: defaultAIThresholds }; userConfig = doc.exists ? { ...defaultConfig, ...doc.data() } : defaultConfig; userConfig.profitGoals = userConfig.profitGoals || defaultConfig.profitGoals; userConfig.aiThresholds = userConfig.aiThresholds || defaultConfig.aiThresholds; applyConfig(); });}
        function applyConfig() { document.getElementById('adCommissionLabel').textContent = `Aplicar ${userConfig.adCommission}% comisión`; populatePaymentMethods(); updateSummary(); updateWallySummary(); if(window.aiCenter) window.aiCenter.alertThresholds = userConfig.aiThresholds; }
        function openConfigModal() { document.getElementById('configModal').classList.add('show'); document.getElementById('adCommission').value = userConfig.adCommission; document.getElementById('dailyProfitGoal').value = userConfig.profitGoals.daily; document.getElementById('wallyInitialValueConfig').value = userConfig.wallyInitialValue || 0; }
        function closeConfigModal() { document.getElementById('configModal').classList.remove('show'); }
        function saveConfig() { userConfig.adCommission = parseFloat(document.getElementById('adCommission').value) || 0; userConfig.profitGoals.daily = parseFloat(document.getElementById('dailyProfitGoal').value) || defaultProfitGoals.daily; userConfig.wallyInitialValue = parseFloat(document.getElementById('wallyInitialValueConfig').value) || 0; db.collection('users').doc(currentUserId).collection('settings').doc('userConfig').set(userConfig).then(() => { applyConfig(); closeConfigModal(); showToast('Configuración guardada.', 'success'); });}

        function populatePaymentMethods() { const methods = ["Pagomovil", "Banesco", "Venezuela", "Bancamiga", "BNC"]; const mainSelect = document.getElementById('metodoPago'); const filterSelect = document.getElementById('filterMetodoPago'); mainSelect.innerHTML = methods.map(m => `<option value="${m}">${m}</option>`).join(''); filterSelect.innerHTML = '<option value="">Todos los Métodos</option>' + methods.map(m => `<option value="${m}">${m}</option>`).join(''); }

        document.getElementById('selectedDate').addEventListener('change', function() { currentDate = this.value; updateSummary(); });
        document.getElementById('wallySelectedDate').addEventListener('change', function() { currentWallyDate = this.value; updateWallySummary(); });
        
        function showToast(message, type = 'info') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove(), {once: true}); }, 3000); }
        
        function openBankBreachModal() { renderBankBreachesCards(); document.getElementById('bankBreachModal').classList.add('show'); }
        function closeBankBreachModal() { document.getElementById('bankBreachModal').classList.remove('show'); }
        function openLotDetailsModal() { renderLotDetailsCards(); document.getElementById('lotDetailsModal').classList.add('show'); }
        function closeLotDetailsModal() { document.getElementById('lotDetailsModal').classList.remove('show'); }
        function openPendingDetailsModal() { renderPendingDetails(); document.getElementById('pendingDetailsModal').classList.add('show'); }
        function closePendingDetailsModal() { document.getElementById('pendingDetailsModal').classList.remove('show'); }
        
        function openGainsSummaryModal() {
            const formatDate = (dateObj) => {
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const todayStr = formatDate(today), startOfWeekStr = formatDate(startOfWeek), startOfMonthStr = formatDate(startOfMonth);
            
            const dailyOps = operations.filter(op => op.fecha === todayStr);
            const weeklyOps = operations.filter(op => op.fecha >= startOfWeekStr && op.fecha <= todayStr);
            const monthlyOps = operations.filter(op => op.fecha >= startOfMonthStr && op.fecha <= todayStr);
            
            const [dailyGainsVes, dailyGainsUsdc] = calculateTotalGainsForPeriod(dailyOps);
            const [weeklyGainsVes, weeklyGainsUsdc] = calculateTotalGainsForPeriod(weeklyOps);
            const [monthlyGainsVes, monthlyGainsUsdc] = calculateTotalGainsForPeriod(monthlyOps);
            
            document.getElementById('summaryGananciasHoyVes').textContent = `${dailyGainsVes.toFixed(2)} VES`;
            document.getElementById('summaryGananciasHoyUsdc').textContent = `${dailyGainsUsdc.toFixed(4)} USDC`;
            document.getElementById('summaryGananciasSemanaVes').textContent = `${weeklyGainsVes.toFixed(2)} VES`;
            document.getElementById('summaryGananciasSemanaUsdc').textContent = `${weeklyGainsUsdc.toFixed(4)} USDC`;
            document.getElementById('summaryGananciasMesVes').textContent = `${monthlyGainsVes.toFixed(2)} VES`;
            document.getElementById('summaryGananciasMesUsdc').textContent = `${monthlyGainsUsdc.toFixed(4)} USDC`;
            document.getElementById('gainsSummaryModal').classList.add('show');
        }
        function closeGainsSummaryModal() { document.getElementById('gainsSummaryModal').classList.remove('show'); }

        function openWallyGainsSummaryModal() {
            const formatDate = (dateObj) => {
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const todayStr = formatDate(today), startOfWeekStr = formatDate(startOfWeek), startOfMonthStr = formatDate(startOfMonth);

            const dailyOps = wallyOperations.filter(op => op.fecha === todayStr);
            const weeklyOps = wallyOperations.filter(op => op.fecha >= startOfWeekStr && op.fecha <= todayStr);
            const monthlyOps = wallyOperations.filter(op => op.fecha >= startOfMonthStr && op.fecha <= todayStr);

            const [dailyGainsUsdc, dailyGainsUsd] = calculateWallyGainsForPeriod(dailyOps);
            const [weeklyGainsUsdc, weeklyGainsUsd] = calculateWallyGainsForPeriod(weeklyOps);
            const [monthlyGainsUsdc, monthlyGainsUsd] = calculateWallyGainsForPeriod(monthlyOps);

            document.getElementById('summaryWallyGananciasHoyUsdc').textContent = `${dailyGainsUsdc.toFixed(2)} USDC`;
            document.getElementById('summaryWallyGananciasHoyUsd').textContent = `${dailyGainsUsd.toFixed(2)} USD`;
            document.getElementById('summaryWallyGananciasSemanaUsdc').textContent = `${weeklyGainsUsdc.toFixed(2)} USDC`;
            document.getElementById('summaryWallyGananciasSemanaUsd').textContent = `${weeklyGainsUsd.toFixed(2)} USD`;
            document.getElementById('summaryWallyGananciasMesUsdc').textContent = `${monthlyGainsUsdc.toFixed(2)} USDC`;
            document.getElementById('summaryWallyGananciasMesUsd').textContent = `${monthlyGainsUsd.toFixed(2)} USD`;
            document.getElementById('wallyGainsSummaryModal').classList.add('show');
        }
        function closeWallyGainsSummaryModal() { document.getElementById('wallyGainsSummaryModal').classList.remove('show'); }

        function calculateBankBreaches() {
            const currentOps = operations.filter(op => op.fecha === currentDate), bankData = {};
            currentOps.forEach(op => { if (!bankData[op.metodoPago]) bankData[op.metodoPago] = { compras: [], ventas: [] }; if (op.operacion === 'Compra') bankData[op.metodoPago].compras.push(op.tasa); else if (op.operacion === 'Venta') bankData[op.metodoPago].ventas.push(op.tasa); });
            const results = [];
            for (const method in bankData) { const { compras, ventas } = bankData[method]; const promCompra = compras.length > 0 ? compras.reduce((a, b) => a + b, 0) / compras.length : 0; const promVenta = ventas.length > 0 ? ventas.reduce((a, b) => a + b, 0) / ventas.length : 0; const brecha = promVenta > 0 && promCompra > 0 ? ((promVenta - promCompra) / promCompra * 100) : 0; results.push({ metodo: method, promCompra, promVenta, brecha }); }
            return results;
        }

        function renderBankBreachesCards() {
            const container = document.getElementById('bankBreachCards'), bankBreaches = calculateBankBreaches();
            if (bankBreaches.length === 0) { container.innerHTML = '<p class="text-center text-gray-400">No hay datos.</p>'; return; }
            container.innerHTML = bankBreaches.map(d => `<div class="info-card"><div class="info-card-title">${d.metodo}</div><div class="info-card-value" style="color: ${d.brecha > 0 ? 'var(--success)' : 'var(--danger)'}">${d.brecha.toFixed(2)}%</div><div class="info-card-details">C:${d.promCompra.toFixed(2)}|V:${d.promVenta.toFixed(2)}</div></div>`).join('');
        }
        function renderLotDetailsCards() {
            const container = document.getElementById('lotDetailsCards');
            const activeLots = Array.from(currentLotsData.values()).filter(l => l.estado === 'activo');
            if(activeLots.length === 0) { container.innerHTML = '<p class="text-center text-gray-400">No hay lotes activos.</p>'; return; }
            container.innerHTML = activeLots.map(lot => { const percentConsumed = lot.montoTotal > 0 ? (lot.montoConsumido / lot.montoTotal) * 100 : 0; const restante = lot.montoTotal - lot.montoConsumido; return `<div class="info-card p-4 flex flex-col justify-between"><div><div class="info-card-title text-base">Lote ${lot.id}</div><div class="info-card-value text-2xl" style="color: var(--primary); margin-bottom: 0.75rem;">${percentConsumed.toFixed(1)}% <span class="text-lg font-normal">Consumido</span></div><div class="info-card-details space-y-1 text-left"><div class="flex justify-between"><span>Total:</span> <strong class="font-mono">${lot.montoTotal.toFixed(2)} USDC</strong></div><div class="flex justify-between"><span>Consumido:</span> <strong class="font-mono text-green-400">${lot.montoConsumido.toFixed(2)} USDC</strong></div><div class="flex justify-between"><span>Restante:</span> <strong class="font-mono text-yellow-400">${restante.toFixed(2)} USDC</strong></div></div></div><div class="w-full bg-gray-700 rounded-full h-2.5 mt-4"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${percentConsumed}%"></div></div></div>`; }).join('');
        }
        function renderPendingDetails() {
            document.getElementById('pendingRepurchaseSummary').textContent = `${currentPendingData.recompra.toFixed(2)} USDC`;
            document.getElementById('pendingResaleSummary').textContent = `${currentPendingData.reventa.toFixed(2)} USDC`;
            const repurchaseList = document.getElementById('pendingRepurchaseList');
            repurchaseList.innerHTML = currentPendingData.recompra === 0 ? '<p class="text-xs text-gray-400">No hay recompra pendiente.</p>' : `<div class="operation-list-item">Monto Total: <span class="font-semibold">${currentPendingData.recompra.toFixed(2)} USDC</span></div>`;
            const resaleList = document.getElementById('pendingResaleList');
            resaleList.innerHTML = currentPendingData.reventa === 0 ? '<p class="text-xs text-gray-400">No hay reventa pendiente.</p>' : `<div class="operation-list-item">Monto Total: <span class="font-semibold">${currentPendingData.reventa.toFixed(2)} USDC</span></div>`;
        }
        
        function openWallyModal(index = -1) { editingWallyIndex = index; document.getElementById('wallyModalTitle').textContent = index > -1 ? 'Editar Operación Wally' : 'Agregar Operación Wally'; renderWallyForm(index > -1 ? wallyOperations.find((op, i) => i === index) : {}); document.getElementById('wallyModal').classList.add('show'); }
        function closeWallyModal() { document.getElementById('wallyModal').classList.remove('show'); }
        function renderWallyForm(op = {}) {
            document.getElementById('wallyFormContent').innerHTML = `<div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Usuario</label><input type="text" id="wallyUsuario" value="${op.usuario || ''}" class="w-3/5"></div><div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Referencia</label><input type="text" id="wallyReferencia" value="${op.referencia || ''}" class="w-3/5"></div><div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Operación</label><select id="wallyOperacion" onchange="updateWallyFormFields()" class="w-3/5"><option value="Compra" ${op.operacion === 'Compra' ? 'selected' : ''}>Compra (Recibo USDC)</option><option value="Venta" ${op.operacion === 'Venta' ? 'selected' : ''}>Venta (Recibo USD)</option></select></div><hr class="border-gray-700 my-2"><div id="wallyCompraFields" class="space-y-4"><div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Recibo USDC</label><input type="number" id="reciboUsdc" value="${op.reciboUsdc || ''}" onkeyup="calculateWallyCompra()" class="w-3/5"></div><div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Tasa Compra</label><input type="number" id="tasaCompra" value="${op.tasaCompra || ''}" onkeyup="calculateWallyCompra()" class="w-3/5"></div><div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Envío USD (calc)</label><input type="number" id="envioUsd" value="${op.envioUsd || ''}" readonly class="w-3/5 bg-gray-800 border-gray-600"></div><div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Ganancia USDC (calc)</label><input type="number" id="gananciaUsdc" value="${op.gananciaUsdc || ''}" readonly class="w-3/5 bg-gray-800 border-gray-600"></div></div><div id="wallyVentaFields" class="space-y-4"><div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Envío USDC</label><input type="number" id="envioUsdcVenta" value="${op.envioUsdc || ''}" onkeyup="calculateWallyVenta()" class="w-3/5"></div><div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Tasa Venta</label><input type="number" id="tasaVenta" value="${op.tasaVenta || ''}" onkeyup="calculateWallyVenta()" class="w-3/5"></div><div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Recibo USD (calc)</label><input type="number" id="reciboUsdCalculado" value="${op.reciboUsd || ''}" readonly class="w-3/5 bg-gray-800 border-gray-600"></div><div class="form-group flex justify-between items-center"><label class="text-sm text-gray-400">Ganancia USD (calc)</label><input type="number" id="gananciaUsd" value="${op.gananciaUsd || ''}" readonly class="w-3/5 bg-gray-800 border-gray-600"></div></div>`;
            updateWallyFormFields();
        }
        function updateWallyFormFields() { const operacion = document.getElementById('wallyOperacion').value; document.getElementById('wallyCompraFields').style.display = operacion === 'Compra' ? 'block' : 'none'; document.getElementById('wallyVentaFields').style.display = operacion === 'Venta' ? 'block' : 'none'; }
        function calculateWallyCompra() { const r = parseFloat(document.getElementById('reciboUsdc').value) || 0, t = parseFloat(document.getElementById('tasaCompra').value) || 0; document.getElementById('envioUsd').value = (r*t).toFixed(2); document.getElementById('gananciaUsdc').value = (r - (r*t)).toFixed(4); }
        function calculateWallyVenta() { const e = parseFloat(document.getElementById('envioUsdcVenta').value) || 0, t = parseFloat(document.getElementById('tasaVenta').value) || 0; document.getElementById('reciboUsdCalculado').value = (e*t).toFixed(2); document.getElementById('gananciaUsd').value = ((e*t) - e).toFixed(4); }
        function saveWallyOperation() {
            if (!currentUserId) return;
            const operacion = document.getElementById('wallyOperacion').value;
            let opData = { usuario: document.getElementById('wallyUsuario').value, referencia: document.getElementById('wallyReferencia').value, operacion, fecha: currentWallyDate, timestamp: Date.now() };
            if (operacion === 'Compra') { Object.assign(opData, { reciboUsdc: parseFloat(document.getElementById('reciboUsdc').value), tasaCompra: parseFloat(document.getElementById('tasaCompra').value), envioUsd: parseFloat(document.getElementById('envioUsd').value), gananciaUsdc: parseFloat(document.getElementById('gananciaUsdc').value) }); }
            else { Object.assign(opData, { envioUsdc: parseFloat(document.getElementById('envioUsdcVenta').value), tasaVenta: parseFloat(document.getElementById('tasaVenta').value), reciboUsd: parseFloat(document.getElementById('reciboUsdCalculado').value), gananciaUsd: parseFloat(document.getElementById('gananciaUsd').value) }); }
            if (!opData.usuario) { showToast('Usuario es requerido.', 'error'); return; }
            const opId = editingWallyIndex > -1 ? wallyOperations[editingWallyIndex].id : db.collection('users').doc(currentUserId).collection('wallyOperations').doc().id;
            db.collection('users').doc(currentUserId).collection('wallyOperations').doc(opId).set(opData, { merge: true }).then(() => { closeWallyModal(); showToast('Op. Wally guardada.', 'success'); }).catch(e=>showToast('Error.', 'error'));
        }
        function updateWallySummary() {
            if(!wallyOperations) return;
            const currentOps = wallyOperations.filter(op => op.fecha === currentWallyDate);
            const [totalGananciaUsdc, totalGananciaUsd] = calculateWallyGainsForPeriod(currentOps);
            wallyTotalGains = { usdc: totalGananciaUsdc, usd: totalGananciaUsd };
            if (document.getElementById('page-operate').classList.contains('active')) { 
                updateSummary(); 
            }
            const valorInicial = parseFloat(userConfig.wallyInitialValue) || 0;
            const compras = currentOps.filter(op => op.operacion === 'Compra'), ventas = currentOps.filter(op => op.operacion === 'Venta');
            const valorActual = valorInicial + compras.reduce((s,o)=>s+o.reciboUsdc,0) - compras.reduce((s,o)=>s+o.envioUsd,0) + ventas.reduce((s,o)=>s+o.reciboUsd,0) - ventas.reduce((s,o)=>s+o.envioUsdc,0);
            document.getElementById("wallyValorInicialInput").value = valorInicial.toFixed(2);
            document.getElementById("wallyValorActual").textContent = valorActual.toFixed(2);
            document.getElementById("wallyGanancias").textContent = `${totalGananciaUsdc.toFixed(2)} USDC / ${totalGananciaUsd.toFixed(2)} USD`;
            renderWallyTables();
        }
        function renderWallyTables() {
            const currentOps = wallyOperations.filter(op => op.fecha === currentWallyDate);
            const compraTableBody = document.getElementById('wallyCompraTable'), compraListContainer = document.getElementById('wallyCompraList');
            const ventaTableBody = document.getElementById('wallyVentaTable'), ventaListContainer = document.getElementById('wallyVentaList');
            compraTableBody.innerHTML = ''; compraListContainer.innerHTML = ''; ventaTableBody.innerHTML = ''; ventaListContainer.innerHTML = '';
            currentOps.filter(op => op.operacion === 'Compra').forEach(op => {
                const globalIndex = wallyOperations.indexOf(op);
                const tableRowHtml = `<tr><td>${op.usuario}</td><td>${(op.reciboUsdc || 0).toFixed(2)}</td><td>${(op.tasaCompra || 0).toFixed(3)}</td><td>${(op.envioUsd || 0).toFixed(2)}</td><td class="font-semibold text-green-400">${(op.gananciaUsdc || 0).toFixed(4)}</td><td><button class="text-blue-400 p-1" onclick="openWallyModal(${globalIndex})">✏️</button></td></tr>`;
                const cardHtml = `<div class="operation-card compra"><div class="card-header"><div class="user-info">${op.usuario}</div><button class="action-btn edit" onclick="openWallyModal(${globalIndex})"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg></button></div><div class="card-grid"><div class="grid-item"><span class="label">Recibo USDC</span><span class="value">${(op.reciboUsdc || 0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Tasa</span><span class="value">${(op.tasaCompra || 0).toFixed(3)}</span></div><div class="grid-item"><span class="label">Envío USD</span><span class="value">${(op.envioUsd || 0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Gan. USDC</span><span class="value profit-green">${(op.gananciaUsdc || 0).toFixed(4)}</span></div></div></div>`;
                compraTableBody.innerHTML += tableRowHtml; compraListContainer.innerHTML += cardHtml;
            });
            currentOps.filter(op => op.operacion === 'Venta').forEach(op => {
                const globalIndex = wallyOperations.indexOf(op);
                const tableRowHtml = `<tr><td>${op.usuario}</td><td>${(op.envioUsdc || 0).toFixed(2)}</td><td>${(op.tasaVenta || 0).toFixed(3)}</td><td>${(op.reciboUsd || 0).toFixed(2)}</td><td class="font-semibold text-green-400">${(op.gananciaUsd || 0).toFixed(4)}</td><td><button class="text-blue-400 p-1" onclick="openWallyModal(${globalIndex})">✏️</button></td></tr>`;
                const cardHtml = `<div class="operation-card venta"><div class="card-header"><div class="user-info">${op.usuario}</div><button class="action-btn edit" onclick="openWallyModal(${globalIndex})"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg></button></div><div class="card-grid"><div class="grid-item"><span class="label">Envío USDC</span><span class="value">${(op.envioUsdc || 0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Tasa</span><span class="value">${(op.tasaVenta || 0).toFixed(3)}</span></div><div class="grid-item"><span class="label">Recibo USD</span><span class="value">${(op.reciboUsd || 0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Gan. USD</span><span class="value profit-green">${(op.gananciaUsd || 0).toFixed(4)}</span></div></div></div>`;
                ventaTableBody.innerHTML += tableRowHtml; ventaListContainer.innerHTML += cardHtml;
            });
        }
        function saveWallyValorInicial() { userConfig.wallyInitialValue = parseFloat(document.getElementById('wallyInitialValueConfig').value) || 0; saveConfig(); }
        
        async function pasteSpecial() {
            try {
                const text = await navigator.clipboard.readText();
                const refMatch = text.match(/-\s*([a-z0-9]{8})/i);
                const usuarioMatch = text.match(/Contraparte:\s*([A-Z0-9\.]+)/i);
                const tasaMatch = text.match(/Precio:\s*([\d\.]+)/i);
                const estatusMatch = text.match(/Transacción\s+completada/i);
                const montoRecibidoUsdcMatch = text.match(/Monto recibido:\s*([\d\.,]+)\s*USDC/i);
                const montoEnviadoUsdcMatch = text.match(/Monto enviado:\s*([\d\.,]+)\s*USDC/i);
                if (usuarioMatch) document.getElementById("usuario").value = usuarioMatch[1];
                if (refMatch) document.getElementById("referencia").value = refMatch[1];
                if (tasaMatch) document.getElementById("tasa").value = tasaMatch[1].replace(',', '.');
                if (montoRecibidoUsdcMatch) {
                    document.getElementById("operacion").value = "Compra";
                    document.getElementById("montoUsdc").value = montoRecibidoUsdcMatch[1].replace(',', '.');
                } else if (montoEnviadoUsdcMatch) {
                    document.getElementById("operacion").value = "Venta";
                    document.getElementById("montoUsdc").value = montoEnviadoUsdcMatch[1].replace(',', '.');
                } else { showToast("No se pudo determinar el tipo de operación (Compra/Venta) o el monto USDC.", "warning"); return; }
                if (estatusMatch) document.getElementById("estatus").value = "Completado";
                calculateAll();
                showToast("Pegado especial exitoso.", "success");
            } catch (err) { showToast("No se pudo leer el portapapeles o el formato es incorrecto.", "error"); console.error(err); }
        }

        async function pasteSpecialWally() {
            try {
                const text = await navigator.clipboard.readText();
                const refMatch = text.match(/-\s*([a-z0-9]{8})/i);
                const usuarioMatch = text.match(/Contraparte:\s*([A-Z0-9\.]+)/i);
                const montoEnviadoUsdMatch = text.match(/Monto enviado:\s*([\d\.]+)\s*USD/i);
                const montoRecibidoUsdcMatch = text.match(/Monto recibido:\s*([\d\.]+)\s*USDC/i);
                const montoEnviadoUsdcMatch = text.match(/Monto enviado:\s*([\d\.]+)\s*USDC/i);
                const montoRecibidoUsdMatch = text.match(/Monto recibido:\s*([\d\.]+)\s*USD/i);
                const tasaMatch = text.match(/Precio:\s*([\d\.]+)/i);
                if (usuarioMatch) document.getElementById("wallyUsuario").value = usuarioMatch[1];
                if (refMatch) document.getElementById("wallyReferencia").value = refMatch[1];
                let tasaValue = tasaMatch ? tasaMatch[1] : '';
                if (montoEnviadoUsdMatch && montoRecibidoUsdcMatch) { 
                    document.getElementById("wallyOperacion").value = "Compra";
                    updateWallyFormFields();
                    document.getElementById("reciboUsdc").value = montoRecibidoUsdcMatch[1];
                    document.getElementById("tasaCompra").value = tasaValue;
                    calculateWallyCompra();
                    showToast("Pegado especial exitoso (Wally Compra).", "success");
                } else if (montoEnviadoUsdcMatch && montoRecibidoUsdMatch) {
                    document.getElementById("wallyOperacion").value = "Venta";
                    updateWallyFormFields();
                    document.getElementById("envioUsdcVenta").value = montoEnviadoUsdcMatch[1];
                    document.getElementById("tasaVenta").value = tasaValue;
                    calculateWallyVenta();
                    showToast("Pegado especial exitoso (Wally Venta).", "success");
                } else {
                    showToast("Formato no reconocido para Wally.", "warning");
                }
            } catch (err) {
                showToast("No se pudo leer el portapapeles.", "error");
                console.error(err);
            }
        }
        
        class AIOperationsCenter {
            constructor(){ this.notifications=[]; this.alerts=[]; this.isOpen=false; this.processedOperations=new Set(); this.lastOperationCount=0; this.lastLotStates=new Map(); this.lastMetrics={brecha:0,ganancias:{ves:0,usdc:0},operationsCount:0}; this.alertThresholds=defaultAIThresholds; }
            toggle(){ this.isOpen?this.close():this.open(); }
            open(){ document.getElementById('aiPanel').classList.add('show'); this.isOpen=true; this.updateMetrics(); this.renderNotifications(); }
            close(){ document.getElementById('aiPanel').classList.remove('show'); this.isOpen=false; }
            analyzeCurrentState(){ const todayOps=operations.filter(op=>op.fecha===currentDate); if(todayOps.length > this.lastOperationCount){ const newOps=todayOps.slice(this.lastOperationCount); newOps.forEach(op=>this.processNewOperation(op)); } this.analyzeLotChanges(currentLotsData); this.analyzeBreach(todayOps); this.analyzePendingBalances(currentPendingData); this.lastOperationCount=todayOps.length; this.updateMetrics(); }
            processNewOperation(op){ const opKey=`${op.id}`; if(this.processedOperations.has(opKey))return; this.processedOperations.add(opKey); this.addNotification('success',`${op.operacion} Registrada`,`${op.usuario}: ${op.montoUsdc} USDC a ${op.tasa}`); }
            analyzeLotChanges(currentLots){ const prevLots=this.lastLotStates; prevLots.forEach((prev,id)=>{ const curr=currentLots.get(id); if(prev.estado==='activo' && (!curr||curr.estado==='cerrado')){ this.addNotification('success','Lote Completado',`Lote ${id} cerrado.`); } }); currentLots.forEach((curr,id)=>{ if(!prevLots.has(id)){ this.addNotification('info','Nuevo Lote Creado',`Lote ${id} iniciado.`); } }); const activeCount=Array.from(currentLots.values()).filter(l=>l.estado==='activo').length; if(activeCount >= this.alertThresholds.muchoLotes && Array.from(prevLots.values()).filter(l=>l.estado==='activo').length < this.alertThresholds.muchoLotes){ this.addNotification('warning','Muchos Lotes Activos',`Tienes ${activeCount} lotes abiertos.`); } this.lastLotStates=new Map(currentLots); }
            analyzeBreach(ops){ const compras=ops.filter(o=>o.operacion==='Compra'); const ventas=ops.filter(o=>o.operacion==='Venta'); if(compras.length===0||ventas.length===0)return; const pCompra=compras.reduce((s,o)=>s+o.tasa,0)/compras.length; const pVenta=ventas.reduce((s,o)=>s+o.tasa,0)/ventas.length; const brecha=((pVenta-pCompra)/pCompra*100); if(Math.abs(brecha-this.lastMetrics.brecha)>0.5){ if(brecha<this.alertThresholds.brechaMin)this.addAlert('warning','Brecha Baja Detectada',`La brecha bajó a ${brecha.toFixed(2)}%.`); else if(brecha>this.alertThresholds.brechaMax)this.addAlert('success','Oportunidad: Brecha Alta',`Excelente brecha de ${brecha.toFixed(2)}%.`); } this.lastMetrics.brecha=brecha; }
            analyzePendingBalances(pending){ if(pending.recompra>this.alertThresholds.recompraCritica)this.addAlert('danger','Recompra Crítica',`Necesitas recomprar ${pending.recompra.toFixed(2)} USDC.`); if(pending.reventa>this.alertThresholds.reventaCritica)this.addAlert('warning','Reventa Pendiente',`Tienes ${pending.reventa.toFixed(2)} USDC sin vender.`); }
            addNotification(type,title,content){ this.notifications.unshift({id:Date.now(),type,title,content,time:new Date()}); if(this.notifications.length>20)this.notifications.pop(); this.renderNotifications(); this.updateBadge(); }
            addAlert(type,title,content){ this.alerts.unshift({id:Date.now(),type,title,content,time:new Date()}); if(this.alerts.length>10)this.alerts.pop(); this.renderNotifications(); this.updateBadge(); }
            renderNotifications(){ const container=document.getElementById('aiNotifications'); const iconMap={info:'💡',success:'✅',warning:'⚠️',danger:'🚨'}; let html=''; if(this.alerts.length>0){ html+=`<div class="notification-section"><h4>${iconMap['danger']} Alertas Críticas</h4>${this.alerts.map(a=>`<div class="notification ${a.type}"><div class="notification-header"><div class="notification-title"><span>${iconMap[a.type]}</span> ${a.title}</div><div class="notification-time">${a.time.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div><div class="notification-content">${a.content}</div></div>`).join('')}</div>`; } if(this.notifications.length>0){ html+=`<div class="notification-section"><h4>${iconMap['info']} Notificaciones</h4>${this.notifications.map(n=>`<div class="notification ${n.type}"><div class="notification-header"><div class="notification-title"><span>${iconMap[n.type]}</span> ${n.title}</div><div class="notification-time">${n.time.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div></div><div class="notification-content">${n.content}</div></div>`).join('')}</div>`; } if(html==='')html='<div class="p-4 text-center text-sm text-gray-400">Sin notificaciones nuevas.</div>'; container.innerHTML=html; }
            updateBadge(){ const badge=document.getElementById('aiNotificationBadge'); const count=this.alerts.length+this.notifications.length; if(count>0&&!this.isOpen){ badge.style.display='flex'; badge.textContent=Math.min(count,99); }else{ badge.style.display='none'; } }
            updateMetrics(){ const todayOps=operations.filter(op=>op.fecha===currentDate); const compras=todayOps.filter(o=>o.operacion==='Compra'); const ventas=todayOps.filter(o=>o.operacion==='Venta'); let brecha=0; if(compras.length>0&&ventas.length>0){ const pCompra=compras.reduce((s,o)=>s+o.tasa,0)/compras.length; const pVenta=ventas.reduce((s,o)=>s+o.tasa,0)/ventas.length; brecha=((pVenta-pCompra)/pCompra*100); } document.getElementById('currentGap').textContent=`${brecha.toFixed(2)}%`; const[gVes,gUsdc]=todayOps.reduce((acc,op)=>{if(op.operacion==='Compra'){acc[0]+=op.ves||0;acc[1]+=op.usdc||0;}return acc;},[0,0]); document.getElementById('dailyProfitAI').innerHTML=`<div>${gVes.toFixed(2)} VES</div><div>${gUsdc.toFixed(2)} USDC</div>`; const gapEl=document.getElementById('currentGap'); gapEl.className='metric-value'; if(brecha<this.alertThresholds.brechaMin)gapEl.classList.add('negative'); else if(brecha>this.alertThresholds.brechaMax)gapEl.classList.add('positive'); else gapEl.classList.add('warning'); }
            onOperationAdded(op){ this.lastOperationCount=operations.length-2; this.analyzeCurrentState(); }
            onOperationEdited(op){ this.addNotification('info','Operación Modificada',`Se editó la operación de ${op.usuario}.`); this.analyzeCurrentState(); }
            onOperationsRecalculated(){ this.analyzeCurrentState(); }
            clearNotifications() { this.notifications = []; this.alerts = []; this.renderNotifications(); this.updateBadge(); }
        }

        window.aiCenter = new AIOperationsCenter();
        setInterval(() => { if (currentUserId && window.aiCenter) window.aiCenter.analyzeCurrentState(); }, 15000);

        window.showPage = showPage; window.loginUser = loginUser; window.registerUser = registerUser;
        window.toggleAuthForms = toggleAuthForms; window.logoutUser = logoutUser; window.openModal = openModal;
        window.closeModal = closeModal; window.saveOperation = saveOperation; window.editOperation = editOperation;
        window.deleteOperation = deleteOperation; window.calculateAll = calculateAll; window.openConfigModal = openConfigModal;
        window.closeConfigModal = closeConfigModal; window.saveConfig = saveConfig; 
        window.filterOperations = renderOperations;
        window.openBankBreachModal = openBankBreachModal; window.closeBankBreachModal = closeBankBreachModal;
        window.openLotDetailsModal = openLotDetailsModal; window.closeLotDetailsModal = closeLotDetailsModal;
        window.openPendingDetailsModal = openPendingDetailsModal; window.closePendingDetailsModal = closePendingDetailsModal;
        window.openWallyModal = openWallyModal; window.closeWallyModal = closeWallyModal;
        window.updateWallyFormFields = updateWallyFormFields; window.calculateWallyCompra = calculateWallyCompra;
        window.calculateWallyVenta = calculateWallyVenta; window.saveWallyOperation = saveWallyOperation;
        window.pasteSpecial = pasteSpecial; window.pasteSpecialWally = pasteSpecialWally;
        window.openGainsSummaryModal = openGainsSummaryModal;
        window.closeGainsSummaryModal = closeGainsSummaryModal;
        window.openWallyGainsSummaryModal = openWallyGainsSummaryModal;
        window.closeWallyGainsSummaryModal = closeWallyGainsSummaryModal;
        window.saveWallyValorInicial = saveWallyValorInicial;
    </script>
</body>
</html>
