<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard de Operaciones</title>
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --background: #0D1117;
            --surface: #161B22;
            --primary: #58A6FF;
            --secondary: #1F6FEB;
            --text-primary: #C9D1D9;
            --text-secondary: #8B949E;
            --border: #30363D;
            --success: #3FB950;
            --danger: #F85149;
            --warning: #D29922;
            --info: #4299e1;
        }
        html, body {
            overscroll-behavior-y: contain;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
        }
        /* Fix para ocultar el icono de calendario nativo */
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
        }
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem 1rem calc(6rem + env(safe-area-inset-bottom));
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(5rem + env(safe-area-inset-bottom));
            background-color: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 0.75rem;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            transition: color 0.2s;
            padding: 0 0.5rem;
            border: none;
            background: none;
            flex-basis: 0;
            flex-grow: 1;
        }
        .nav-item.active {
            color: var(--primary);
        }
        .nav-item svg {
            width: 24px;
            height: 24px;
        }
        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
        }
        .card {
            background-color: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 1.25rem;
        }
        .card.clickable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .card.clickable:hover {
            background-color: #222831;
        }
        .btn-fab {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 9999px;
            border: none;
            padding: 1rem;
            box-shadow: 0 10px 20px rgba(88, 166, 255, 0.2), 0 6px 6px rgba(88, 166, 255, 0.23);
            position: fixed;
            bottom: calc(6rem + env(safe-area-inset-bottom));
            right: 1.5rem;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            min-width: 900px;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        th {
            background-color: var(--surface);
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Modal Animations */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 2000;
            backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal .modal-content {
            transform: scale(0.95) translateY(10px);
            transition: transform 0.3s ease;
        }
        .modal.show {
            opacity: 1; visibility: visible; pointer-events: auto;
        }
        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-content { background: var(--surface); color: var(--text-primary); border-radius: 24px; border: 1px solid var(--border); width: calc(100% - 2rem); max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { background: transparent; padding: 1.5rem 1.5rem 1rem 1.5rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .modal-title { color: var(--text-primary); font-size: 1.25rem; }
        .close-btn { color: var(--text-secondary); background-color: rgba(255, 255, 255, 0.1); border: none; border-radius: 50%; width: 32px; height: 32px; }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .form-group label { color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { background-color: var(--background); border: 1px solid var(--border); color: var(--text-primary); border-radius: 12px; padding: 0.75rem 1rem; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2); outline: none; }
        .calc-display { background-color: var(--background); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; }
        .calc-row { display: flex; justify-content: space-between; }
        .calc-row.total { font-weight: bold; border-top: 1px solid var(--border); padding-top: 0.5rem; margin-top: 0.5rem; }
        .modal-buttons { background-color: transparent; border-top: 1px solid var(--border); padding: 1rem 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem; flex-shrink: 0; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; border: none; }
        .btn-primary { background: var(--primary); color: var(--background); }
        .btn-secondary { background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-green { background: var(--success); color: var(--background); }
        ::-webkit-scrollbar { width: 4px; height: 4px;}
        ::-webkit-scrollbar-track { background: var(--surface); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        #authSection { background-color: var(--background); }
        .auth-container { background-color: var(--surface); border-radius: 24px; border: 1px solid var(--border); }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #30363D; transition: .4s; border-radius: 24px;}
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;}
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background-color: var(--surface); border: 1px solid var(--border); color: var(--text-primary); padding: 0.75rem 1.25rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); display: flex; align-items: center; gap: 0.75rem; opacity: 0; transform: translateX(100%); transition: all 0.3s ease-out; font-weight: 500; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.hide { opacity: 0; transform: translateX(100%); }
        .info-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .info-card { background: var(--background); border-radius: 12px; border: 1px solid var(--border); padding: 1rem; text-align: center; }
        .info-card-title { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .info-card-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .info-card-details { font-size: 0.8rem; color: var(--text-secondary); }
        .operation-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .operation-list-item { background: var(--background); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; font-size: 0.8rem; }
        .op-label { color: var(--text-secondary); }
        .operations-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .operation-card { background-color: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; border-left-width: 4px; }
        .operation-card.compra { border-left-color: var(--success); }
        .operation-card.venta { border-left-color: var(--danger); }
        .card-header, .card-footer { display: flex; justify-content: space-between; align-items: center; }
        .card-header .user-info { font-weight: 600; }
        .card-header .user-info .payment-method { font-weight: 400; font-size: 0.8rem; color: var(--text-secondary); }
        .status-badge { font-size: 0.75rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 600; }
        .card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 0.75rem 0; }
        .grid-item { display: flex; flex-direction: column; text-align: center; }
        .grid-item .label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .grid-item .value { font-weight: 600; font-size: 0.9rem; }
        .grid-item .value .commission { font-size: 0.7rem; color: var(--danger); }
        .value.profit-green { color: var(--success); }
        .value.profit-red { color: var(--danger); }
        .card-footer .ref-info { font-size: 0.75rem; color: var(--text-secondary); font-family: monospace; }
        .card-footer .actions { display: flex; gap: 0.5rem; }
        .card-footer .action-btn { background: none; border: none; padding: 0.5rem; }
        .card-footer .action-btn.edit { color: var(--primary); }
        .card-footer .action-btn.delete { color: var(--danger); }
        #page-reports .operations-list-container,
        #page-wally .operations-list-container { display: block; }
        #page-reports .table-container,
        #page-wally .table-container { display: none; }
        @media (min-width: 1024px) {
            #page-reports .operations-list-container,
            #page-wally .operations-list-container { display: none; }
            #page-reports .table-container,
            #page-wally .table-container { display: block; }
        }
        .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--surface);
            border-radius: 16px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            flex-grow: 1;
            min-width: 180px;
        }
        .filter-item label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            padding-left: 0.25rem;
        }
        .filter-item input,
        .filter-item select {
            background-color: var(--background);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 0.6rem 1rem;
            font-size: 0.875rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
        }
        .filter-item input:focus,
        .filter-item select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
            outline: none;
        }
        .form-field-grid {
            background-color: var(--background);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
        }
        .form-field-grid:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
            outline: none;
        }
        .filter-item select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%238B949E'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9' /%3E%3C/svg%3E%0A");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        @media (min-width: 768px) {
            .filter-item.search-bar {
                flex-grow: 2;
                min-width: 300px;
            }
        }
        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            font-size: 2.5rem;
            cursor: pointer;
        }
        .rating-stars .star {
            color: var(--border);
            transition: color 0.2s, transform 0.2s;
        }
        .rating-stars .star:hover {
            transform: scale(1.1);
        }
        .rating-stars .star.selected {
            color: #D29922;
        }
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .empty-state {
            display: none; 
            text-align: center;
            padding: 3rem 1.5rem;
            background-color: var(--surface);
            border-radius: 16px;
            border: 1px dashed var(--border);
            margin-top: 1.5rem;
        }
        .empty-state svg {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem auto;
            color: var(--primary);
        }
        .empty-state p {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .empty-state span {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .btn {
            position: relative; 
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-spinner {
            display: none; 
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -10px; 
            margin-left: -10px; 
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .btn.loading {
            color: transparent !important; 
            pointer-events: none; 
        }
        .btn.loading .btn-spinner {
            display: block; 
        }
        .method-tag {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--background);
            border: 1px solid var(--border);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .delete-method-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            margin-left: 0.25rem;
            font-weight: bold;
        }
        .delete-method-btn:hover {
            color: var(--danger);
        }
        /* START: Platform Manager Styles */
        .platform-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background-color: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
        }
        .platform-item-info {
            flex-grow: 1;
        }
        .platform-item-name {
            font-weight: 600;
        }
        .platform-item-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .platform-item-actions button {
            background: none;
            border: none;
            padding: 0.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .platform-item-actions button:hover {
            color: var(--primary);
        }
        /* END: Platform Manager Styles */
        .goal-toggle-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .goal-toggle-btn.active {
            background-color: var(--primary);
            color: var(--background);
            border-color: var(--primary);
            font-weight: 600;
        }


        /* ESTILOS PARA LA ANIMACIÓN DE LOTE CERRADO */
        .lot-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
        }
        .lot-animation-container.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        .lot-animation-card {
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2rem;
            text-align: center;
            color: var(--text-primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.9);
            opacity: 0;
        }
        .lot-animation-container.show .lot-animation-card {
           animation: fadeInUp 0.4s 0.1s ease-out forwards;
        }
        .lot-animation-container.hide .lot-animation-card {
           animation: fadeOutDown 0.4s ease-in forwards;
        }

        @keyframes fadeInUp {
            from {
                transform: translate3d(0, 40px, 0) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translate3d(0, 0, 0) scale(1);
                opacity: 1;
            }
        }
        @keyframes fadeOutDown {
             from {
                transform: translate3d(0, 0, 0) scale(1);
                opacity: 1;
            }
            to {
                transform: translate3d(0, 50px, 0) scale(0.95);
                opacity: 0;
            }
        }


        /* ESTILOS PARA EL BANNER DE ACTUALIZACIÓN */
        .update-banner {
            display: none; /* Oculto por defecto */
            position: fixed;
            bottom: calc(5.5rem + env(safe-area-inset-bottom)); /* Justo arriba del menú de navegación */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary);
            color: var(--background);
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            z-index: 1002; /* Por encima del FAB, por debajo de los modales */
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            font-weight: 600;
            align-items: center;
            gap: 1rem;
        }
        .update-banner.show {
            display: flex;
            animation: slideUp 0.5s ease-out;
        }
        .update-button {
            background-color: rgba(0,0,0,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }
        @keyframes slideUp {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        .profile-tab {
    background: none;
    border: none;
    color: var(--text-secondary);
    padding: 0.75rem 0.25rem;
    font-weight: 600;
    font-size: 0.9rem;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease-in-out;
}
.profile-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}


.update-button .btn-text {
    transition: opacity 0.2s;
}
.update-button.loading .btn-text {
    opacity: 0;
}
.update-button .btn-spinner {
    border-color: rgba(255, 255, 255, 0.5);
    border-top-color: white;
}



    </style>

<link rel="manifest" href="manifest.json">
<script>
    // --- NUEVO SISTEMA DE REGISTRO Y ACTUALIZACIÓN DEL SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            let newWorker;
            
            navigator.serviceWorker.register('./sw.js').then(reg => {
                // 1. Escucha por una nueva versión del SW que se está instalando
                reg.addEventListener('updatefound', () => {
                    console.log('Nueva versión del Service Worker encontrada. Instalando...');
                    newWorker = reg.installing;
                    
                    // 2. Cuando el nuevo SW se instala, mostramos la notificación
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                           // Muestra el banner de actualización
                           const notification = document.getElementById('update-notification');
                           notification.classList.add('show');

                           // 3. AHORA que el banner es visible, le damos la funcionalidad al botón
                           const reloadButton = document.getElementById('update-reload-button');
                           reloadButton.addEventListener('click', () => {
                               // Añadimos feedback visual inmediato
                               reloadButton.classList.add('loading'); // Activa el spinner
                               const textSpan = reloadButton.querySelector('.btn-text');
                               if(textSpan) textSpan.textContent = 'Actualizando...'; // Cambia el texto

                               // Esto le dice al nuevo Service Worker que se active
                               newWorker.postMessage({ type: 'SKIP_WAITING' });
                           });
                        }
                    });
                });
            });
            
            // 4. Cuando el nuevo SW toma el control, recargamos la página
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        });
    }
</script>

</head>
<body class="overscroll-none">

    
        <div id="update-notification" class="update-banner">
            <span>Hay una nueva versión disponible.</span>
                <button id="update-reload-button" class="update-button btn">
            <span class="btn-text">Actualizar</span>
                <div class="btn-spinner"></div>
            </button>
        </div>

    <div id="loading-overlay" class="fixed inset-0 bg-background/80 backdrop-blur-sm flex items-center justify-center z-[9999]" style="display: flex;">
        <div class="loader"></div>
    </div>

    <div id="authSection" class="h-screen w-screen flex items-center justify-center p-4">
        <div class="auth-container w-full max-w-sm p-8">
            <div id="loginForm"><h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2><div class="form-group mb-4 text-left"><label class="text-sm font-medium mb-1 block">Correo Electrónico:</label><input type="email" id="loginEmail" placeholder="tu@correo.com" class="w-full"></div><div class="form-group mb-6 text-left"><label class="text-sm font-medium mb-1 block">Contraseña:</label><input type="password" id="loginPassword" placeholder="••••••••" class="w-full"></div><button class="btn-primary w-full py-3 rounded-xl font-semibold" onclick="loginUser()">Entrar</button><p class="text-center mt-6 text-sm text-blue-400 cursor-pointer" onclick="toggleAuthForms()">¿No tienes cuenta? Regístrate</p></div>
            <div id="registerForm" style="display: none;"><h2 class="text-2xl font-bold text-center mb-6">Crear Cuenta</h2><div class="form-group mb-4 text-left"><label class="text-sm font-medium mb-1 block">Correo Electrónico:</label><input type="email" id="registerEmail" placeholder="tu@correo.com" class="w-full"></div><div class="form-group mb-6 text-left"><label class="text-sm font-medium mb-1 block">Contraseña:</label><input type="password" id="registerPassword" placeholder="Mínimo 6 caracteres" class="w-full"></div><button class="btn-primary w-full py-3 rounded-xl font-semibold" onclick="registerUser()">Registrarse</button><p class="text-center mt-6 text-sm text-blue-400 cursor-pointer" onclick="toggleAuthForms()">¿Ya tienes cuenta? Inicia Sesión</p></div>
            <p id="authError" class="text-red-500 mt-4 text-sm"></p>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <main class="main-content">
            <div id="page-operate" class="page">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                        </svg>
                        <h1 id="userEmail" class="text-2xl font-bold">Cargando...</h1>
                    </div>
                    <label for="selectedDate" class="flex items-center gap-2 cursor-pointer">
                         <svg onclick="document.getElementById('selectedDate').showPicker()" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <input type="date" id="selectedDate" class="bg-transparent border-none font-semibold text-blue-400 focus:ring-0 p-0">
                    </label>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="card text-center clickable" onclick="openGainsSummaryModal()">
                        <p class="text-sm font-medium text-gray-400 mb-2">GANANCIA DEL DÍA</p>
                        <div id="ganancias" class="text-4xl font-extrabold text-green-400">0.00 <span class="text-2xl font-semibold">VES</span></div>
                        <div id="ganancias_usdc" class="text-lg font-semibold text-gray-300 mt-1">0.00 <span class="font-medium">USDC</span></div>
                    </div>
                    <div class="card text-center flex flex-col justify-center clickable" onclick="openWallyGainsSummaryModal()">
                        <p class="text-sm font-medium text-gray-400 mb-2">GANANCIAS CRIPTO/USD</p>
                        <div class="flex justify-center items-baseline gap-x-4">
                            <div id="wallyDashboardGainsUsdc" class="text-3xl font-bold text-orange-400">0.00 <span class="text-xl font-semibold">USDC</span></div>
                            <div id="wallyDashboardGainsUsd" class="text-3xl font-bold text-purple-400">0.00 <span class="text-xl font-semibold">USD</span></div>
                        </div>
                    </div>
                </div>
                <div id="dailyGoalsContainer" class="card mb-6 space-y-4">
                </div>
                <div class="card p-4 mb-6">
                    <div class="flex justify-between items-center">
                        <h3 class="font-semibold text-base">Capital Inicial del Día</h3>
                        <button class="btn btn-secondary !py-2 !px-4 !text-sm !font-semibold" onclick="openInitialCapitalModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 inline-block -mt-1 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 17.25v-.228a4.5 4.5 0 00-.12-1.03l-2.268-9.64a3.375 3.375 0 00-3.285-2.602H7.923a3.375 3.375 0 00-3.285 2.602l-2.268 9.64a4.5 4.5 0 00-.12 1.03v.228m19.5 0a3 3 0 01-3 3H5.25a3 3 0 01-3-3m19.5 0a3 3 0 00-3-3H5.25a3 3 0 00-3 3m16.5 0h.008v.008h-.008v-.008zm-3 0h.008v.008h-.008v-.008z" /></svg>
                            <span>Registrar / Editar</span>
                        </button>
                    </div>
                    <div id="initialCapitalSummary" class="mt-4 text-sm">
                        <p class="text-gray-500">Cargando capital...</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="card text-center"><p class="text-sm font-medium text-gray-400">Prom. Compra</p><p id="promCompra" class="text-xl font-bold mt-1">0.00</p></div>
                    <div class="card text-center"><p class="text-sm font-medium text-gray-400">Prom. Venta</p><p id="promVenta" class="text-xl font-bold mt-1">0.00</p></div>
                    <div class="card text-center clickable" onclick="openBankBreachModal()"><p class="text-sm font-medium text-gray-400">Brecha</p><p id="brecha" class="text-xl font-bold mt-1">0%</p></div>
                    <div class="card text-center"><p class="text-sm font-medium text-gray-400">Operaciones</p><p id="totalOps" class="text-xl font-bold mt-1">0</p></div>
                    <div class="card text-center clickable" onclick="openLotDetailsModal()"><p class="text-sm font-medium text-gray-400">Lotes Activos</p><p id="activeLotsSummary" class="text-xl font-bold mt-1">0</p></div>
                    <div class="card text-center clickable" onclick="openPendingDetailsModal()"><p class="text-sm font-medium text-gray-400">Pendientes</p><p id="pendingSummary" class="text-xl font-bold mt-1">0 USDC</p></div>
                    <div class="card text-center clickable col-span-2" onclick="openWeeklyAnalysisModal()">
                        <div class="flex items-center justify-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-purple-400">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v18h16.5V3H3.75zm.75 4.5h15m-15 0a.375.375 0 01.375-.375h14.25c.207 0 .375.168.375.375v9.75c0 .207-.168.375-.375.375H4.125A.375.375 0 013.75 17.25V7.5z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-3-3v6" />
                            </svg>
                            <p class="text-base font-bold text-purple-400">Análisis Semanal</p>
                        </div>
                    </div>
                        <div class="card text-center clickable col-span-2" onclick="openMonthlyAnalysisModal()">
                            <div class="flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-teal-400">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M9.75 12.75h4.5" />
                                </svg>
                                <p class="text-base font-bold text-teal-400">Análisis Mensual</p>
                            </div>
                        </div>
                </div>
                <div class="card text-center clickable col-span-2" onclick="openUsdAnalysisModal()">
                    <div class="flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-sky-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V6.375c0-.621.504-1.125 1.125-1.125h.375m18 0h-4.5m-4.5 0h-4.5m0 0h-4.5m0 0l-1.5 1.5m1.5-1.5l1.5 1.5m0 0l1.5-1.5m1.5 1.5l1.5-1.5m-3-3l1.5-1.5m1.5 1.5l1.5-1.5m-4.5 9l1.5-1.5m-1.5 1.5l1.5 1.5m0 0l-1.5 1.5m1.5-1.5l1.5 1.5M9 12l1.5 1.5m-1.5-1.5L9 12m0 0l-1.5-1.5m1.5 1.5L9 12m-3 3l1.5-1.5m-1.5 1.5L6 15m0 0l-1.5-1.5m1.5 1.5L6 15m6-3l1.5 1.5m-1.5-1.5L15 12m0 0l-1.5-1.5m1.5 1.5L15 12m0 0l-1.5 1.5m-1.5-1.5l-1.5-1.5" />
                        </svg>
                        <p class="text-base font-bold text-sky-400">Análisis USD</p>
                    </div>
                </div>
            </div>
            <div id="page-reports" class="page">
                    <h1 class="text-2xl font-bold mb-4">Operaciones VES</h1>
                    <div class="filter-controls">
                        <div class="filter-item search-bar">
                            <label for="searchOperations">Buscar</label>
                            <input type="text" id="searchOperations" placeholder="Por usuario o referencia..." onkeyup="renderOperations()">
                        </div>
                        <div class="filter-item">
                            <label for="filterOperacion">Operación</label>
                            <select id="filterOperacion" onchange="renderOperations()">
                                <option value="">Todas</option>
                                <option value="Compra">Compra</option>
                                <option value="Venta">Venta</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="filterMetodoPago">Método</label>
                            <select id="filterMetodoPago" onchange="renderOperations()"></select>
                        </div>
                    </div>

                    <div id="reports-empty-state" class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                        </svg>
                        <p>No se encontraron operaciones</p>
                        <span>Prueba cambiando la fecha o ajustando los filtros de búsqueda.</span>
                    </div>
                     <div class="table-container">
                    <div class="card p-0">
                        <table>
                            <thead>
                                <tr><th>USUARIO/MÉTODO</th><th>REF</th><th>OP</th><th>TASA</th><th>CRIPTO</th><th>BS</th><th>GAN. VES</th><th>GAN. CRIPTO</th><th>LOTE</th><th>ESTATUS</th><th>ACC</th></tr>
                            </thead>
                            <tbody id="operationsTable"></tbody>
                        </table>
                    </div>
                 </div>

                 <div class="operations-list-container">
                    <div id="operationsList" class="operations-list"></div>
                </div>
            </div>
            <div id="page-wally" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">Operaciones USD</h1>
                    <label for="wallySelectedDate" class="flex items-center gap-2 cursor-pointer">
                         <svg onclick="document.getElementById('wallySelectedDate').showPicker()" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <input type="date" id="wallySelectedDate" class="bg-transparent border-none font-semibold text-blue-400 focus:ring-0 p-0">
                    </label>
                </div>
                <div class="card text-center mb-6">
    <p class="text-sm font-medium text-gray-400 mb-2">GANANCIAS DEL DÍA (USD)</p>
    <div id="wallyGanancias" class="text-3xl font-extrabold">
        <span class="text-orange-400">0.00</span> <span class="text-xl font-semibold">USDC</span> / 
        <span class="text-purple-400">0.00</span> <span class="text-xl font-semibold">USD</span>
    </div>
</div>

<div class="filter-controls mb-6">
    <div class="filter-item search-bar">
        <label for="searchWallyOperations">Buscar Usuario / Ref</label>
        <input type="text" id="searchWallyOperations" placeholder="Escribe aquí..." onkeyup="renderWallyTables()">
    </div>
    <div class="filter-item">
        <label for="filterWallyOperacion">Operación</label>
        <select id="filterWallyOperacion" onchange="renderWallyTables()">
            <option value="">Todas</option>
            <option value="Compra">Compra (Recibo Cripto)</option>
            <option value="Venta">Venta (Recibo USD)</option>
        </select>
    </div>
    <div class="filter-item">
        <label for="filterWallyMetodoPago">Método de Pago</label>
        <select id="filterWallyMetodoPago" onchange="renderWallyTables()">
            </select>
    </div>
</div>
                <div class="space-y-6">
                    <div>
                    <h2 class="text-lg font-semibold mb-2 text-green-400">COMPRA (Recibo CRIPTO)</h2>
                    <div id="wally-compras-empty-state" class="empty-state" style="margin-top: 0;">
                        <p>Sin Compras en USD</p>
                        <span>No hay operaciones de compra de USDC registradas para esta fecha.</span>
                    </div>
                    <div class="card p-0">
                        <div class="table-container">
                            <table class="w-full min-w-[600px]">
                                <thead><tr><th>Usuario/Plataforma</th><th>Recibo CRIPTO</th><th>Tasa</th><th>Envío USD</th><th>Gan. CRIPTO</th><th>Acciones</th></tr></thead>
                                <tbody id="wallyCompraTable"></tbody>
                            </table>
                        </div>
                        <div class="operations-list-container p-4">
                            <div id="wallyCompraList" class="operations-list"></div>
                        </div>
                    </div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold mb-2 text-red-400">VENTAS (Recibo USD)</h2>
                    <div id="wally-ventas-empty-state" class="empty-state" style="margin-top: 0;">
                        <p>Sin Ventas en USD</p>
                        <span>No hay operaciones de venta de USDC registradas para esta fecha.</span>
                    </div>
                    <div class="card p-0">
                        <div class="table-container">
                            <table class="w-full min-w-[600px]">
                                <thead><tr><th>Usuario/Plataforma</th><th>Envío CRIPTO</th><th>Tasa</th><th>Recibo USD</th><th>Gan. USD</th><th>Acciones</th></tr></thead>
                                <tbody id="wallyVentaTable"></tbody>
                            </table>
                        </div>
                        <div class="operations-list-container p-4">
                            <div id="wallyVentaList" class="operations-list"></div>
                        </div>
                    </div>
                </div>
                </div>
                <button class="btn-fab" onclick="openWallyModal()" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg></button>
            </div>
            <div id="page-ratings" class="page">
                <h1 class="text-2xl font-bold mb-4">Calificaciones de Usuarios</h1>
                <div class="filter-controls mb-6">
                    <div class="filter-item search-bar">
                        <label for="searchRatings">Buscar Usuario</label>
                        <input type="text" id="searchRatings" placeholder="Nombre de usuario..." onkeyup="renderRatingsPage()">
                    </div>
                </div>
                <div id="ratingsListContainer" class="space-y-3">
                    </div>
                    
                    <div id="ratings-pagination" class="flex justify-between items-center mt-6" style="display: none;">
                        <button id="prev-page-btn" class="btn btn-secondary !py-2 !px-4">Anterior</button>
                        <span id="page-info" class="text-sm font-semibold text-gray-400"></span>
                        <button id="next-page-btn" class="btn btn-secondary !py-2 !px-4">Siguiente</button>
                    </div>
            </div>
            <div id="page-settings" class="page">
                <h1 class="text-2xl font-bold mb-6">Ajustes</h1>
                <div class="space-y-4">
                    <button onclick="openConfigModal()" class="w-full text-left p-4 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors">⚙️ Configuración General</button>
                    
                    <button id="enableSoundBtn" onclick="enableAudio()" class="w-full text-left p-4 rounded-lg bg-gray-800 hover:bg-gray-700 transition-colors">🔊 Habilitar Sonido para Notificaciones</button>
                    
                    <button onclick="logoutUser()" class="w-full text-left p-4 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors">🚪 Cerrar Sesión</button>
                </div>
            </div>
            <button id="main-fab" class="btn-fab" onclick="openModal()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg></button>
        </main>
        <nav class="bottom-nav">
            <button id="nav-operate" class="nav-item active" onclick="showPage('operate')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V6.375c0-.621.504-1.125 1.125-1.125h.375m18 0h-4.5m-4.5 0h-4.5m0 0h-4.5m0 0l-1.5 1.5m1.5-1.5l1.5 1.5m0 0l1.5-1.5m1.5 1.5l1.5-1.5m-3-3l1.5-1.5m1.5 1.5l1.5-1.5m-4.5 9l1.5-1.5m-1.5 1.5l1.5 1.5m0 0l-1.5 1.5m1.5-1.5l1.5 1.5M9 12l1.5 1.5m-1.5-1.5L9 12m0 0l-1.5-1.5m1.5 1.5L9 12m-3 3l1.5-1.5m-1.5 1.5L6 15m0 0l-1.5-1.5m1.5 1.5L6 15m6-3l1.5 1.5m-1.5-1.5L15 12m0 0l-1.5-1.5m1.5 1.5L15 12m0 0l-1.5 1.5m-1.5-1.5l-1.5-1.5"/></svg><span>Dashboard</span></button>
            <button id="nav-reports" class="nav-item" onclick="showPage('reports')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg><span>Resumen VES</span></button>
            <button id="nav-wally" class="nav-item" onclick="showPage('wally')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Operaciones USD</span></button>
            <button id="nav-ratings" class="nav-item" onclick="showPage('ratings')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" /></svg><span>Ratings</span></button>
            <button id="nav-settings" class="nav-item" onclick="showPage('settings')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg><span>Ajustes</span></button>
        </nav>
    </div>
    
    <div id="toast-container"></div>
    
    <div id="operationModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 class="modal-title text-xl font-bold" id="modalTitle">Nueva Operación</h2><button class="close-btn" onclick="closeModal()">&times;</button></div><div class="modal-body"><div class="space-y-4"><div class="form-group"><label class="text-sm font-medium mb-1 block">Usuario</label><input type="text" id="usuario" placeholder="Nombre del usuario" class="w-full"></div><div class="grid grid-cols-2 gap-4"><div class="form-group"><label class="text-sm font-medium mb-1 block">Referencia</label><input type="text" id="referencia" placeholder="Nº de referencia" class="w-full"></div><div class="form-group"><label class="text-sm font-medium mb-1 block">Estatus</label><select id="estatus" class="w-full"><option value="En Curso">En Curso</option><option value="En Disputa">En Disputa</option><option value="Completado">Completado</option></select></div></div><div class="grid grid-cols-3 gap-4"><div class="form-group"><label class="text-sm font-medium mb-1 block">Operación</label><select id="operacion" onchange="calculateAll()" class="w-full"><option value="Compra">Compra</option><option value="Venta">Venta</option></select></div><div class="form-group"><label class="text-sm font-medium mb-1 block">Método de Pago</label><select id="metodoPago" onchange="calculateAll()" class="w-full"></select></div><div class="form-group"><label class="text-sm font-medium mb-1 block">Plataforma P2P</label><select id="p2pPlatformSelect" onchange="calculateAll()" class="w-full"></select></div></div><hr class="border-gray-700"><div class="grid grid-cols-2 gap-4"><div class="form-group"><label class="text-sm font-medium mb-1 block">Tasa de Cambio</label><input type="number" id="tasa" step="0.01" placeholder="0.00" onkeyup="calculateAll()" class="w-full"></div><div class="form-group"><label class="text-sm font-medium mb-1 block">Monto Cripto</label><input type="number" id="montoUsdc" step="0.001" placeholder="0.00" onkeyup="calculateAll()" class="w-full"></div></div><div class="calc-display space-y-2 text-sm"><div id="displayAdCommissionRow" class="calc-row" style="display: none;"><span id="displayAdCommissionLabel">Comisión Plataforma:</span><span id="displayAdCommission"></span></div><div class="calc-row"><span>Monto BS:</span><span id="displayMontoBs">0.00</span></div><div class="calc-row"><span>Comisión VES:</span><span id="displayComision">0.00</span></div><div class="calc-row total text-base"><span>Total:</span><span id="displayTotal">0.00</span></div></div><input type="hidden" id="montoBs"><input type="hidden" id="comisionVes"><input type="hidden" id="total"><input type="hidden" id="ves"><input type="hidden" id="usdc"><input type="hidden" id="lote"></div></div><div class="modal-buttons"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-green" onclick="pasteSpecial()">📋 Pegado Especial</button><button id="saveOperationBtn" class="btn btn-primary" onclick="saveOperation()"><div class="btn-spinner"></div>Guardar</button>
    </div>
    </div>
    </div>

    <div id="initialCapitalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header flex justify-between items-center">
                <h2 class="modal-title text-xl font-bold">Capital Inicial para <span id="capitalModalDate"></span></h2>
                <button class="close-btn" onclick="closeInitialCapitalModal()">&times;</button>
            </div>
            <div class="modal-body space-y-4">
                <div class="card p-4 bg-background">
                    <h4 class="font-semibold mb-3 text-base">Añadir Nueva Cuenta</h4>
                    <div class="grid grid-cols-1 md:grid-cols-[1fr_1fr_auto] gap-3 items-end">
                        <div class="form-group">
                            <label class="text-xs">Nombre de Cuenta (Ej: Wally, Banesco)</label>
                            <input type="text" id="newAccountName" placeholder="Binance P2P" class="form-field-grid">
                        </div>
                        <div class="form-group">
                            <label class="text-xs">Moneda (Ej: USDT, VES)</label>
                            <input type="text" id="newAccountCurrency" placeholder="USDT" class="form-field-grid">
                        </div>
                        <button id="addAccountBtn" onclick="addManagedAccount()" class="btn btn-secondary h-11">Añadir</button>
                    </div>
                </div>

                <hr class="border-gray-700 !my-5">
                
                <div id="initialCapitalForm" class="space-y-3">
                    </div>

            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeInitialCapitalModal()">Cancelar</button>
                <button id="saveCapitalBtn" class="btn btn-primary" onclick="saveInitialCapital()"><div class="btn-spinner"></div>Guardar Capital</button>
            </div>
        </div>
    </div>
    
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header flex justify-between items-center">
                <h2 class="modal-title text-xl font-bold">Configuración</h2>
                <button class="close-btn" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="space-y-6">
    
                    <div>
                        <h3 class="text-base font-semibold mb-3">Metas de Ganancias Diarias</h3>
                        <div class="card p-4 bg-background space-y-4">
                            <div class="grid grid-cols-[1fr_auto] items-center gap-4">
                                <label for="goalVes" class="font-medium text-sm">VES:</label>
                                <input type="number" id="goalVes" step="0.01" placeholder="Ej: 1000.00" class="form-field-grid">
                            </div>
                            <div class="grid grid-cols-[1fr_auto] items-center gap-4">
                                <label for="goalCrypto" class="font-medium text-sm">CRIPTO (USDC):</label>
                                <input type="number" id="goalCrypto" step="0.01" placeholder="Ej: 50.00" class="form-field-grid">
                            </div>
                            <div class="grid grid-cols-[1fr_auto] items-center gap-4">
                                <label for="goalUsd" class="font-medium text-sm">USD:</label>
                                <input type="number" id="goalUsd" step="0.01" placeholder="Ej: 50.00" class="form-field-grid">
                            </div>
                            <hr class="border-gray-700 !my-5">
                            <div>
                                <label class="font-medium text-sm mb-3 block text-center">Mostrar en Dashboard:</label>
                                <div id="dashboardGoalToggles" class="flex justify-center gap-3">
                                    <button data-goal="ves" class="goal-toggle-btn">VES</button>
                                    <button data-goal="crypto" class="goal-toggle-btn">CRIPTO</button>
                                    <button data-goal="usd" class="goal-toggle-btn">USD</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="border-gray-700 !my-6">
                    <div>
                        <h3 class="text-base font-semibold mb-3">Gestión de Plataformas P2P</h3>
                        <div id="p2pPlatformsList" class="space-y-2 mb-4"></div>
                        <div class="card p-4 bg-background">
                            <h4 class="font-semibold mb-2" id="platformFormTitle">Añadir Nueva Plataforma</h4>
                            <div class="grid grid-cols-2 gap-x-2 gap-y-3">
                                <div class="form-group col-span-2">
                                    <label class="text-xs">Nombre</label>
                                    <input type="text" id="newPlatformName" placeholder="Ej: Syklo" class="form-field-grid">
                                </div>
                                <div class="form-group">
                                    <label class="text-xs">Comisión (%)</label>
                                    <input type="number" id="newPlatformCommission" placeholder="Ej: 0.2" step="0.1" class="form-field-grid">
                                </div>
                                <div class="form-group">
                                    <label class="text-xs">Tipo</label>
                                    <select id="newPlatformType" class="form-field-grid">
                                        <option value="CRIPTO">CRIPTO</option>
                                        <option value="USD">USD</option>
                                        <option value="VES">VES</option>
                                    </select>
                                </div>
                                <input type="hidden" id="editingPlatformIndex" value="-1">
                                <button id="addPlatformBtn" class="btn btn-secondary h-11 col-span-2">Añadir Plataforma</button>
                            </div>
                        </div>
                    </div>
    
                    <hr class="border-gray-700 !my-6">

                    <div>
                        <h3 class="text-base font-semibold mb-3">Métodos de Pago (VES)</h3>
                        <div id="paymentMethodsList" class="flex flex-wrap gap-2 mb-4"></div>
                        <div class="flex gap-2"><input type="text" id="newPaymentMethod" placeholder="Nuevo método..." class="form-field-grid flex-grow"><button class="btn btn-secondary" onclick="addPaymentMethod()">Añadir</button></div>
                    </div>
    
                    <div>
                        <h3 class="text-base font-semibold mb-3">Métodos de Pago (USD)</h3>
                        <div id="usdPaymentMethodsList" class="flex flex-wrap gap-2 mb-4"></div>
                        <div class="flex gap-2"><input type="text" id="newUsdPaymentMethod" placeholder="Nuevo método USD..." class="form-field-grid flex-grow"><button class="btn btn-secondary" onclick="addUsdPaymentMethod()">Añadir</button></div>
                    </div>
    
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeConfigModal()">Cerrar</button>
                <button id="saveConfigBtn" class="btn btn-primary" onclick="saveConfig()"><div class="btn-spinner"></div>Guardar Cambios</button>
            </div>
        </div>
    </div>

    <div id="wallyModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 id="wallyModalTitle" class="modal-title text-xl font-bold">Operación USD</h2><button class="close-btn" onclick="closeWallyModal()">&times;</button></div><div class="modal-body"><div id="wallyFormContent" class="space-y-4"></div></div><div class="modal-buttons"><button class="btn btn-secondary" onclick="closeWallyModal()">Cancelar</button><button class="btn btn-green" onclick="pasteSpecialWally()">📋 Pegado Especial</button><button id="saveWallyBtn" class="btn btn-primary" onclick="saveWallyOperation()"><div class="btn-spinner"></div>Guardar</button></div></div></div>
    
    <div id="bankBreachModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 class="modal-title text-xl font-bold">Brecha por Banco</h2><button class="close-btn" onclick="closeBankBreachModal()">&times;</button></div><div class="modal-body"><div id="bankBreachCards" class="info-cards-grid"></div></div></div></div>
    <div id="lotDetailsModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 class="modal-title text-xl font-bold">Lotes Activos</h2><button class="close-btn" onclick="closeLotDetailsModal()">&times;</button></div><div class="modal-body"><div id="lotDetailsCards" class="info-cards-grid"></div></div></div></div>
    <div id="pendingDetailsModal" class="modal"><div class="modal-content"><div class="modal-header flex justify-between items-center"><h2 class="modal-title text-xl font-bold">Detalles de Pendientes</h2><button class="close-btn" onclick="closePendingDetailsModal()">&times;</button></div><div class="modal-body"><div class="grid grid-cols-2 gap-4 mb-4"><div class="card text-center"><p class="text-sm font-medium text-gray-400">Recompra</p><p id="pendingRepurchaseSummary" class="text-lg font-bold mt-1">0 USDC</p></div><div class="card text-center"><p class="text-sm font-medium text-gray-400">Reventa</p><p id="pendingResaleSummary" class="text-lg font-bold mt-1">0 USDC</p></div></div><h3 class="font-semibold mb-2">Operaciones de Recompra</h3><div id="pendingRepurchaseList" class="operation-list mb-4"></div><h3 class="font-semibold mb-2">Operaciones de Reventa</h3><div id="pendingResaleList" class="operation-list"></div></div></div></div>

    <div id="gainsSummaryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header flex justify-between items-center">
            <h2 class="modal-title text-xl font-bold">Resumen de Ganancias</h2>
            <button class="close-btn" onclick="closeGainsSummaryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                
                <div class="card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">HOY</p>
                    <div id="summaryGananciasHoyVes" class="text-2xl font-bold text-green-400">0.00 VES</div>
                    <div id="summaryGananciasHoyUsdc" class="text-base font-semibold text-gray-300 mt-1">0.00 USDC</div>
                </div>

                <div class="card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">ESTA SEMANA</p>
                    <div id="summaryGananciasSemanaVes" class="text-2xl font-bold text-green-400">0.00 VES</div>
                    <div id="summaryGananciasSemanaUsdc" class="text-base font-semibold text-gray-300 mt-1">0.00 USDC</div>
                </div>

                <div class="col-span-1 sm:col-span-2 card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">ESTE MES</p>
                    <div id="summaryGananciasMesVes" class="text-3xl font-bold text-green-400">0.00 VES</div>
                    <div id="summaryGananciasMesUsdc" class="text-lg font-semibold text-gray-300 mt-1">0.00 USDC</div>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="wallyGainsSummaryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header flex justify-between items-center">
            <h2 class="modal-title text-xl font-bold">Resumen de Ganancias USD</h2>
            <button class="close-btn" onclick="closeWallyGainsSummaryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                
                <div class="card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">HOY</p>
                    <div id="summaryWallyGananciasHoyUsdc" class="text-2xl font-bold text-orange-400">0.00 USDC</div>
                    <div id="summaryWallyGananciasHoyUsd" class="text-base font-semibold text-purple-400 mt-1">0.00 USD</div>
                </div>

                <div class="card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">ESTA SEMANA</p>
                    <div id="summaryWallyGananciasSemanaUsdc" class="text-2xl font-bold text-orange-400">0.00 USDC</div>
                    <div id="summaryWallyGananciasSemanaUsd" class="text-base font-semibold text-purple-400 mt-1">0.00 USD</div>
                </div>

                <div class="col-span-1 sm:col-span-2 card text-center p-4">
                    <p class="text-sm font-medium text-gray-400 mb-2">ESTE MES</p>
                    <div id="summaryWallyGananciasMesUsdc" class="text-3xl font-bold text-orange-400">0.00 USDC</div>
                    <div id="summaryWallyGananciasMesUsd" class="text-lg font-semibold text-purple-400 mt-1">0.00 USD</div>
                </div>

            </div>
        </div>
    </div>
</div>

    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title text-xl font-bold">Calificar Transacción</h2>
                <button class="close-btn" onclick="closeRatingModal()">&times;</button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-4">Califica la transacción con <strong id="ratingUserName"></strong>:</p>
                <div class="form-group mb-6">
                    <label class="text-sm font-medium mb-2 block">Transacción General</label>
                    <div class="rating-stars" id="ratingTransaction">
                        <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                    </div>
                </div>
                 <div class="form-group">
                    <label class="text-sm font-medium mb-2 block">Rapidez</label>
                    <div class="rating-stars" id="ratingSpeed">
                        <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                 <button class="btn btn-primary w-full" onclick="submitRating()">Guardar Calificación</button>
            </div>
        </div>
    </div>

    <div id="userProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title text-xl font-bold" id="profileUserName"></h2>
            <button class="close-btn" onclick="closeUserProfileModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="card mb-4 text-center">
                <p class="text-sm text-gray-400">Calificación Promedio</p>
                <p id="profileAvgRating" class="text-3xl font-bold text-yellow-400 my-1">0.0 ★</p>
                <p id="profileTotalRatings" class="text-xs text-gray-500">0 calificaciones</p>
            </div>
            <div class="card mb-4">
                <h3 class="font-semibold mb-2 text-base">Estadísticas Consolidadas</h3>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <span>Vol. Total USDC:</span><strong id="profileTotalUsdc" class="text-right">0.00</strong>
                    <span>Vol. Total VES:</span><strong id="profileTotalVes" class="text-right">0.00</strong>
                    <span># Operaciones Totales:</span><strong id="profileNumOps" class="text-right">0</strong>
                    <span>Última Op.:</span><strong id="profileLastOpDate" class="text-right">N/A</strong>
                </div>
            </div>
            <div class="card mb-4">
                <h3 class="font-semibold mb-2 text-base">Notas Privadas</h3>
                <div class="form-group">
                    <textarea id="profileNotes" rows="4" placeholder="Añade notas sobre este usuario..." class="w-full text-sm"></textarea>
                </div>
                <button class="btn btn-primary btn-sm mt-2 w-full" onclick="saveProfileNotes()">Guardar Notas</button>
            </div>
            
            <div class="card p-0">
                <div class="border-b border-gray-700 px-4">
                    <nav class="-mb-px flex space-x-4" id="profile-tabs">
                        <button class="profile-tab active" onclick="switchProfileTab('ves')">Historial VES</button>
                        <button class="profile-tab" onclick="switchProfileTab('usd')">Historial USD</button>
                    </nav>
                </div>
                <div id="profile-tab-content" class="p-4">
                    </div>
            </div>
            </div>
    </div>
</div>

<div id="weeklyAnalysisModal" class="modal">
        <div class="modal-content !max-w-3xl">
            <div class="modal-header flex justify-between items-center">
                <h2 class="modal-title text-xl font-bold">📊 Análisis de la Semana</h2>
                <button class="close-btn" onclick="closeWeeklyAnalysisModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-6 h-64 md:h-80">
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div id="weeklyAnalysisSummary" class="card p-4 bg-background space-y-3">
                    <div class="text-center py-4">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-sm text-gray-400">Calculando análisis...</p>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeWeeklyAnalysisModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="monthlyAnalysisModal" class="modal">
    <div class="modal-content !max-w-3xl">
        <div class="modal-header flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h2 class="modal-title text-xl font-bold">🗓️ Análisis Mensual</h2>

                <div class="filter-item !min-w-[200px]">
                    <select id="monthSelector" onchange="runMonthlyAnalysis()"></select>
                </div>
            </div>
            <button class="close-btn" onclick="closeMonthlyAnalysisModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="mb-6 h-64 md:h-80">
                <canvas id="monthlyChart"></canvas>
            </div>
            <div id="monthlyAnalysisSummary" class="card p-4 bg-background space-y-3">
                <div class="text-center py-4">
                    <p class="mt-2 text-sm text-gray-400">Selecciona un mes para comenzar el análisis.</p>
                </div>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeMonthlyAnalysisModal()">Cerrar</button>
        </div>
    </div>
</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script type="module">
        const firebaseConfig = { apiKey: "AIzaSyAovfm0PWP5f6rvSmDva5ZQLOAcOdDNCgk", authDomain: "dashboard-operaciones-a9996.firebaseapp.com", projectId: "dashboard-operaciones-a9996", storageBucket: "dashboard-operaciones-a9996.appspot.com", messagingSenderId: "788099450381", appId: "1:788099450381:web:95cd9fa3e96ec9397a3744" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUserId = null;
        let operations = [], wallyOperations = [], userRatings = {}, userProfiles = {};
        let userConfig = {};
        let editingIndex = -1, editingWallyIndex = -1;
        let lastSavedUser = '', lastSavedOperationType = '';
        let initialLoadCounter = 0;
        let currentDayCapital = null;
        let currentProfileUserOps = { ves: [], usd: [] };
        let weeklyChartInstance; // Guardará nuestro gráfico para poder destruirlo después
        let monthlyChartInstance; // Guardará el gráfico mensual
        let usdWeeklyChartInstance, usdWeeklyPaymentMethodChartInstance, usdWeeklyP2pPlatformChartInstance;
let usdMonthlyChartInstance, usdMonthlyPaymentMethodChartInstance, usdMonthlyP2pPlatformChartInstance;
        let currentUsdAnalysisTab = 'weekly'; // 'weekly' o 'monthly'
        // ...

        // AÑADE ESTAS DOS LÍNEAS
        let ratingsCurrentPage = 1;
        const USERS_PER_PAGE = 20;

        const TOTAL_INITIAL_LOADS = 5; 
        
        function checkInitialLoadComplete() {
            initialLoadCounter++;
            if (initialLoadCounter >= TOTAL_INITIAL_LOADS) {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        const getLocalDate = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        let currentDate = getLocalDate();
        let currentWallyDate = getLocalDate();
        let currentLotsData = new Map();
        let currentPendingData = { recompra: 0, reventa: 0, recompraOps: [], reventaOps: [] };
        let wallyTotalGains = { usdc: 0, usd: 0 };
        const defaultProfitGoals = { ves: 1000.00, crypto: 50.00, usd: 50.00 };
        const defaultDashboardGoals = { ves: true, crypto: false, usd: false };


        const authSection = document.getElementById('authSection');
        const appContainer = document.querySelector('.app-container');
        const userEmailEl = document.getElementById('userEmail');
        const authError = document.getElementById('authError');

        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.getElementById(`nav-${pageName}`).classList.add('active');
            const mainFab = document.getElementById('main-fab');
            const wallyPage = document.getElementById('page-wally');
            const wallyFab = wallyPage.querySelector('.btn-fab');
            mainFab.style.display = (pageName === 'operate' || pageName === 'reports') ? 'flex' : 'none';
            wallyFab.style.display = pageName === 'wally' ? 'flex' : 'none';
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                document.getElementById('loading-overlay').style.display = 'flex'; 
                initialLoadCounter = 0; 

                currentUserId = user.uid;
                authSection.style.display = 'none'; appContainer.style.display = 'flex';
                userEmailEl.textContent = user.email.split('@')[0];
                
                if (localStorage.getItem('soundEnabled') === 'true') {
                    const btn = document.getElementById('enableSoundBtn');
                    if (btn) btn.style.display = 'none';
                }
                
                await loadConfig();
                
                loadOperations(); 
                loadWallyOperations(); 
                loadUserRatings(); 
                loadUserProfiles();
                
                document.getElementById('selectedDate').value = currentDate;
                document.getElementById('wallySelectedDate').value = currentWallyDate;
                showPage('operate');
            } else {
                currentUserId = null;
                authSection.style.display = 'flex'; appContainer.style.display = 'none';
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });

        function registerUser() { const e = document.getElementById('registerEmail').value, p = document.getElementById('registerPassword').value; authError.textContent = ''; auth.createUserWithEmailAndPassword(e, p).catch(err => { authError.textContent = 'Error: ' + err.message; }); }
        function loginUser() { const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPassword').value; authError.textContent = ''; auth.signInWithEmailAndPassword(e, p).catch(err => { authError.textContent = 'Error: ' + err.message; }); }
        function logoutUser() { auth.signOut(); }
        function toggleAuthForms() { const l = document.getElementById('loginForm'), r = document.getElementById('registerForm'); authError.textContent = ''; l.style.display = l.style.display === 'none' ? 'block' : 'none'; r.style.display = r.style.display === 'none' ? 'block' : 'none'; }

        function loadOperations() { if (!currentUserId) return; db.collection('users').doc(currentUserId).collection('operations').orderBy('timestamp', 'desc').onSnapshot(s => { operations = s.docs.map(d => ({ id: d.id, ...d.data() })); updateSummary(); populateMonthSelector(); checkInitialLoadComplete(); }, e => { console.error(e); checkInitialLoadComplete(); }); }
        function loadWallyOperations() { if (!currentUserId) return; db.collection('users').doc(currentUserId).collection('wallyOperations').orderBy('timestamp', 'desc').onSnapshot(s => { wallyOperations = s.docs.map(d => ({ id: d.id, ...d.data() })); updateWallySummary(); checkInitialLoadComplete(); }, e => { console.error(e); checkInitialLoadComplete(); });}
        
        function saveOperation() {
    if (!currentUserId) return;
    const saveBtn = document.getElementById('saveOperationBtn');
    saveBtn.classList.add('loading');

    const operacion = document.getElementById('operacion').value;
    const tasa = parseFloat(document.getElementById('tasa').value) || 0;
    const metodoPago = document.getElementById('metodoPago').value;
    const platformSelect = document.getElementById('p2pPlatformSelect');
    const platform = userConfig.p2pPlatforms.find(p => p.name === platformSelect.value);
    const commissionRate = platform ? platform.commission / 100 : 0;
    
    // La regla de oro: Siempre usamos el monto BRUTO (ej: 1.000) del input.
    const grossUsdc = parseFloat(document.getElementById('montoUsdc').value) || 0;
    
    const montoBs = grossUsdc * tasa;
    
    let comisionVes = 0;
    if (operacion === 'Compra' && metodoPago === 'Pagomovil') {
        comisionVes = montoBs * 0.003;
    }
    const total = montoBs + comisionVes;

    const operationData = { 
        usuario: document.getElementById('usuario').value, 
        referencia: document.getElementById('referencia').value, 
        operacion, 
        p2pPlatform: platformSelect.value,
        tasa, 
        metodoPago, 
        montoUsdc: grossUsdc, // Y guardamos ese monto BRUTO.
        montoBs,
        comisionVes,
        total,
        ves: 0, 
        usdc: 0, 
        lote: '', 
        estatus: document.getElementById('estatus').value, 
        fecha: currentDate, 
        timestamp: Date.now(), 
        adCommissionPercent: commissionRate * 100
    };

    if (!operationData.usuario || !operationData.tasa || !grossUsdc) { 
        showToast('Por favor, complete todos los campos obligatorios.', 'error'); 
        saveBtn.classList.remove('loading');
        return; 
    }

    const isEditing = editingIndex > -1;
    const opId = isEditing ? operations[editingIndex].id : db.collection('users').doc(currentUserId).collection('operations').doc().id;
    operationData.id = opId;
    db.collection('users').doc(currentUserId).collection('operations').doc(opId).set(operationData, { merge: true }).then(() => { 
        closeModal(); 
        showToast('Operación guardada.', 'success'); 
        if (!isEditing) {
            lastSavedUser = operationData.usuario;
            lastSavedOperationType = 'main';
            openRatingModal(operationData.usuario);
        }
    }).catch(e => {
        showToast('Error al guardar.', 'error');
    }).finally(() => {
        saveBtn.classList.remove('loading');
    });
}

        
        function calculateAll() {
    const tasa = parseFloat(document.getElementById('tasa').value) || 0;
    const montoUsdcOriginal = parseFloat(document.getElementById('montoUsdc').value) || 0; // Este es el monto BRUTO
    const operacion = document.getElementById('operacion').value;
    const metodoPago = document.getElementById('metodoPago').value;
    const platformSelect = document.getElementById('p2pPlatformSelect');
    const platform = userConfig.p2pPlatforms.find(p => p.name === platformSelect.value);
    const commissionRate = platform ? platform.commission / 100 : 0;

    // El "Monto BS" siempre se calcula sobre el monto BRUTO.
    const montoBs = montoUsdcOriginal * tasa;
    let comisionVes = 0;

    // --- INICIO DE LA CORRECCIÓN ---
    // La comisión bancaria (Pago Móvil) depende solo del método de pago y la operación,
    // por eso esta lógica ahora está fuera del bloque de la comisión de plataforma.
    if (operacion === 'Compra' && metodoPago === 'Pagomovil') {
        comisionVes = montoBs * 0.003;
    }
    // --- FIN DE LA CORRECCIÓN ---

    let total = montoBs + comisionVes;

    const adCommissionRow = document.getElementById('displayAdCommissionRow');
    const adCommissionLabel = document.getElementById('displayAdCommissionLabel');
    const adCommissionDisplay = document.getElementById('displayAdCommission');

    // Lógica para mostrar la comisión de la PLATAFORMA (Apolo, etc.)
    if (commissionRate > 0 && montoUsdcOriginal > 0) {
        const commissionAmountUsdc = montoUsdcOriginal * commissionRate;
        
        if (operacion === 'Venta') {
            const totalDebitUsdc = montoUsdcOriginal * (1 + commissionRate);
            adCommissionLabel.textContent = `Comisión Apolo (0.2%):`;
            adCommissionDisplay.textContent = `+${commissionAmountUsdc.toFixed(4)} (Costo Total: ${totalDebitUsdc.toFixed(4)} USDT)`;
        } else { // Es una COMPRA
            const netReceivedUsdc = montoUsdcOriginal * (1 - commissionRate);
            adCommissionLabel.textContent = `Comisión Apolo (0.2%):`;
            adCommissionDisplay.textContent = `-${commissionAmountUsdc.toFixed(4)} (Neto a recibir: ${netReceivedUsdc.toFixed(4)} USDT)`;
        }
        adCommissionRow.style.display = 'flex';
    } else {
        adCommissionRow.style.display = 'none';
    }
    
    // Actualizar todos los campos de la UI con los valores correctos
    ['displayMontoBs', 'montoBs'].forEach(id => document.getElementById(id).textContent = document.getElementById(id).value = montoBs.toFixed(2));
    ['displayComision', 'comisionVes'].forEach(id => document.getElementById(id).textContent = document.getElementById(id).value = comisionVes.toFixed(2));
    ['displayTotal', 'total'].forEach(id => document.getElementById(id).textContent = document.getElementById(id).value = total.toFixed(2));
}


        function editOperation(index) {
            editingIndex = index; 
            const op = operations[index];
            document.getElementById('modalTitle').textContent = 'Editar Operación';

            // --- LÓGICA CORREGIDA ---
            // Como ahora siempre guardamos el monto BRUTO, no necesitamos reconstruir nada.
            // Simplemente usamos el valor guardado directamente.
            document.getElementById('montoUsdc').value = op.montoUsdc.toFixed(3);

            // Llenamos el resto del formulario como antes
            document.getElementById('usuario').value = op.usuario; 
            document.getElementById('referencia').value = op.referencia;
            document.getElementById('operacion').value = op.operacion; 
            document.getElementById('tasa').value = op.tasa;
            document.getElementById('metodoPago').value = op.metodoPago;
            document.getElementById('p2pPlatformSelect').value = op.p2pPlatform || (userConfig.p2pPlatforms.find(p=>p.isDefault)?.name || '');
            document.getElementById('estatus').value = op.estatus; 

            calculateAll(); 
            openModal();
        }

        function populateUsdPaymentMethodsFilter() {
            const methods = userConfig.paymentMethods ? userConfig.paymentMethods.usd || [] : [];
            const filterSelect = document.getElementById('filterWallyMetodoPago');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">Todos los Métodos</option>' + methods.map(m => `<option value="${m}">${m}</option>`).join('');
            }
        }
        
        function calculateFIFOGainsForOps(opsArray) {
    if (!opsArray || opsArray.length === 0) {
        return [0, 0]; // Devuelve [gananciaVes, gananciaUsdc]
    }

    // Usamos una copia para no alterar los datos originales
    const opsCopy = JSON.parse(JSON.stringify(opsArray));
    let totalGainVes = 0;
    let totalGainUsdc = 0;

    const sales = opsCopy.filter(op => op.operacion === 'Venta').sort((a, b) => a.timestamp - b.timestamp);
    const purchases = opsCopy.filter(op => op.operacion === 'Compra').sort((a, b) => a.timestamp - b.timestamp);

    purchases.forEach(p => p._unmatchedAmount = p.montoUsdc); // montoUsdc es el monto BRUTO

    sales.forEach(sale => {
        let remainingSaleAmount = sale.montoUsdc; // BRUTO de la venta

        for (const purchase of purchases) {
            if (purchase._unmatchedAmount > 1e-5 && remainingSaleAmount > 1e-5) {
                const amountToMatch = Math.min(remainingSaleAmount, purchase._unmatchedAmount); // Monto BRUTO a parear

                const commissionRate = (purchase.adCommissionPercent || 0) / 100;

                // 1. Ganancia por la diferencia de Tasa (Spread)
                const revenueVes = amountToMatch * sale.tasa;
                const costVes = amountToMatch * purchase.tasa;
                // Calculamos la comisión bancaria proporcional al monto pareado
                const bankFeeForMatch = (purchase.comisionVes / purchase.montoUsdc) * amountToMatch;
                const spreadGainInVes = revenueVes - costVes - bankFeeForMatch;
                const spreadGainInUsdt = spreadGainInVes / purchase.tasa;

                // 2. Costo total por las comisiones de la plataforma (Apolo)
                const totalCommissionCostInUsdt = (amountToMatch * commissionRate) * 2; // (comisión de compra + comisión de venta)
                
                // 3. Ganancia NETA final en USDT para este ciclo
                const netGainInUsdt = spreadGainInUsdt - totalCommissionCostInUsdt;
                const netGainInVes = netGainInUsdt * purchase.tasa;

                totalGainVes += netGainInVes;
                totalGainUsdc += netGainInUsdt;

                remainingSaleAmount -= amountToMatch;
                purchase._unmatchedAmount -= amountToMatch;
            }
            if (remainingSaleAmount < 1e-5) break;
        }
    });

    return [totalGainVes, totalGainUsdc];
}

        function calculateWallyGainsForPeriod(periodOps) {
            const compras = periodOps.filter(op => op.operacion === 'Compra');
            const ventas = periodOps.filter(op => op.operacion === 'Venta');
            const totalGananciaUsdc = compras.reduce((s, op) => s + (op.gananciaUsdc || 0), 0);
            const totalGananciaUsd = ventas.reduce((s, op) => s + (op.gananciaUsd || 0), 0);
            return [totalGananciaUsdc, totalGananciaUsd];
        };
        
        function deleteOperation(index) {
            if (!currentUserId || !confirm('¿Está seguro de que desea eliminar esta operación?')) return;
            const operationId = operations[index].id;
            db.collection('users').doc(currentUserId).collection('operations').doc(operationId).delete()
                .then(() => showToast('Operación eliminada.', 'info'))
                .catch(error => showToast('Error al eliminar la operación.', 'error'));
        }
        
        function deleteWallyOperation(index) {
            if (!currentUserId || !confirm('¿Estás seguro de que deseas eliminar esta operación USD?')) return;
            const operationId = wallyOperations[index].id;
            db.collection('users').doc(currentUserId).collection('wallyOperations').doc(operationId).delete()
                .then(() => showToast('Operación USD eliminada.', 'info'))
                .catch(error => showToast('Error al eliminar la operación.', 'error'));
        }
        
       function applyFIFOForDate(fecha) {
            const dailyOps = operations.filter(op => op.fecha === fecha).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            
            dailyOps.forEach(op => {
                op.ves = 0;
                op.usdc = 0;
                op.lote = '';
                if (op.operacion === 'Venta') { // Usamos las ventas como punto de partida para el FIFO
                    op._unmatchedAmount = op.montoUsdc; // montoUsdc ahora es el monto BRUTO
                }
            });

            const purchases = dailyOps.filter(op => op.operacion === 'Compra');
            const sales = dailyOps.filter(op => op.operacion === 'Venta');
            currentLotsData.clear();
            let lotCounter = 1;

            // Reiniciamos las compras no pareadas
            purchases.forEach(p => p._unmatchedAmount = p.montoUsdc);

            sales.forEach(sale => {
                const lotId = `L${lotCounter++}`;
                let remainingSaleAmount = sale.montoUsdc; // BRUTO de la venta
                sale.lote = lotId;

                const lot = { id: lotId, ventaOp: sale, montoTotal: sale.montoUsdc, montoConsumido: 0, comprasAsociadas: [], estado: 'activo' };

                for (const purchase of purchases) {
                    if (purchase._unmatchedAmount > 1e-5 && remainingSaleAmount > 1e-5) {
                        const amountToMatch = Math.min(remainingSaleAmount, purchase._unmatchedAmount); // Monto BRUTO a parear

                        const commissionRate = (purchase.adCommissionPercent || 0) / 100;

                        // 1. Ganancia por la diferencia de Tasa (Spread)
                        const revenueVes = amountToMatch * sale.tasa;
                        const costVes = amountToMatch * purchase.tasa;
                        const bankFeeForMatch = (purchase.comisionVes / purchase.montoUsdc) * amountToMatch;
                        const spreadGainInVes = revenueVes - costVes - bankFeeForMatch;
                        const spreadGainInUsdt = spreadGainInVes / purchase.tasa;

                        // 2. Costo por las comisiones de plataforma (Apolo)
                        const costOfSaleCommission = amountToMatch * commissionRate; // Al vender, te CUESTA 0.2% extra
                        const costOfPurchaseCommission = amountToMatch * commissionRate; // Al comprar, RECIBES 0.2% menos (es un costo)
                        const totalCommissionCostInUsdt = costOfSaleCommission + costOfPurchaseCommission;
                        
                        // 3. Ganancia NETA final en USDT para este ciclo
                        const netGainInUsdt = spreadGainInUsdt - totalCommissionCostInUsdt;
                        const netGainInVes = netGainInUsdt * purchase.tasa;

                        // Asignar ganancias a las operaciones correspondientes
                        purchase.usdc += netGainInUsdt;
                        purchase.ves += netGainInVes;
                        
                        const existingLote = purchase.lote ? purchase.lote + ', ' : '';
                        purchase.lote = `${existingLote}${lotId}(${amountToMatch.toFixed(2)})`;
                        
                        remainingSaleAmount -= amountToMatch;
                        purchase._unmatchedAmount -= amountToMatch;
                        
                        lot.montoConsumido += amountToMatch;
                        lot.comprasAsociadas.push({ op: purchase, monto: amountToMatch });
                    }
                    if (remainingSaleAmount < 1e-5) { break; }
                }
                
                if (lot.montoConsumido >= lot.montoTotal - 1e-5) {
                    lot.estado = 'cerrado';
                }
                currentLotsData.set(lotId, lot);
            });

            // Limpieza y cálculo de pendientes
            dailyOps.forEach(op => { delete op._unmatchedAmount; });
            let totalComprado = purchases.reduce((sum, op) => sum + op.montoUsdc, 0);
            let totalVendido = sales.reduce((sum, op) => sum + op.montoUsdc, 0);
            currentPendingData = { recompra: Math.max(0, totalVendido - totalComprado), reventa: Math.max(0, totalComprado - totalVendido), recompraOps: [], reventaOps: [] };
        }
        
        // ===================================================================
// == INICIO: BLOQUE DE CÓDIGO PARA NOTIFICACIONES SONORAS           ==
// ===================================================================

/**
 * Solicita el permiso del usuario para reproducir audio mediante una interacción.
 * Guarda la preferencia en localStorage para no volver a preguntar.
 */
function enableAudio() {
    const sound = document.getElementById('notificationSound');
    sound.play().then(() => {
        sound.pause();
        sound.currentTime = 0;
        localStorage.setItem('soundEnabled', 'true'); 
        showToast('¡Sonido habilitado!', 'success');
        const btn = document.getElementById('enableSoundBtn');
        if (btn) btn.style.display = 'none'; 
    }).catch(error => {
        console.error("Error al habilitar audio:", error);
        showToast('El navegador bloqueó la activación del audio.', 'error');
    });
}

/**
 * Muestra la animación de lote cerrado y reproduce el sonido de notificación.
 * @param {number} profit - La ganancia del lote a mostrar.
 */
function showLotClosedAnimation(profit) {
    const container = document.getElementById('lotClosedAnimation');
    const profitEl = document.getElementById('lotAnimationProfit');
    const sound = document.getElementById('notificationSound');
    
    profitEl.textContent = `${profit.toFixed(2)} VES`;
    
    sound.currentTime = 0;
    sound.play().catch(error => {
       console.log("Audio bloqueado. El usuario debe habilitarlo en Ajustes.", error);
       showToast('Sonido bloqueado. Habilítalo en Ajustes.', 'warning');
   });

    container.classList.remove('hide');
    container.classList.add('show');

    setTimeout(() => {
        container.classList.remove('show');
        container.classList.add('hide');
    }, 3500); // La animación dura 3.5 segundos
}

// --- Funciones Auxiliares para la Lógica de Notificaciones ---

function getShownLots() {
    const shownLotsJSON = localStorage.getItem('shownLotNotifications');
    return shownLotsJSON ? new Set(JSON.parse(shownLotsJSON)) : new Set();
}

function addShownLot(lotId) {
    const shownLots = getShownLots();
    shownLots.add(lotId);
    localStorage.setItem('shownLotNotifications', JSON.stringify(Array.from(shownLots)));
}

function calculateLotProfit(lot) {
    // La nueva lógica suma las ganancias en VES que ya fueron calculadas
    // por el motor FIFO principal para cada compra asociada a este lote.
    return lot.comprasAsociadas.reduce((totalProfit, compra) => {
        // Accedemos a la ganancia en VES de la operación de compra original.
        return totalProfit + (compra.op.ves || 0);
    }, 0);
}

// ===================================================================
// == FIN: BLOQUE DE CÓDIGO PARA NOTIFICACIONES SONORAS             ==
// ===================================================================

        // REEMPLAZA tu función updateSummary con esta:
function updateSummary() {
    loadInitialCapital(currentDate); 
    
    // Filtra las operaciones del día actual ANTES de cualquier cálculo
    const currentOps = operations.filter(op => op.fecha === currentDate);

    if (operations && operations.length > 0) {
        // Ejecuta el motor FIFO. Esto calcula y añade .ves y .usdc a cada operación del día.
        applyFIFOForDate(currentDate); 
        
        const shownLots = getShownLots();
        const newlyClosedLots = [];
        for (const [lotId, lot] of currentLotsData.entries()) {
            if (lot.estado === 'cerrado' && !shownLots.has(lotId)) {
                newlyClosedLots.push(lot);
            }
        }
        if (newlyClosedLots.length > 0) {
            newlyClosedLots.forEach((lot, index) => {
                setTimeout(() => {
                    const profit = calculateLotProfit(lot);
                    if (profit > 0) {
                        showLotClosedAnimation(profit);
                        addShownLot(lot.id); 
                    }
                }, index * 1000); 
            });
        }
        
        const compras = currentOps.filter(op => op.operacion === 'Compra');
        const ventas = currentOps.filter(op => op.operacion === 'Venta');
        const promCompra = compras.length ? compras.reduce((s, o) => s + o.tasa, 0) / compras.length : 0;
        const promVenta = ventas.length ? ventas.reduce((s, o) => s + o.tasa, 0) / ventas.length : 0;
        const brecha = promCompra > 0 ? ((promVenta - promCompra) / promCompra * 100) : 0;

        document.getElementById('promCompra').textContent = promCompra.toFixed(2);
        document.getElementById('promVenta').textContent = promVenta.toFixed(2);
        document.getElementById('brecha').textContent = brecha.toFixed(2) + '%';
        document.getElementById('totalOps').textContent = currentOps.length;
        
        const activeLotsCount = Array.from(currentLotsData.values()).filter(lot => lot.estado === 'activo').length;
        document.getElementById('activeLotsSummary').textContent = activeLotsCount;
        document.getElementById('pendingSummary').textContent = `${(currentPendingData.recompra + currentPendingData.reventa).toFixed(2)} USDC`;
        
        renderOperations();
    }

    // --- LÓGICA DE GANANCIAS CORREGIDA ---
    // En lugar de llamar a una función obsoleta, ahora sumamos las ganancias que applyFIFOForDate ya calculó.
    const gananciasVes = currentOps.reduce((total, op) => total + (op.ves || 0), 0);
    const gananciasUsdc = currentOps.reduce((total, op) => total + (op.usdc || 0), 0);
    
    const [wallyGainsUsdcForDate, wallyGainsUsdForDate] = calculateWallyGainsForPeriod(wallyOperations.filter(op => op.fecha === currentDate));

    document.getElementById('ganancias').innerHTML = `${gananciasVes.toFixed(2)} <span class="text-2xl font-semibold">VES</span>`;
    document.getElementById('ganancias_usdc').innerHTML = `${gananciasUsdc.toFixed(4)} <span class="font-medium">USDC</span>`;
    document.getElementById('wallyDashboardGainsUsdc').innerHTML = `${wallyGainsUsdcForDate.toFixed(2)} <span class="text-xl font-semibold">USDC</span>`;
    document.getElementById('wallyDashboardGainsUsd').innerHTML = `${wallyGainsUsdForDate.toFixed(2)} <span class="text-xl font-semibold">USD</span>`;

    renderDailyGoals(gananciasVes, wallyGainsUsdcForDate, wallyGainsUsdForDate);
}

        function renderDailyGoals(currentVes, currentCrypto, currentUsd) {
            const container = document.getElementById('dailyGoalsContainer');
            container.innerHTML = ''; 

            const goalsToShow = userConfig.dashboardGoals || defaultDashboardGoals;
            const profitGoals = userConfig.profitGoals || defaultProfitGoals;
            
            let visibleGoalsCount = 0;

            if (goalsToShow.ves) {
                visibleGoalsCount++;
                const goal = profitGoals.ves || 0;
                const percentage = Math.min(goal > 0 ? (currentVes / goal) * 100 : 0, 100);
                container.innerHTML += `
                    <div>
                        <div class="flex justify-between items-center text-sm mb-2">
                            <span class="font-medium text-gray-400">Meta Diaria (VES)</span>
                            <span class="font-semibold">${currentVes.toFixed(2)} / ${goal.toFixed(2)} VES</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
            }
            if (goalsToShow.crypto) {
                visibleGoalsCount++;
                 const goal = profitGoals.crypto || 0;
                const percentage = Math.min(goal > 0 ? (currentCrypto / goal) * 100 : 0, 100);
                container.innerHTML += `
                    <div>
                        <div class="flex justify-between items-center text-sm mb-2">
                            <span class="font-medium text-gray-400">Meta Diaria (CRIPTO)</span>
                            <span class="font-semibold">${currentCrypto.toFixed(2)} / ${goal.toFixed(2)} USDC</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-orange-400 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
            }
            if (goalsToShow.usd) {
                visibleGoalsCount++;
                const goal = profitGoals.usd || 0;
                const percentage = Math.min(goal > 0 ? (currentUsd / goal) * 100 : 0, 100);
                 container.innerHTML += `
                    <div>
                        <div class="flex justify-between items-center text-sm mb-2">
                            <span class="font-medium text-gray-400">Meta Diaria (USD)</span>
                            <span class="font-semibold">${currentUsd.toFixed(2)} / ${goal.toFixed(2)} USD</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-purple-400 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
            }
            if (visibleGoalsCount === 0) {
                 container.innerHTML = `<p class="text-center text-sm text-gray-500">No hay metas seleccionadas para mostrar. Ve a ⚙️ Ajustes para configurarlas.</p>`;
            }
        }

        function getRatingIndicator(userName) {
            const avg = calculateAverageRating(userName);
            return avg > 0 ? `<span class="text-xs text-yellow-400 font-bold ml-2">${avg.toFixed(1)} ★</span>` : '';
        }

       // REEMPLAZA ESTA FUNCIÓN COMPLETA EN TU SCRIPT
function renderOperations() {
    const tableBody = document.getElementById('operationsTable');
    const listContainer = document.getElementById('operationsList');
    const emptyState = document.getElementById('reports-empty-state');
    const desktopTableContainer = document.querySelector('#page-reports .table-container');
    const mobileListContainer = document.querySelector('#page-reports .operations-list-container');

    const searchTerm = document.getElementById('searchOperations').value.toLowerCase();
    const filterOperacion = document.getElementById('filterOperacion').value;
    const filterMetodo = document.getElementById('filterMetodoPago').value;
    const filteredOps = operations.filter(op => (op.fecha === currentDate) && (op.usuario.toLowerCase().includes(searchTerm) || (op.referencia && op.referencia.toLowerCase().includes(searchTerm))) && (filterOperacion === '' || op.operacion === filterOperacion) && (filterMetodo === '' || op.metodoPago === filterMetodo));

    // --- LÍNEA AÑADIDA: Forzamos el ordenamiento ---
    // Esto asegura que las operaciones siempre se muestren de la más nueva a la más antigua.
    filteredOps.sort((a, b) => b.timestamp - a.timestamp);
    // --- FIN DE LA LÍNEA AÑADIDA ---

    if (filteredOps.length === 0) {
        emptyState.style.display = 'block';
        desktopTableContainer.style.display = 'none';
        mobileListContainer.style.display = 'none';
        return; 
    } else {
        emptyState.style.display = 'none';
        desktopTableContainer.style.display = ''; 
        mobileListContainer.style.display = '';
    }

    tableBody.innerHTML = '';
    listContainer.innerHTML = '';
    filteredOps.forEach((op, index) => {
        const globalIndex = operations.indexOf(op);

        let cryptoValueToDisplay = op.montoUsdc; 
        if (op.operacion === 'Venta' && op.adCommissionPercent > 0) {
            cryptoValueToDisplay = op.montoUsdc * (1 + (op.adCommissionPercent / 100));
        }

        const relationIndicator = op.operacion === 'Compra' ? `${op.metodoPago} ➡️ ${op.p2pPlatform || ''}` : `${op.metodoPago} ⬅️ ${op.p2pPlatform || ''}`;
        const commissionIndicator = op.adCommissionPercent > 0 ? `<span class="text-xs ${op.operacion === 'Venta' ? 'text-green-400' : 'text-red-400'}">(${op.operacion === 'Venta' ? '+' : '-'}${op.adCommissionPercent}%)</span>` : '';
        const mobileCommissionIndicator = op.adCommissionPercent > 0 ? `<span class="commission">(${op.operacion === 'Venta' ? '+' : '-'}${op.adCommissionPercent}%)</span>` : '';
        
        const tableRowHtml = `<tr class="hover:bg-[var(--surface)]"><td class="text-left"><div class="font-semibold flex items-center">${op.usuario} ${getRatingIndicator(op.usuario)}</div><div class="text-xs text-gray-400">${relationIndicator}</div></td><td>${op.referencia || ''}</td><td>${op.operacion.substring(0,1)}</td><td>${(op.tasa || 0).toFixed(2)}</td><td><div class="flex flex-col items-center">${(cryptoValueToDisplay || 0).toFixed(3)} ${commissionIndicator}</div></td><td>${(op.montoBs || 0).toFixed(2)}</td><td class="font-semibold ${op.ves >= 0 ? 'text-green-400':'text-red-400'}">${(op.ves || 0).toFixed(2)}</td><td class="font-semibold ${op.usdc >= 0 ? 'text-green-400':'text-red-400'}">${(op.usdc || 0).toFixed(4)}</td><td>${op.lote || ''}</td><td><span class="px-2 py-1 text-xs font-semibold rounded-full ${op.estatus === 'Completado' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${op.estatus}</span></td><td><button class="text-blue-400 p-1" onclick="editOperation(${globalIndex})">✏️</button><button class="text-red-400 p-1" onclick="deleteOperation(${globalIndex})">🗑️</button></td></tr>`;
        const cardHtml = `<div class="operation-card ${op.operacion.toLowerCase()}"><div class="card-header"><div class="user-info flex items-center">${op.usuario} ${getRatingIndicator(op.usuario)}<div class="payment-method ml-auto">${relationIndicator}</div></div><span class="status-badge ${op.estatus === 'Completado' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${op.estatus}</span></div><div class="card-grid"><div class="grid-item"><span class="label">Monto USDC</span><span class="value">${(cryptoValueToDisplay || 0).toFixed(3)} ${mobileCommissionIndicator}</span></div><div class="grid-item"><span class="label">Monto BS</span><span class="value">${(op.montoBs || 0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Tasa</span><span class="value">${(op.tasa || 0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Ganancia VES</span><span class="value ${(op.ves || 0) >= 0 ? 'profit-green' : 'profit-red'}">${(op.ves || 0).toFixed(2)}</span></div></div><div class="card-footer"><div class="ref-info">REF: ${op.referencia || 'N/A'}<br>LOTE: ${op.lote || 'N/A'}</div><div class="actions"><button class="action-btn edit" onclick="editOperation(${globalIndex})"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg></button><button class="action-btn delete" onclick="deleteOperation(${globalIndex})"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.033-2.134H8.033c-1.12 0-2.033.954-2.033 2.134v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></button></div></div></div>`;
        tableBody.innerHTML += tableRowHtml;
        listContainer.innerHTML += cardHtml;
    });
}
        
        function openModal() { document.getElementById('operationModal').classList.add('show'); if(editingIndex === -1) clearForm();}
        function closeModal() { document.getElementById('operationModal').classList.remove('show'); editingIndex = -1; }
        function clearForm() { 
            const form = document.getElementById('operationModal'); 
            form.querySelectorAll('input, select').forEach(i => { 
                if(i.type !== 'checkbox') i.value = ''; 
                else i.checked = false; 
            }); 
            document.getElementById('operacion').value = "Compra"; 
            document.getElementById('estatus').value = "En Curso";
            const defaultPlatform = userConfig.p2pPlatforms.find(p => p.isDefault);
            if(defaultPlatform) {
                document.getElementById('p2pPlatformSelect').value = defaultPlatform.name;
            }
            calculateAll(); 
        }

        function loadConfig() { 
            if (!currentUserId) return; 
            return new Promise((resolve, reject) => {
                db.collection('users').doc(currentUserId).collection('settings').doc('userConfig').get().then(doc => { 
                    const defaultConfig = { 
                        profitGoals: defaultProfitGoals,
                        dashboardGoals: defaultDashboardGoals,
                        wallyInitialValue: 0, 
                        p2pPlatforms: [
                            { name: "Syklo", commission: 0, isDefault: true, type: "CRIPTO" },
                            { name: "Apolo", commission: 0.2, isDefault: false, type: "CRIPTO" },
                            { name: "Wally", commission: 0, isDefault: false, type: "USD" },
                            { name: "Zinli", commission: 1.5, isDefault: false, type: "USD" }
                        ],
                        paymentMethods: {
                            ves: ["Pagomovil", "Banesco", "Venezuela", "Bancamiga", "BNC"],
                            usd: ["Wally", "Zinli"]
                        },
                        managedAccounts: [] // <-- AÑADIMOS ESTA LÍNEA
                    };
                    userConfig = doc.exists ? { ...defaultConfig, ...doc.data() } : defaultConfig; 
                    
                    if (!userConfig.profitGoals) userConfig.profitGoals = defaultConfig.profitGoals;
                    if (!userConfig.dashboardGoals) userConfig.dashboardGoals = defaultConfig.dashboardGoals;
                    if (!userConfig.p2pPlatforms) userConfig.p2pPlatforms = defaultConfig.p2pPlatforms;
                    if (!userConfig.paymentMethods) userConfig.paymentMethods = defaultConfig.paymentMethods;
                    if (!userConfig.managedAccounts) userConfig.managedAccounts = defaultConfig.managedAccounts; // <-- AÑADIMOS ESTA LÍNEA

                    applyConfig(); 
                    checkInitialLoadComplete();
                    resolve();
                }).catch(e => { console.error(e); checkInitialLoadComplete(); reject(e); });
            });
        }
        
        function applyConfig() { 
            populatePaymentMethods();
            populateUsdPaymentMethodsFilter();
            populateP2PPlatformSelects();
            updateSummary(); 
            updateWallySummary(); 
        }
        
        function openConfigModal() { 
            document.getElementById('configModal').classList.add('show');
            document.getElementById('goalVes').value = userConfig.profitGoals.ves; 
            document.getElementById('goalCrypto').value = userConfig.profitGoals.crypto; 
            document.getElementById('goalUsd').value = userConfig.profitGoals.usd; 
            updateGoalToggleButtons();
            renderP2PPlatforms();
            renderPaymentMethodsConfig(); 
            renderUsdPaymentMethodsConfig();
        }

        function updateGoalToggleButtons() {
            const toggles = document.querySelectorAll('#dashboardGoalToggles .goal-toggle-btn');
            toggles.forEach(btn => {
                const goalType = btn.dataset.goal;
                if (userConfig.dashboardGoals[goalType]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        document.getElementById('dashboardGoalToggles').addEventListener('click', (e) => {
            if (e.target.classList.contains('goal-toggle-btn')) {
                const goalType = e.target.dataset.goal;
                userConfig.dashboardGoals[goalType] = !userConfig.dashboardGoals[goalType];
                e.target.classList.toggle('active');
            }
        });

        function closeConfigModal() { document.getElementById('configModal').classList.remove('show'); }

        function saveConfig() {
            const saveBtn = document.getElementById('saveConfigBtn'); 
            saveBtn.classList.add('loading'); 

            userConfig.profitGoals.ves = parseFloat(document.getElementById('goalVes').value) || defaultProfitGoals.ves; 
            userConfig.profitGoals.crypto = parseFloat(document.getElementById('goalCrypto').value) || defaultProfitGoals.crypto; 
            userConfig.profitGoals.usd = parseFloat(document.getElementById('goalUsd').value) || defaultProfitGoals.usd; 

            db.collection('users').doc(currentUserId).collection('settings').doc('userConfig').set(userConfig, {merge: true}).then(() => { 
                applyConfig(); 
                showToast('Configuración guardada.', 'success'); 
            }).catch(e => {
                showToast('Error al guardar configuración.', 'error');
            }).finally(() => {
                saveBtn.classList.remove('loading'); 
                closeConfigModal();
            });
        }

        function renderP2PPlatforms() {
            const container = document.getElementById('p2pPlatformsList');
            container.innerHTML = userConfig.p2pPlatforms.map((platform, index) => {
                let typeColor = 'text-gray-400 border-gray-600';
                if (platform.type === 'CRIPTO') typeColor = 'text-orange-400 border-orange-400/50';
                if (platform.type === 'USD') typeColor = 'text-green-400 border-green-400/50';
                if (platform.type === 'VES') typeColor = 'text-blue-400 border-blue-400/50';

                return `
                <div class="platform-item">
                    <input type="radio" name="defaultPlatform" onchange="setDefaultP2PPlatform(${index})" ${platform.isDefault ? 'checked' : ''}>
                    <div class="platform-item-info">
                        <div class="flex items-center gap-2">
                            <span class="platform-item-name">${platform.name}</span>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full border ${typeColor}">${platform.type || 'SIN TIPO'}</span>
                        </div>
                        <div class="platform-item-details">Comisión: ${platform.commission}% ${platform.isDefault ? '<strong>(Predeterminada)</strong>' : ''}</div>
                    </div>
                    <div class="platform-item-actions">
                        <button onclick="editP2PPlatform(${index})">✏️</button>
                        <button onclick="deleteP2PPlatform(${index})">🗑️</button>
                    </div>
                </div>
            `}).join('');
        }

        function addOrUpdateP2PPlatform() {
            const nameInput = document.getElementById('newPlatformName');
            const commissionInput = document.getElementById('newPlatformCommission');
            const typeInput = document.getElementById('newPlatformType');
            const indexInput = document.getElementById('editingPlatformIndex');
            
            const name = nameInput.value.trim();
            const commission = parseFloat(commissionInput.value) || 0;
            const type = typeInput.value;
            const index = parseInt(indexInput.value);

            if (!name) {
                showToast('El nombre de la plataforma es requerido.', 'warning');
                return;
            }

            if (index > -1) {
                userConfig.p2pPlatforms[index].name = name;
                userConfig.p2pPlatforms[index].commission = commission;
                userConfig.p2pPlatforms[index].type = type;
            } else {
                 if (userConfig.p2pPlatforms.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    showToast('Ya existe una plataforma con ese nombre.', 'warning');
                    return;
                }
                userConfig.p2pPlatforms.push({ name, commission, type, isDefault: userConfig.p2pPlatforms.length === 0 });
            }

            nameInput.value = '';
            commissionInput.value = '';
            typeInput.value = 'CRIPTO';
            indexInput.value = -1;
            document.getElementById('platformFormTitle').textContent = 'Añadir Nueva Plataforma';
            document.getElementById('addPlatformBtn').textContent = 'Añadir Plataforma';
            
            renderP2PPlatforms();
        }
        
        function editP2PPlatform(index) {
            const platform = userConfig.p2pPlatforms[index];
            document.getElementById('newPlatformName').value = platform.name;
            document.getElementById('newPlatformCommission').value = platform.commission;
            document.getElementById('newPlatformType').value = platform.type || 'CRIPTO';
            document.getElementById('editingPlatformIndex').value = index;
            document.getElementById('platformFormTitle').textContent = 'Editando Plataforma';
            document.getElementById('addPlatformBtn').textContent = 'Actualizar';
        }

        function deleteP2PPlatform(index) {
            // --- INICIO DE LA CORRECCIÓN ---
            // Nueva validación: Impide borrar la última plataforma existente.
            if (userConfig.p2pPlatforms.length === 1) {
                showToast('No puedes eliminar la última plataforma. Debes tener al menos una.', 'error');
                return;
            }
            // --- FIN DE LA CORRECCIÓN ---

            // Validación existente: Impide borrar la plataforma predeterminada si hay más de una.
            if (userConfig.p2pPlatforms[index].isDefault && userConfig.p2pPlatforms.length > 1) {
                showToast('No puedes eliminar la plataforma predeterminada. Elige otra primero.', 'error');
                return;
            }
            
            if (!confirm(`¿Seguro que quieres eliminar la plataforma "${userConfig.p2pPlatforms[index].name}"?`)) return;
            
            userConfig.p2pPlatforms.splice(index, 1);
            renderP2PPlatforms();
        }

        function setDefaultP2PPlatform(index) {
            userConfig.p2pPlatforms.forEach((p, i) => {
                p.isDefault = i === index;
            });
            renderP2PPlatforms();
        }

        function populateP2PPlatformSelects() {
            const platforms = userConfig.p2pPlatforms || [];
            const optionsHtml = platforms.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            document.getElementById('p2pPlatformSelect').innerHTML = optionsHtml;
        }
        
        function renderPaymentMethodsConfig() {
            const container = document.getElementById('paymentMethodsList');
            container.innerHTML = (userConfig.paymentMethods.ves || []).map((method, index) => `<div class="method-tag"><span>${method}</span><button class="delete-method-btn" onclick="deletePaymentMethod(${index})">&times;</button></div>`).join('');
        }
        
        function addPaymentMethod() {
            const input = document.getElementById('newPaymentMethod');
            const newMethod = input.value.trim();
            if (!newMethod) return;
            if(!userConfig.paymentMethods.ves) userConfig.paymentMethods.ves = [];
            userConfig.paymentMethods.ves.push(newMethod);
            input.value = '';
            renderPaymentMethodsConfig();
        }

        function deletePaymentMethod(index) {
            userConfig.paymentMethods.ves.splice(index, 1);
            renderPaymentMethodsConfig();
        }
        
        function renderUsdPaymentMethodsConfig() {
            const container = document.getElementById('usdPaymentMethodsList');
            container.innerHTML = (userConfig.paymentMethods.usd || []).map((method, index) => `<div class="method-tag"><span>${method}</span><button class="delete-method-btn" onclick="deleteUsdPaymentMethod(${index})">&times;</button></div>`).join('');
        }
        
        function addUsdPaymentMethod() {
            const input = document.getElementById('newUsdPaymentMethod');
            const newMethod = input.value.trim();
            if (!newMethod) return;
            if(!userConfig.paymentMethods.usd) userConfig.paymentMethods.usd = [];
            userConfig.paymentMethods.usd.push(newMethod);
            input.value = '';
            renderUsdPaymentMethodsConfig();
        }

        function deleteUsdPaymentMethod(index) {
            userConfig.paymentMethods.usd.splice(index, 1);
            renderUsdPaymentMethodsConfig();
        }

        function populatePaymentMethods() {
            const methods = userConfig.paymentMethods ? userConfig.paymentMethods.ves || [] : []; 
            const mainSelect = document.getElementById('metodoPago'); 
            const filterSelect = document.getElementById('filterMetodoPago'); 
            mainSelect.innerHTML = methods.map(m => `<option value="${m}">${m}</option>`).join(''); 
            filterSelect.innerHTML = '<option value="">Todos los Métodos</option>' + methods.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function openInitialCapitalModal() {
            document.getElementById('capitalModalDate').textContent = currentDate;
            const formContainer = document.getElementById('initialCapitalForm');
            formContainer.innerHTML = '<div class="loader mx-auto"></div>'; // Muestra un loader mientras carga

            const accounts = userConfig.managedAccounts || [];
            
            // Si no hay cuentas, muestra un mensaje
            if (accounts.length === 0) {
                formContainer.innerHTML = '<p class="text-center text-sm text-gray-500 py-4">No has añadido ninguna cuenta. Usa el formulario de arriba para empezar.</p>';
                document.getElementById('initialCapitalModal').classList.add('show');
                return;
            }

            // Carga el capital del día actual para pre-rellenar los campos
            const todaysCapital = currentDayCapital && currentDayCapital.balances ? currentDayCapital.balances : [];

            let formHtml = '';
            accounts.forEach(account => {
                // Busca si ya hay un monto guardado para esta cuenta hoy
                const existingEntry = todaysCapital.find(entry => entry.accountId === account.id);
                const currentValue = existingEntry ? existingEntry.amount : '';

                formHtml += `
                    <div class="grid grid-cols-[1fr_120px_auto] items-center gap-3">
                        <label for="capital-${account.id}" class="font-medium text-sm">
                            ${account.name} <span class="text-xs text-gray-400">(${account.currency})</span>
                        </label>
                        <input type="number" step="0.01" id="capital-${account.id}" 
                               data-account-id="${account.id}"
                               value="${currentValue}"
                               placeholder="0.00" class="form-field-grid text-right">
                        <button class="text-red-400 p-2 hover:bg-red-500/10 rounded-full" onclick="deleteManagedAccount('${account.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.033-2.134H8.033c-1.12 0-2.033.954-2.033 2.134v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                        </button>
                    </div>
                `;
            });
            
            formContainer.innerHTML = formHtml;
            document.getElementById('initialCapitalModal').classList.add('show');
        }

        function closeInitialCapitalModal() {
                    document.getElementById('initialCapitalModal').classList.remove('show');
        }
        
        function addManagedAccount() {
            const nameInput = document.getElementById('newAccountName');
            const currencyInput = document.getElementById('newAccountCurrency');
            const name = nameInput.value.trim();
            const currency = currencyInput.value.trim().toUpperCase();

            if (!name || !currency) {
                showToast('El nombre y la moneda son obligatorios.', 'warning');
                return;
            }

            const newAccount = {
                id: Date.now().toString(), // ID único basado en el tiempo
                name: name,
                currency: currency
            };

            userConfig.managedAccounts.push(newAccount);
            saveConfigAndRefreshCapitalModal('Cuenta añadida exitosamente.');
            
            // Limpiar inputs
            nameInput.value = '';
            currencyInput.value = '';
            nameInput.focus();
        }

       function deleteManagedAccount(accountId) {
            if (!confirm('¿Estás seguro de que deseas eliminar esta cuenta de forma permanente?')) {
                return;
            }

            const accountIndex = userConfig.managedAccounts.findIndex(acc => acc.id === accountId);
            if (accountIndex > -1) {
                userConfig.managedAccounts.splice(accountIndex, 1);
                saveConfigAndRefreshCapitalModal('Cuenta eliminada.');
            }
        }
        
        // Nueva función de ayuda para guardar la configuración y refrescar el modal
        function saveConfigAndRefreshCapitalModal(successMessage) {
            db.collection('users').doc(currentUserId).collection('settings').doc('userConfig').set(userConfig, {merge: true})
            .then(() => {
                showToast(successMessage, 'success');
                // Volvemos a abrir/refrescar el modal para que se vean los cambios
                openInitialCapitalModal(); 
            })
            .catch(e => {
                showToast('Error al guardar la configuración.', 'error');
            });
        }

        function saveInitialCapital() {
            const saveBtn = document.getElementById('saveCapitalBtn');
            saveBtn.classList.add('loading');

            const inputs = document.querySelectorAll('#initialCapitalForm input[type="number"]');
            const balances = [];

            inputs.forEach(input => {
                const amount = parseFloat(input.value) || 0;
                if (amount > 0) {
                    balances.push({
                        accountId: input.dataset.accountId,
                        amount: amount
                    });
                }
            });

            const dataToSave = {
                date: currentDate,
                balances: balances
            };

            db.collection('users').doc(currentUserId).collection('dailyCapital').doc(currentDate).set(dataToSave)
                .then(() => {
                    // Actualizamos la variable local con los nuevos datos
                    currentDayCapital = dataToSave; 
                    displayInitialCapitalSummary();
                    closeInitialCapitalModal();
                    showToast('Capital inicial guardado.', 'success');
                })
                .catch(e => {
                    console.error("Error al guardar capital: ", e);
                    showToast('Error al guardar el capital.', 'error');
                })
                .finally(() => {
                    saveBtn.classList.remove('loading');
                });
        }
        
        async function loadInitialCapital(date) {
            if (!currentUserId) return;
            try {
                const docRef = db.collection('users').doc(currentUserId).collection('dailyCapital').doc(date);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    currentDayCapital = docSnap.data();
                } else {
                    currentDayCapital = null;
                }
            } catch (error) {
                console.error("Error cargando capital inicial:", error);
                currentDayCapital = null;
            }
            displayInitialCapitalSummary();
        }
        
        function displayInitialCapitalSummary() {
            const container = document.getElementById('initialCapitalSummary');
            
            // Caso 1: No hay capital registrado para hoy
            if (!currentDayCapital || !currentDayCapital.balances || currentDayCapital.balances.length === 0) {
                container.innerHTML = `<p class="text-gray-500">No hay capital registrado para hoy.</p>`;
                return;
            }

            // Objeto para acumular los totales por moneda
            const totalsByCurrency = {};
            
            // Mapeamos los Ids a sus cuentas para una búsqueda rápida
            const accountsMap = new Map(userConfig.managedAccounts.map(acc => [acc.id, acc]));

            // Llenamos el objeto de totales
            currentDayCapital.balances.forEach(balance => {
                const account = accountsMap.get(balance.accountId);
                if (account) {
                    const currency = account.currency;
                    if (!totalsByCurrency[currency]) {
                        totalsByCurrency[currency] = 0;
                    }
                    totalsByCurrency[currency] += balance.amount;
                }
            });

            // Caso 2: Hay datos pero todos los montos son cero
            if (Object.keys(totalsByCurrency).length === 0) {
                 container.innerHTML = `<p class="text-gray-500">No hay capital registrado para hoy.</p>`;
                return;
            }

            // Preparamos el HTML final
            let summaryHtml = '<div class="grid grid-cols-3 gap-x-4 gap-y-2">';
            
            // Damos un orden de prioridad a las monedas más comunes
            const currencyOrder = ['USDT', 'USDC', 'USD', 'VES'];
            const sortedCurrencies = Object.keys(totalsByCurrency).sort((a, b) => {
                const indexA = currencyOrder.indexOf(a);
                const indexB = currencyOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b); // Alfabético para los no listados
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            sortedCurrencies.forEach(currency => {
                const total = totalsByCurrency[currency];
                let typeColor = 'text-gray-200';
                if (currency.includes('USD')) typeColor = 'text-green-400';
                if (currency === 'VES') typeColor = 'text-blue-400';

                summaryHtml += `
                    <div class="text-center">
                        <span class="text-xs text-gray-400">${currency}</span>
                        <p class="font-bold text-lg ${typeColor}">${total.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                    </div>
                `;
            });

            summaryHtml += '</div>';
            container.innerHTML = summaryHtml;
        }

        document.getElementById('selectedDate').addEventListener('change', function() { currentDate = this.value; updateSummary(); });
        document.getElementById('wallySelectedDate').addEventListener('change', function() { currentWallyDate = this.value; updateWallySummary(); });
        document.getElementById('addPlatformBtn').addEventListener('click', addOrUpdateP2PPlatform);
        
        function showToast(message, type = 'info') { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove(), {once: true}); }, 3000); }
        
        function openBankBreachModal() { renderBankBreachesCards(); document.getElementById('bankBreachModal').classList.add('show'); }
        function closeBankBreachModal() { document.getElementById('bankBreachModal').classList.remove('show'); }
        function openLotDetailsModal() { renderLotDetailsCards(); document.getElementById('lotDetailsModal').classList.add('show'); }
        function closeLotDetailsModal() { document.getElementById('lotDetailsModal').classList.remove('show'); }
        function openPendingDetailsModal() { renderPendingDetails(); document.getElementById('pendingDetailsModal').classList.add('show'); }
        function closePendingDetailsModal() { document.getElementById('pendingDetailsModal').classList.remove('show'); }
        
        function openGainsSummaryModal() {
    const formatDate = (dateObj) => { const year = dateObj.getFullYear(); const month = String(dateObj.getMonth() + 1).padStart(2, '0'); const day = String(dateObj.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
    const today = new Date(); const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1)); const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const todayStr = formatDate(today), startOfWeekStr = formatDate(startOfWeek), startOfMonthStr = formatDate(startOfMonth);
    
    // Filtramos las operaciones para cada período
    const dailyOps = operations.filter(op => op.fecha === todayStr);
    const weeklyOps = operations.filter(op => op.fecha >= startOfWeekStr && op.fecha <= todayStr);
    const monthlyOps = operations.filter(op => op.fecha >= startOfMonthStr && op.fecha <= todayStr);
    
    // Usamos la nueva función centralizada para obtener los totales correctos
    const [dailyGainsVes, dailyGainsUsdc] = calculateFIFOGainsForOps(dailyOps);
    const [weeklyGainsVes, weeklyGainsUsdc] = calculateFIFOGainsForOps(weeklyOps);
    const [monthlyGainsVes, monthlyGainsUsdc] = calculateFIFOGainsForOps(monthlyOps);
    
    // Actualizamos el contenido del modal
    document.getElementById('summaryGananciasHoyVes').textContent = `${dailyGainsVes.toFixed(2)} VES`;
    document.getElementById('summaryGananciasHoyUsdc').textContent = `${dailyGainsUsdc.toFixed(4)} USDC`;
    document.getElementById('summaryGananciasSemanaVes').textContent = `${weeklyGainsVes.toFixed(2)} VES`;
    document.getElementById('summaryGananciasSemanaUsdc').textContent = `${weeklyGainsUsdc.toFixed(4)} USDC`;
    document.getElementById('summaryGananciasMesVes').textContent = `${monthlyGainsVes.toFixed(2)} VES`;
    document.getElementById('summaryGananciasMesUsdc').textContent = `${monthlyGainsUsdc.toFixed(4)} USDC`;
    
    // Mostramos el modal
    document.getElementById('gainsSummaryModal').classList.add('show');
}

        function closeGainsSummaryModal() { document.getElementById('gainsSummaryModal').classList.remove('show'); }

        function openWallyGainsSummaryModal() {
            const formatDate = (dateObj) => { const year = dateObj.getFullYear(); const month = String(dateObj.getMonth() + 1).padStart(2, '0'); const day = String(dateObj.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
            const today = new Date(); const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1)); const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const todayStr = formatDate(today), startOfWeekStr = formatDate(startOfWeek), startOfMonthStr = formatDate(startOfMonth);
            const dailyOps = wallyOperations.filter(op => op.fecha === todayStr); const weeklyOps = wallyOperations.filter(op => op.fecha >= startOfWeekStr && op.fecha <= todayStr); const monthlyOps = wallyOperations.filter(op => op.fecha >= startOfMonthStr && op.fecha <= todayStr);
            const [dailyGainsUsdc, dailyGainsUsd] = calculateWallyGainsForPeriod(dailyOps); const [weeklyGainsUsdc, weeklyGainsUsd] = calculateWallyGainsForPeriod(weeklyOps); const [monthlyGainsUsdc, monthlyGainsUsd] = calculateWallyGainsForPeriod(monthlyOps);
            document.getElementById('summaryWallyGananciasHoyUsdc').textContent = `${dailyGainsUsdc.toFixed(2)} USDC`; document.getElementById('summaryWallyGananciasHoyUsd').textContent = `${dailyGainsUsd.toFixed(2)} USD`;
            document.getElementById('summaryWallyGananciasSemanaUsdc').textContent = `${weeklyGainsUsdc.toFixed(2)} USDC`; document.getElementById('summaryWallyGananciasSemanaUsd').textContent = `${weeklyGainsUsd.toFixed(2)} USD`;
            document.getElementById('summaryWallyGananciasMesUsdc').textContent = `${monthlyGainsUsdc.toFixed(2)} USDC`; document.getElementById('summaryWallyGananciasMesUsd').textContent = `${monthlyGainsUsd.toFixed(2)} USD`;
            document.getElementById('wallyGainsSummaryModal').classList.add('show');
        }
        function closeWallyGainsSummaryModal() { document.getElementById('wallyGainsSummaryModal').classList.remove('show'); }

        function calculateBankBreaches() {
            const currentOps = operations.filter(op => op.fecha === currentDate), bankData = {};
            currentOps.forEach(op => { if (!bankData[op.metodoPago]) bankData[op.metodoPago] = { compras: [], ventas: [] }; if (op.operacion === 'Compra') bankData[op.metodoPago].compras.push(op.tasa); else if (op.operacion === 'Venta') bankData[op.metodoPago].ventas.push(op.tasa); });
            const results = [];
            for (const method in bankData) { const { compras, ventas } = bankData[method]; const promCompra = compras.length > 0 ? compras.reduce((a, b) => a + b, 0) / compras.length : 0; const promVenta = ventas.length > 0 ? ventas.reduce((a, b) => a + b, 0) / ventas.length : 0; const brecha = promVenta > 0 && promCompra > 0 ? ((promVenta - promCompra) / promCompra * 100) : 0; results.push({ metodo: method, promCompra, promVenta, brecha }); }
            return results;
        }

        function renderBankBreachesCards() {
            const container = document.getElementById('bankBreachCards'), bankBreaches = calculateBankBreaches();
            if (bankBreaches.length === 0) { container.innerHTML = '<p class="text-center text-gray-400">No hay datos.</p>'; return; }
            container.innerHTML = bankBreaches.map(d => `<div class="info-card"><div class="info-card-title">${d.metodo}</div><div class="info-card-value" style="color: ${d.brecha > 0 ? 'var(--success)' : 'var(--danger)'}">${d.brecha.toFixed(2)}%</div><div class="info-card-details">C:${d.promCompra.toFixed(2)}|V:${d.promVenta.toFixed(2)}</div></div>`).join('');
        }
        function renderLotDetailsCards() {
            const container = document.getElementById('lotDetailsCards');
            const activeLots = Array.from(currentLotsData.values()).filter(l => l.estado === 'activo');
            if(activeLots.length === 0) { container.innerHTML = '<p class="text-center text-gray-400">No hay lotes activos.</p>'; return; }
            container.innerHTML = activeLots.map(lot => { const percentConsumed = lot.montoTotal > 0 ? (lot.montoConsumido / lot.montoTotal) * 100 : 0; const restante = lot.montoTotal - lot.montoConsumido; return `<div class="info-card p-4 flex flex-col justify-between"><div><div class="info-card-title text-base">Lote ${lot.id}</div><div class="info-card-value text-2xl" style="color: var(--primary); margin-bottom: 0.75rem;">${percentConsumed.toFixed(1)}% <span class="text-lg font-normal">Consumido</span></div><div class="info-card-details space-y-1 text-left"><div class="flex justify-between"><span>Total:</span> <strong class="font-mono">${lot.montoTotal.toFixed(2)} USDC</strong></div><div class="flex justify-between"><span>Consumido:</span> <strong class="font-mono text-green-400">${lot.montoConsumido.toFixed(2)} USDC</strong></div><div class="flex justify-between"><span>Restante:</span> <strong class="font-mono text-yellow-400">${restante.toFixed(2)} USDC</strong></div></div></div><div class="w-full bg-gray-700 rounded-full h-2.5 mt-4"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${percentConsumed}%"></div></div></div>`; }).join('');
        }
        function renderPendingDetails() {
            document.getElementById('pendingRepurchaseSummary').textContent = `${currentPendingData.recompra.toFixed(2)} USDC`;
            document.getElementById('pendingResaleSummary').textContent = `${currentPendingData.reventa.toFixed(2)} USDC`;
            const repurchaseList = document.getElementById('pendingRepurchaseList');
            repurchaseList.innerHTML = currentPendingData.recompra === 0 ? '<p class="text-xs text-gray-400">No hay recompra pendiente.</p>' : `<div class="operation-list-item">Monto Total: <span class="font-semibold">${currentPendingData.recompra.toFixed(2)} USDC</span></div>`;
            const resaleList = document.getElementById('pendingResaleList');
            resaleList.innerHTML = currentPendingData.reventa === 0 ? '<p class="text-xs text-gray-400">No hay reventa pendiente.</p>' : `<div class="operation-list-item">Monto Total: <span class="font-semibold">${currentPendingData.reventa.toFixed(2)} USDC</span></div>`;
        }
        
        function openWallyModal(index = -1) { editingWallyIndex = index; document.getElementById('wallyModalTitle').textContent = index > -1 ? 'Editar Operación USD' : 'Agregar Nueva Operación'; renderWallyForm(index > -1 ? wallyOperations[index] : {}); document.getElementById('wallyModal').classList.add('show'); }
        function closeWallyModal() { document.getElementById('wallyModal').classList.remove('show'); }
        
        function renderWallyForm(op = {}) {
        const platforms = userConfig.p2pPlatforms || [];
        const defaultPlatform = userConfig.p2pPlatforms.find(p => p.isDefault);
        const platformOptions = platforms.map(p => {
            const isSelected = op.platform ? op.platform === p.name : (defaultPlatform && defaultPlatform.name === p.name);
            return `<option value="${p.name}" ${isSelected ? 'selected' : ''}>${p.name}</option>`;
        }).join('');

        const usdMethods = userConfig.paymentMethods.usd || [];
        const usdMethodOptions = usdMethods.map(m => `<option value="${m}" ${op.metodoPago === m ? 'selected' : ''}>${m}</option>`).join('');

        document.getElementById('wallyFormContent').innerHTML = `
            <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-5 items-center">
                <label class="text-sm text-gray-400 justify-self-end">Usuario</label> <input type="text" id="wallyUsuario" value="${op.usuario || ''}" class="form-field-grid">
                <label class="text-sm text-gray-400 justify-self-end">Referencia</label> <input type="text" id="wallyReferencia" value="${op.referencia || ''}" class="form-field-grid">
                <label class="text-sm text-gray-400 justify-self-end">Método de Pago</label> <select id="wallyMetodoPago" class="form-field-grid">${usdMethodOptions}</select>
                <label class="text-sm text-gray-400 justify-self-end">Plataforma P2P</label> <select id="wallyPlatform" onchange="updateWallyCalculations()" class="form-field-grid">${platformOptions}</select>
                <label class="text-sm text-gray-400 justify-self-end">Operación</label> <select id="wallyOperacion" onchange="updateWallyFormFields()" class="form-field-grid"><option value="Compra" ${op.operacion === 'Compra' || !op.operacion ? 'selected' : ''}>Compra (Recibo Cripto)</option><option value="Venta" ${op.operacion === 'Venta' ? 'selected' : ''}>Venta (Recibo USD)</option></select>
                <hr class="border-gray-700 my-2 col-span-2">

                <label class="text-sm text-gray-400 justify-self-end wally-compra-field">Recibo Cripto</label> <input type="number" id="reciboUsdc" value="${op.reciboUsdc || ''}" onkeyup="updateWallyCalculations()" class="form-field-grid wally-compra-field">
                <label class="text-sm text-gray-400 justify-self-end wally-compra-field">Tasa Compra</label> <input type="number" id="tasaCompra" value="${op.tasaCompra || ''}" onkeyup="updateWallyCalculations()" class="form-field-grid wally-compra-field">
                <label class="text-sm text-gray-500 justify-self-end wally-compra-field">Envío USD</label> <input type="number" id="envioUsd" value="${op.envioUsd || ''}" readonly class="form-field-grid bg-gray-800 border-gray-600 wally-compra-field">
                <label class="text-sm text-gray-500 justify-self-end wally-compra-field">Comisión Cripto</label> <input type="number" id="commissionUsdc" value="${op.commissionAmount || ''}" readonly class="form-field-grid bg-gray-800 border-gray-600 wally-compra-field">
                <label class="text-sm text-green-400 font-bold justify-self-end wally-compra-field">Ganancia Neta</label> <input type="number" id="gananciaUsdc" value="${op.gananciaUsdc || ''}" readonly class="form-field-grid bg-gray-800 border-green-500/50 wally-compra-field">

                <label class="text-sm text-gray-400 justify-self-end wally-venta-field">Envío CRIPTO</label> <input type="number" id="envioUsdcVenta" value="${op.envioUsdc || ''}" onkeyup="updateWallyCalculations()" class="form-field-grid wally-venta-field">
                <label class="text-sm text-gray-400 justify-self-end wally-venta-field">Tasa Venta</label> <input type="number" id="tasaVenta" value="${op.tasaVenta || ''}" onkeyup="updateWallyCalculations()" class="form-field-grid wally-venta-field">
                <label class="text-sm text-gray-500 justify-self-end wally-venta-field">Recibo USD</label> <input type="number" id="reciboUsdCalculado" value="${op.reciboUsd || ''}" readonly class="form-field-grid bg-gray-800 border-gray-600 wally-venta-field">
                <label class="text-sm text-gray-500 justify-self-end wally-venta-field">Comisión Cripto</label> <input type="number" id="commissionUsd" value="${op.commissionAmount || ''}" readonly class="form-field-grid bg-gray-800 border-gray-600 wally-venta-field">
                <label class="text-sm text-green-400 font-bold justify-self-end wally-venta-field">Ganancia Neta</label> <input type="number" id="gananciaUsd" value="${op.gananciaUsd || ''}" readonly class="form-field-grid bg-gray-800 border-green-500/50 wally-venta-field">
            </div>
        `;
        updateWallyFormFields();
    }

        function updateWallyFormFields() {
            const operacion = document.getElementById('wallyOperacion').value;
            document.querySelectorAll('.wally-compra-field').forEach(el => el.style.display = operacion === 'Compra' ? '' : 'none');
            document.querySelectorAll('.wally-venta-field').forEach(el => el.style.display = operacion === 'Venta' ? '' : 'none');
            updateWallyCalculations();
        }

        function updateWallyCalculations() {
            const operacion = document.getElementById('wallyOperacion').value;
            const platformName = document.getElementById('wallyPlatform').value;
            const platform = userConfig.p2pPlatforms.find(p => p.name === platformName);
            const commissionRate = platform ? platform.commission : 0;
            
            if (operacion === 'Compra') {
                const r = parseFloat(document.getElementById('reciboUsdc').value) || 0;
                const t = parseFloat(document.getElementById('tasaCompra').value) || 0;
                const envio = r * t;
                const grossGain = r - envio;
                const commissionAmount = r * (commissionRate / 100);
                const netGain = grossGain - commissionAmount;

                document.getElementById('envioUsd').value = envio.toFixed(2);
                document.getElementById('commissionUsdc').value = commissionAmount.toFixed(4);
                document.getElementById('gananciaUsdc').value = netGain.toFixed(4);
            } else { // Venta
                const e = parseFloat(document.getElementById('envioUsdcVenta').value) || 0;
                const t = parseFloat(document.getElementById('tasaVenta').value) || 0;
                const recibo = e * t;
                const grossGain = recibo - e;
                const commissionAmount = e * (commissionRate / 100);
                const netGain = grossGain - commissionAmount;

                document.getElementById('reciboUsdCalculado').value = recibo.toFixed(2);
                document.getElementById('commissionUsd').value = commissionAmount.toFixed(4);
                document.getElementById('gananciaUsd').value = netGain.toFixed(4);
            }
        }
        
        function saveWallyOperation() {
            if (!currentUserId) return;
            const saveBtn = document.getElementById('saveWallyBtn'); 
            saveBtn.classList.add('loading');

            const isEditing = editingWallyIndex > -1;
            const operacion = document.getElementById('wallyOperacion').value;
            let opData = { 
                usuario: document.getElementById('wallyUsuario').value, 
                referencia: document.getElementById('wallyReferencia').value, 
                operacion, 
                platform: document.getElementById('wallyPlatform').value,
                metodoPago: document.getElementById('wallyMetodoPago').value,
                fecha: currentWallyDate, 
                timestamp: Date.now() 
            };
            if (operacion === 'Compra') { Object.assign(opData, { reciboUsdc: parseFloat(document.getElementById('reciboUsdc').value), tasaCompra: parseFloat(document.getElementById('tasaCompra').value), envioUsd: parseFloat(document.getElementById('envioUsd').value), gananciaUsdc: parseFloat(document.getElementById('gananciaUsdc').value), commissionAmount: parseFloat(document.getElementById('commissionUsdc').value) }); }
            else { Object.assign(opData, { envioUsdc: parseFloat(document.getElementById('envioUsdcVenta').value), tasaVenta: parseFloat(document.getElementById('tasaVenta').value), reciboUsd: parseFloat(document.getElementById('reciboUsdCalculado').value), gananciaUsd: parseFloat(document.getElementById('gananciaUsd').value), commissionAmount: parseFloat(document.getElementById('commissionUsd').value) }); }

            if (!opData.usuario || !opData.metodoPago) { 
                showToast('Usuario y Método de Pago son requeridos.', 'error'); 
                saveBtn.classList.remove('loading'); 
                return; 
            }

            const opId = isEditing ? wallyOperations[editingWallyIndex].id : db.collection('users').doc(currentUserId).collection('wallyOperations').doc().id;
            db.collection('users').doc(currentUserId).collection('wallyOperations').doc(opId).set(opData, { merge: true }).then(() => { 
                closeWallyModal(); 
                showToast('Op. USD guardada.', 'success');
                if (!isEditing) {
                    lastSavedUser = opData.usuario;
                    lastSavedOperationType = 'wally';
                    openRatingModal(opData.usuario);
                }
            }).catch(e => {
                showToast('Error.', 'error');
            }).finally(() => {
                saveBtn.classList.remove('loading');
            });
        }

        // REEMPLAZA tu función updateWallySummary con esta:
function updateWallySummary() {
    if(!wallyOperations) return;
    const currentOps = wallyOperations.filter(op => op.fecha === currentWallyDate);
    const [totalGananciaUsdc, totalGananciaUsd] = calculateWallyGainsForPeriod(currentOps);
    wallyTotalGains = { usdc: totalGananciaUsdc, usd: totalGananciaUsd };

    // --- LÍNEA AÑADIDA ---
    // Esta es la línea que faltaba para actualizar la tarjeta de ganancias en la página.
    const wallyGananciasEl = document.getElementById("wallyGanancias");
    if (wallyGananciasEl) {
        wallyGananciasEl.innerHTML = `
            <span class="text-orange-400">${totalGananciaUsdc.toFixed(2)}</span> <span class="text-xl font-semibold">USDC</span> / 
            <span class="text-purple-400">${totalGananciaUsd.toFixed(2)}</span> <span class="text-xl font-semibold">USD</span>`;
    }
    // --- FIN DE LA LÍNEA AÑADIDA ---
            
    renderWallyTables();
    updateSummary();
    // Se eliminó la llamada a updateSummary() que estaba aquí para evitar bucles.
}

        // REEMPLAZA tu función renderWallyTables con esta:
function renderWallyTables() {
    const searchTerm = document.getElementById('searchWallyOperations').value.toLowerCase();
    const filterOperacion = document.getElementById('filterWallyOperacion').value;
    const filterMetodo = document.getElementById('filterWallyMetodoPago').value;

    const filteredOps = wallyOperations.filter(op => {
        const searchMatch = op.usuario.toLowerCase().includes(searchTerm) || (op.referencia && op.referencia.toLowerCase().includes(searchTerm));
        const operacionMatch = filterOperacion === '' || op.operacion === filterOperacion;
        const metodoMatch = filterMetodo === '' || op.metodoPago === filterMetodo;
        return op.fecha === currentWallyDate && searchMatch && operacionMatch && metodoMatch;
    });

    const compraTableBody = document.getElementById('wallyCompraTable'), compraListContainer = document.getElementById('wallyCompraList');
    const ventaTableBody = document.getElementById('wallyVentaTable'), ventaListContainer = document.getElementById('wallyVentaList');
    const comprasEmptyState = document.getElementById('wally-compras-empty-state');
    const ventasEmptyState = document.getElementById('wally-ventas-empty-state');
    const comprasCardContainer = document.querySelector('#wallyCompraList').closest('.card');
    const ventasCardContainer = document.querySelector('#wallyVentaList').closest('.card');
    
    compraTableBody.innerHTML = ''; compraListContainer.innerHTML = ''; 
    ventaTableBody.innerHTML = ''; ventaListContainer.innerHTML = '';
    
    const compras = filteredOps.filter(op => op.operacion === 'Compra');
    const ventas = filteredOps.filter(op => op.operacion === 'Venta');

    if (compras.length === 0) {
        comprasCardContainer.style.display = 'none';
        comprasEmptyState.style.display = 'block';
    } else {
        comprasCardContainer.style.display = 'block';
        comprasEmptyState.style.display = 'none';
        compras.forEach((op, index) => {
            const globalIndex = wallyOperations.indexOf(op);
            // --- CORRECCIÓN AQUÍ --- (Se quitaron 'C' y '$')
            const tableRowHtml = `<tr><td class="text-left">${op.usuario}<br><span class="text-xs text-gray-400">${op.platform}</span></td><td>${(op.reciboUsdc||0).toFixed(2)}</td><td>${(op.tasaCompra||0).toFixed(4)}</td><td>${(op.envioUsd||0).toFixed(2)}</td><td class="font-semibold text-green-400">${(op.gananciaUsdc||0).toFixed(4)}</td><td><button class="text-blue-400 p-1" onclick="openWallyModal(${globalIndex})">✏️</button><button class="text-red-400 p-1" onclick="deleteWallyOperation(${globalIndex})">🗑️</button></td></tr>`;
            const cardHtml = `<div class="operation-card compra"><div class="card-header"><div class="user-info">${op.usuario}</div></div><div class="card-grid"><div class="grid-item"><span class="label">Recibo Cripto</span><span class="value">${(op.reciboUsdc||0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Envío USD</span><span class="value">${(op.envioUsd||0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Tasa</span><span class="value">${(op.tasaCompra||0).toFixed(4)}</span></div><div class="grid-item"><span class="label">Ganancia Cripto</span><span class="value profit-green">${(op.gananciaUsdc||0).toFixed(4)}</span></div></div><div class="card-footer"><div class="ref-info">REF: ${op.referencia || 'N/A'}</div><div class="actions"><button class="action-btn edit" onclick="openWallyModal(${globalIndex})">✏️</button><button class="action-btn delete" onclick="deleteWallyOperation(${globalIndex})">🗑️</button></div></div></div>`;
            compraTableBody.innerHTML += tableRowHtml;
            compraListContainer.innerHTML += cardHtml;
        });
    }

    if (ventas.length === 0) {
        ventasCardContainer.style.display = 'none';
        ventasEmptyState.style.display = 'block';
    } else {
        ventasCardContainer.style.display = 'block';
        ventasEmptyState.style.display = 'none';
        ventas.forEach((op, index) => {
            const globalIndex = wallyOperations.indexOf(op);
            // --- CORRECCIÓN AQUÍ --- (Se quitaron 'C' y '$')
            const tableRowHtml = `<tr><td class="text-left">${op.usuario}<br><span class="text-xs text-gray-400">${op.platform}</span></td><td>${(op.envioUsdc||0).toFixed(2)}</td><td>${(op.tasaVenta||0).toFixed(4)}</td><td>${(op.reciboUsd||0).toFixed(2)}</td><td class="font-semibold text-green-400">${(op.gananciaUsd||0).toFixed(4)}</td><td><button class="text-blue-400 p-1" onclick="openWallyModal(${globalIndex})">✏️</button><button class="text-red-400 p-1" onclick="deleteWallyOperation(${globalIndex})">🗑️</button></td></tr>`;
            const cardHtml = `<div class="operation-card venta"><div class="card-header"><div class="user-info">${op.usuario}</div></div><div class="card-grid"><div class="grid-item"><span class="label">Envío Cripto</span><span class="value">${(op.envioUsdc||0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Recibo USD</span><span class="value">${(op.reciboUsd||0).toFixed(2)}</span></div><div class="grid-item"><span class="label">Tasa</span><span class="value">${(op.tasaVenta||0).toFixed(4)}</span></div><div class="grid-item"><span class="label">Ganancia USD</span><span class="value profit-green">${(op.gananciaUsd||0).toFixed(4)}</span></div></div><div class="card-footer"><div class="ref-info">REF: ${op.referencia || 'N/A'}</div><div class="actions"><button class="action-btn edit" onclick="openWallyModal(${globalIndex})">✏️</button><button class="action-btn delete" onclick="deleteWallyOperation(${globalIndex})">🗑️</button></div></div></div>`;
            ventaTableBody.innerHTML += tableRowHtml;
            ventaListContainer.innerHTML += cardHtml;
        });
    }
}
        
        async function pasteSpecial() {
            try {
                const text = await navigator.clipboard.readText();
                const refMatch = text.match(/-\s*([a-z0-9]{8})/i);
                const usuarioMatch = text.match(/Contraparte:\s*([A-Z0-9\.]+)/i);
                const tasaMatch = text.match(/Precio:\s*([\d\.]+)/i);
                const estatusMatch = text.match(/Transacción\s+completada/i);
                const montoRecibidoUsdcMatch = text.match(/Monto recibido:\s*([\d\.,]+)\s*USDC/i);
                const montoEnviadoUsdcMatch = text.match(/Monto enviado:\s*([\d\.,]+)\s*USDC/i);
                if (usuarioMatch) document.getElementById("usuario").value = usuarioMatch[1];
                if (refMatch) document.getElementById("referencia").value = refMatch[1];
                if (tasaMatch) document.getElementById("tasa").value = tasaMatch[1].replace(',', '.');
                if (montoRecibidoUsdcMatch) {
                    document.getElementById("operacion").value = "Compra";
                    document.getElementById("montoUsdc").value = montoRecibidoUsdcMatch[1].replace(',', '.');
                } else if (montoEnviadoUsdcMatch) {
                    document.getElementById("operacion").value = "Venta";
                    document.getElementById("montoUsdc").value = montoEnviadoUsdcMatch[1].replace(',', '.');
                } else { showToast("No se pudo determinar el tipo de operación (Compra/Venta) o el monto USDC.", "warning"); return; }
                if (estatusMatch) document.getElementById("estatus").value = "Completado";
                calculateAll();
                showToast("Pegado especial exitoso.", "success");
            } catch (err) { showToast("No se pudo leer el portapapeles o el formato es incorrecto.", "error"); console.error(err); }
        }

        async function pasteSpecialWally() {
            try {
                const text = await navigator.clipboard.readText();
                const refMatch = text.match(/-\s*([a-z0-9]{8})/i);
                const usuarioMatch = text.match(/Contraparte:\s*([A-Z0-9\.]+)/i);
                const montoEnviadoUsdMatch = text.match(/Monto enviado:\s*([\d\.]+)\s*USD/i);
                const montoRecibidoUsdcMatch = text.match(/Monto recibido:\s*([\d\.]+)\s*USDC/i);
                const montoEnviadoUsdcMatch = text.match(/Monto enviado:\s*([\d\.]+)\s*USDC/i);
                const montoRecibidoUsdMatch = text.match(/Monto recibido:\s*([\d\.]+)\s*USD/i);
                const tasaMatch = text.match(/Precio:\s*([\d\.]+)/i);
                if (usuarioMatch) document.getElementById("wallyUsuario").value = usuarioMatch[1];
                if (refMatch) document.getElementById("wallyReferencia").value = refMatch[1];
                let tasaValue = tasaMatch ? tasaMatch[1] : '';
                if (montoEnviadoUsdMatch && montoRecibidoUsdcMatch) { 
                    document.getElementById("wallyOperacion").value = "Compra";
                    updateWallyFormFields();
                    document.getElementById("reciboUsdc").value = montoRecibidoUsdcMatch[1];
                    document.getElementById("tasaCompra").value = tasaValue;
                    updateWallyCalculations();
                    showToast("Pegado especial exitoso (Wally Compra).", "success");
                } else if (montoEnviadoUsdcMatch && montoRecibidoUsdMatch) {
                    document.getElementById("wallyOperacion").value = "Venta";
                    updateWallyFormFields();
                    document.getElementById("envioUsdcVenta").value = montoEnviadoUsdcMatch[1];
                    document.getElementById("tasaVenta").value = tasaValue;
                    updateWallyCalculations();
                    showToast("Pegado especial exitoso (Wally Venta).", "success");
                } else {
                    showToast("Formato no reconocido para Wally.", "warning");
                }
            } catch (err) {
                showToast("No se pudo leer el portapapeles.", "error");
                console.error(err);
            }
        }
        
        let currentRatingUser = '';
        let selectedRatings = { transaction: 0, speed: 0 };
        function loadUserRatings() { if (!currentUserId) return; db.collection('users').doc(currentUserId).collection('ratings').onSnapshot(snapshot => { userRatings = {}; snapshot.forEach(doc => { userRatings[doc.id] = doc.data().ratings; }); renderRatingsPage(); checkInitialLoadComplete(); }, e => { console.error(e); checkInitialLoadComplete(); });}
        function calculateAverageRating(userName) {
            if (!userRatings[userName] || userRatings[userName].length === 0) return 0;
            let totalSum = 0, count = 0;
            userRatings[userName].forEach(r => {
                if (r.transaction > 0) { totalSum += r.transaction; count++; }
                if (r.speed > 0) { totalSum += r.speed; count++; }
            });
            return count > 0 ? totalSum / count : 0;
        }
        function openRatingModal(userName) {
            currentRatingUser = userName;
            document.getElementById('ratingUserName').textContent = userName;
            document.getElementById('ratingModal').classList.add('show');
            resetStars();
        }
        function closeRatingModal() { document.getElementById('ratingModal').classList.remove('show'); currentRatingUser = ''; selectedRatings = { transaction: 0, speed: 0 }; }
        function resetStars() { document.querySelectorAll('.rating-stars').forEach(c => c.querySelectorAll('.star').forEach(s => s.classList.remove('selected'))); selectedRatings = { transaction: 0, speed: 0 };}
        document.querySelectorAll('.rating-stars').forEach(container => {
            container.addEventListener('click', function(event) {
                if (event.target.classList.contains('star')) {
                    const value = parseInt(event.target.dataset.value);
                    const parent = event.target.parentNode;
                    const ratingType = parent.id.replace('rating', '').toLowerCase();
                    parent.querySelectorAll('.star').forEach(star => {
                        star.classList.toggle('selected', parseInt(star.dataset.value) <= value);
                    });
                    selectedRatings[ratingType] = value;
                }
            });
        });
        function submitRating() {
            if (selectedRatings.transaction === 0 && selectedRatings.speed === 0) { showToast('Por favor, califique al menos un aspecto.', 'warning'); return; }
            const newRating = { transaction: selectedRatings.transaction, speed: selectedRatings.speed, date: new Date().toISOString().split('T')[0], operationType: lastSavedOperationType };
            if (!userRatings[currentRatingUser]) userRatings[currentRatingUser] = [];
            userRatings[currentRatingUser].push(newRating);
            db.collection('users').doc(currentUserId).collection('ratings').doc(currentRatingUser).set({ ratings: userRatings[currentRatingUser] }).then(() => { closeRatingModal(); showToast('Calificación guardada.', 'success'); });
        }
        function renderRatingsPage() {
    const container = document.getElementById('ratingsListContainer');
    const paginationControls = document.getElementById('ratings-pagination');
    const pageInfo = document.getElementById('page-info');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    const searchTerm = document.getElementById('searchRatings').value.toLowerCase();

    // 1. Filtra y ordena la lista completa de usuarios como antes
    const filteredUsers = Object.keys(userRatings)
        .filter(user => user.toLowerCase().includes(searchTerm))
        .sort((a, b) => calculateAverageRating(b) - calculateAverageRating(a));

    // Si no hay resultados, oculta todo y muestra un mensaje
    if (filteredUsers.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">No se encontraron usuarios.</p>';
        paginationControls.style.display = 'none';
        return;
    }

    // 2. Calcula la paginación
    const totalPages = Math.ceil(filteredUsers.length / USERS_PER_PAGE);
    const start = (ratingsCurrentPage - 1) * USERS_PER_PAGE;
    const end = start + USERS_PER_PAGE;
    const paginatedUsers = filteredUsers.slice(start, end);

    // 3. Renderiza solo los usuarios de la página actual
    container.innerHTML = paginatedUsers.map(userName => {
        const avgRating = calculateAverageRating(userName);
        const totalCount = userRatings[userName].length;
        return `<div class="card clickable flex justify-between items-center" onclick="openUserProfileModal('${userName}')"><div><p class="font-bold text-lg">${userName}</p><p class="text-xs text-gray-400">${totalCount} operaciones</p></div><div class="text-xl font-bold text-yellow-400">${avgRating.toFixed(1)} ★</div></div>`;
    }).join('');

    // 4. Muestra y actualiza los controles de paginación
    paginationControls.style.display = 'flex';
    pageInfo.textContent = `Página ${ratingsCurrentPage} de ${totalPages}`;
    prevBtn.disabled = ratingsCurrentPage === 1;
    nextBtn.disabled = ratingsCurrentPage === totalPages;
}
        
        let currentProfileUserName = '';
        function loadUserProfiles() { if (!currentUserId) return; db.collection('users').doc(currentUserId).collection('userProfiles').onSnapshot(snapshot => { userProfiles = {}; snapshot.forEach(doc => { userProfiles[doc.id] = doc.data(); }); checkInitialLoadComplete(); }, e => { console.error(e); checkInitialLoadComplete(); });}
        function openUserProfileModal(userName) {
    currentProfileUserName = userName;
    document.getElementById('profileUserName').textContent = userName;

    // --- Lógica de Calificaciones (sin cambios) ---
    const avgRating = calculateAverageRating(userName);
    const totalRatings = userRatings[userName] ? userRatings[userName].length : 0;
    document.getElementById('profileAvgRating').textContent = `${avgRating.toFixed(1)} ★`;
    document.getElementById('profileTotalRatings').textContent = `${totalRatings} calificaciones`;
    document.getElementById('profileNotes').value = userProfiles[userName]?.notes || '';

    // --- Lógica de Operaciones (MEJORADA) ---
    // 1. Filtra y guarda las operaciones de ambos tipos por separado
    currentProfileUserOps.ves = operations.filter(op => op.usuario === userName).sort((a,b) => b.timestamp - a.timestamp);
    currentProfileUserOps.usd = wallyOperations.filter(op => op.usuario === userName).sort((a,b) => b.timestamp - a.timestamp);
    const allUserOps = [...currentProfileUserOps.ves, ...currentProfileUserOps.usd].sort((a,b) => b.timestamp - a.timestamp);

    // 2. Calcula las estadísticas usando los datos consolidados
    const totalUsdc = allUserOps.reduce((sum, op) => sum + (op.montoUsdc || op.reciboUsdc || op.envioUsdc || 0), 0);
    const totalVes = currentProfileUserOps.ves.reduce((sum, op) => sum + (op.montoBs || 0), 0);
    document.getElementById('profileTotalUsdc').textContent = totalUsdc.toFixed(2);
    document.getElementById('profileTotalVes').textContent = totalVes.toFixed(2);
    document.getElementById('profileNumOps').textContent = allUserOps.length;
    document.getElementById('profileLastOpDate').textContent = allUserOps.length > 0 ? new Date(allUserOps[0].timestamp).toLocaleDateString() : 'N/A';
    
    // 3. Muestra el modal y activa la primera pestaña por defecto
    document.getElementById('userProfileModal').classList.add('show');
    switchProfileTab('ves');
}

/**
 * Cambia la pestaña activa en el modal de perfil de usuario y muestra la tabla correspondiente.
 * @param {'ves' | 'usd'} tabName - El tipo de operaciones a mostrar.
 */
/**
 * Cambia la pestaña activa en el modal de perfil de usuario y muestra la tabla correspondiente.
 * @param {'ves' | 'usd'} tabName - El tipo de operaciones a mostrar.
 */
function switchProfileTab(tabName) {
    // Actualiza el estado visual de los botones de las pestañas
    document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent.toLowerCase().includes(tabName));
    });

    const contentDiv = document.getElementById('profile-tab-content');
    const opsToShow = (tabName === 'ves') ? currentProfileUserOps.ves : currentProfileUserOps.usd;
    
    if (opsToShow.length === 0) {
        contentDiv.innerHTML = `<p class="text-center text-sm text-gray-500 py-4">No hay operaciones de este tipo.</p>`;
        return;
    }

    let tableHtml = '';
    if (tabName === 'ves') {
        tableHtml = `
            <div class="table-container max-h-48">
                <table class="w-full min-w-[300px]"><thead class="text-xs"><tr><th>Fecha</th><th>Op</th><th>USDC</th><th>Tasa</th></tr></thead>
                <tbody class="text-xs">${opsToShow.map(op => `<tr><td>${op.fecha}</td><td>${op.operacion.substring(0,1)}</td><td>${op.montoUsdc.toFixed(2)}</td><td>${op.tasa.toFixed(2)}</td></tr>`).join('')}</tbody>
                </table></div>`;
    } else { // tabName === 'usd'
        // --- CORRECCIÓN AQUÍ: Se quitaron las 'C' y '$' sobrantes ---
        tableHtml = `
            <div class="table-container max-h-48">
                <table class="w-full min-w-[300px]"><thead class="text-xs"><tr><th>Fecha</th><th>Op</th><th>Monto</th><th>Ganancia</th></tr></thead>
                <tbody class="text-xs">${opsToShow.map(op => `<tr><td>${op.fecha}</td><td>${op.operacion.substring(0,1)}</td><td class="font-semibold">${op.operacion === 'Compra' ? (op.reciboUsdc || 0).toFixed(2) : (op.envioUsdc || 0).toFixed(2)}</td><td class="font-semibold text-green-400">${op.operacion === 'Compra' ? (op.gananciaUsdc || 0).toFixed(3) : (op.gananciaUsd || 0).toFixed(3)}</td></tr>`).join('')}</tbody>
                </table></div>`;
    }
    contentDiv.innerHTML = tableHtml;
}

        function closeUserProfileModal() { document.getElementById('userProfileModal').classList.remove('show'); }
        function saveProfileNotes() {
            if (!currentUserId || !currentProfileUserName) return;
            const notes = document.getElementById('profileNotes').value;
            db.collection('users').doc(currentUserId).collection('userProfiles').doc(currentProfileUserName).set({ notes: notes }, { merge: true })
                .then(() => showToast('Notas guardadas.', 'success'))
                .catch(() => showToast('Error al guardar notas.', 'error'));
        }

        document.addEventListener('DOMContentLoaded', () => {
    // Listener para el botón "Anterior"
    document.getElementById('prev-page-btn').addEventListener('click', () => {
        if (ratingsCurrentPage > 1) {
            ratingsCurrentPage--;
            renderRatingsPage();
        }
    });

    // Listener para el botón "Siguiente"
    document.getElementById('next-page-btn').addEventListener('click', () => {
        // Volvemos a calcular el total de páginas por si el filtro cambió
        const totalUsers = Object.keys(userRatings).filter(user => user.toLowerCase().includes(document.getElementById('searchRatings').value.toLowerCase()));
        const totalPages = Math.ceil(totalUsers.length / USERS_PER_PAGE);
        if (ratingsCurrentPage < totalPages) {
            ratingsCurrentPage++;
            renderRatingsPage();
        }
    });
    
    // Listener para el campo de búsqueda: reinicia a la página 1
    const searchInput = document.getElementById('searchRatings');
    if (searchInput) {
        searchInput.addEventListener('keyup', () => {
            ratingsCurrentPage = 1; // Reinicia la paginación
            // La función renderRatingsPage ya es llamada por el onkeyup del HTML
        });
    }
});

// ===== INICIO DEL CÓDIGO A PEGAR (BLOQUE PRINCIPAL) =====

        /**
         * Cierra el modal de análisis semanal y destruye el gráfico para liberar memoria.
         */
        function closeWeeklyAnalysisModal() {
            document.getElementById('weeklyAnalysisModal').classList.remove('show');
            if (weeklyChartInstance) {
                weeklyChartInstance.destroy();
            }
        }

        /**
         * Orquesta la apertura del modal, la carga de datos y la renderización del análisis.
         */
        function openWeeklyAnalysisModal() {
            const modal = document.getElementById('weeklyAnalysisModal');
            const summaryContainer = document.getElementById('weeklyAnalysisSummary');
            modal.classList.add('show');

            // Muestra un estado de carga mientras se procesan los datos
            summaryContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="loader mx-auto"></div>
                    <p class="mt-2 text-sm text-gray-400">Analizando datos de la semana...</p>
                </div>`;
            
            // Usamos un pequeño timeout para permitir que el navegador renderice el loader antes de empezar el cálculo pesado
            setTimeout(() => {
                const weeklyOps = getWeeklyOperations();
                if (weeklyOps.length === 0) {
                    summaryContainer.innerHTML = `<p class="text-center text-gray-400 py-4">No hay operaciones en los últimos 7 días para analizar.</p>`;
                    if (weeklyChartInstance) weeklyChartInstance.destroy(); // Limpia gráfico si existía
                    return;
                }
                const analysisResults = analyzeWeeklyData(weeklyOps);
                renderWeeklyChart(analysisResults.dailyData);
                renderWeeklySummary(analysisResults);
            }, 50);
        }

        /**
 * Obtiene las operaciones de la semana del calendario actual (Lunes HASTA HOY).
 * @returns {Array} Un array con las operaciones de la semana.
 */
function getWeeklyOperations() {
    const today = new Date(); // <-- Usaremos 'today' como nuestra nueva fecha final
    const dayOfWeek = today.getDay(); // Domingo = 0, Lunes = 1, ..., Sábado = 6

    // Calculamos el lunes de esta semana (esto no cambia)
    const monday = new Date();
    const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    monday.setDate(today.getDate() - diff);

    // ELIMINADO: Ya no necesitamos calcular el domingo.

    // Función para dar formato a YYYY-MM-DD
    const formatDate = (d) => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const startStr = formatDate(monday);
    const endStr = formatDate(today); // <-- CAMBIO CLAVE: Usamos 'today' como fecha final

    // El filtro ahora va desde el Lunes hasta Hoy.
    return operations.filter(op => op.fecha >= startStr && op.fecha <= endStr);
}

       /**
         * Procesa un array de operaciones y devuelve un objeto con todas las métricas analizadas.
         * ESTA VERSIÓN CORRIGE EL CÁLCULO FIFO PARA QUE SEA ACUMULATIVO.
         * @param {Array} ops - Las operaciones a analizar.
         * @returns {Object} Un objeto con todos los resultados del análisis.
         */
        function analyzeWeeklyData(ops) {
            const dailyData = {};
            const paymentMethodCount = {};
            const userVolume = {};
            const hourlyOps = Array(24).fill(0).map(() => ({ count: 0, buyRates: [], sellRates: [] }));
            
            // Paso 1: Agrupar todas las operaciones por día
            const groupedByDay = ops.reduce((acc, op) => {
                const date = op.fecha;
                if (!acc[date]) acc[date] = [];
                acc[date].push(op);
                return acc;
            }, {});

            const sortedDates = Object.keys(groupedByDay).sort();
            let cumulativeOps = [];
            let lastDayCumulativeProfitVes = 0;
            let lastDayCumulativeProfitUsdc = 0;

            // Paso 2: Calcular ganancias de forma ACUMULATIVA día por día
            sortedDates.forEach(date => {
                const opsOfTheDay = groupedByDay[date];
                cumulativeOps.push(...opsOfTheDay);

                // Calculamos el FIFO para TODAS las operaciones hasta la fecha actual del bucle
                const [cumulativeProfitVes, cumulativeProfitUsdc] = calculateFIFOGainsForOps(cumulativeOps);

                // La ganancia del día es la diferencia entre el acumulado de hoy y el de ayer
                const dailyProfitVes = cumulativeProfitVes - lastDayCumulativeProfitVes;
                const dailyProfitUsdc = cumulativeProfitUsdc - lastDayCumulativeProfitUsdc;
                const dailyVolume = opsOfTheDay.reduce((sum, op) => sum + (op.montoUsdc || 0), 0);
                
                dailyData[date] = {
                    volume: dailyVolume,
                    profitVes: dailyProfitVes,
                    profitUsdc: dailyProfitUsdc,
                    opCount: opsOfTheDay.length
                };

                // Guardamos los acumulados para la siguiente iteración
                lastDayCumulativeProfitVes = cumulativeProfitVes;
                lastDayCumulativeProfitUsdc = cumulativeProfitUsdc;
            });

            // Post-procesamiento (sin cambios, ahora usa los datos diarios correctos)
            let totalVolume = 0, totalProfitVes = 0, totalProfitUsdc = 0;
            ops.forEach(op => {
                totalVolume += op.montoUsdc || 0;
                paymentMethodCount[op.metodoPago] = (paymentMethodCount[op.metodoPago] || 0) + 1;
                userVolume[op.usuario] = (userVolume[op.usuario] || 0) + op.montoUsdc;
                const hour = new Date(op.timestamp).getHours();
                hourlyOps[hour].count++;
                if (op.operacion === 'Compra') hourlyOps[hour].buyRates.push(op.tasa);
                if (op.operacion === 'Venta') hourlyOps[hour].sellRates.push(op.tasa);
            });
            // El total de ganancias es el acumulado del último día
            totalProfitVes = lastDayCumulativeProfitVes;
            totalProfitUsdc = lastDayCumulativeProfitUsdc;

            const dayWithMostVolume = Object.entries(dailyData).sort((a, b) => b[1].volume - a[1].volume)[0];
            const dayWithMostProfit = Object.entries(dailyData).sort((a, b) => b[1].profitVes - a[1].profitVes)[0];
            const mostUsedPaymentMethod = Object.entries(paymentMethodCount).sort((a, b) => b[1] - a[1])[0];
            const mostValuableUserByVolume = Object.entries(userVolume).sort((a, b) => b[1] - a[1])[0];
            const hourlyBrecha = hourlyOps.map((hourData, hour) => {
                if (hourData.buyRates.length === 0 || hourData.sellRates.length === 0) return { hour, brecha: -1 };
                const avgBuy = hourData.buyRates.reduce((a, b) => a + b, 0) / hourData.buyRates.length;
                const avgSell = hourData.sellRates.reduce((a, b) => a + b, 0) / hourData.sellRates.length;
                const brecha = avgBuy > 0 ? ((avgSell - avgBuy) / avgBuy * 100) : 0;
                return { hour, brecha };
            }).filter(h => h.brecha !== -1);

            return {
                totalOps: ops.length,
                totalVolume,
                totalProfitVes,
                totalProfitUsdc,
                avgRate: ops.reduce((sum, op) => sum + op.tasa, 0) / ops.length,
                dailyData,
                dayWithMostVolume: { date: dayWithMostVolume[0], value: dayWithMostVolume[1].volume },
                dayWithMostProfit: { date: dayWithMostProfit[0], valueVes: dayWithMostProfit[1].profitVes, valueUsdc: dayWithMostProfit[1].profitUsdc },
                mostUsedPaymentMethod: { method: mostUsedPaymentMethod[0], count: mostUsedPaymentMethod[1] },
                mostValuableUser: { user: mostValuableUserByVolume[0], volume: mostValuableUserByVolume[1] },
                hottestHour: hourlyOps.map((h, i) => ({hour: i, count: h.count})).sort((a, b) => b.count - a.count)[0],
                hourWithMinBrecha: hourlyBrecha.length > 0 ? hourlyBrecha.sort((a,b) => a.brecha - b.brecha)[0] : null,
                hourWithMaxBrecha: hourlyBrecha.length > 0 ? hourlyBrecha.sort((a,b) => b.brecha - a.brecha)[0] : null,
            };
        }

        /**
         * Renderiza el gráfico semanal en el canvas del modal.
         * @param {Object} dailyData - Los datos agrupados por día.
         */
        function renderWeeklyChart(dailyData) {
            // Registrar el plugin de datalabels globalmente para todos los gráficos
            Chart.register(ChartDataLabels);

            const ctx = document.getElementById('weeklyChart').getContext('2d');
            const sortedDates = Object.keys(dailyData).sort();
            
            const labels = sortedDates.map(date => new Date(date+'T00:00:00').toLocaleDateString('es-VE', { weekday: 'short', day: 'numeric'}));
            const profitDataVes = sortedDates.map(date => dailyData[date].profitVes);
            const profitDataUsdc = sortedDates.map(date => dailyData[date].profitUsdc);

            if (weeklyChartInstance) {
                weeklyChartInstance.destroy();
            }

            weeklyChartInstance = new Chart(ctx, {
                type: 'bar', // CAMBIADO: a 'bar'
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ganancia (VES)',
                            data: profitDataVes,
                            backgroundColor: 'rgba(52, 211, 153, 0.7)',
                            borderColor: 'rgba(52, 211, 153, 1)',
                            borderWidth: 1,
                            // Asociamos los datos de USDC a este dataset para usarlos en las etiquetas
                            datalabels: {
                                labels: {
                                    usdc: {
                                        // Le decimos al plugin que use nuestro array de ganancias en USDC
                                        formatter: (value, context) => {
                                            const usdcValue = profitDataUsdc[context.dataIndex];
                                            return `${usdcValue.toFixed(3)} USDC`;
                                        },
                                        color: '#FBBF24', // Color amarillo/naranja
                                        anchor: 'end',    // Posición de la etiqueta (arriba de la barra)
                                        align: 'end',     // Alineación de la etiqueta
                                        offset: -5,       // Un pequeño espacio desde el borde
                                        font: {
                                            weight: 'bold',
                                            size: 11,
                                        }
                                    }
                                }
                            }
                        }
                        // ELIMINADO: El dataset de USDC fue removido
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Ganancia (VES)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // La leyenda no es necesaria con un solo tipo de barra
                        }
                    }
                }
            });
        }

        /**
         * Renderiza el resumen de texto del análisis en el modal.
         * @param {Object} results - El objeto completo con los resultados del análisis.
         */
        function renderWeeklySummary(results) {
            const container = document.getElementById('weeklyAnalysisSummary');
            const formatHour = h => `${h}:00 - ${h}:59`;
            
            container.innerHTML = `
                <h3 class="text-base font-semibold text-center mb-2">Resumen General de la Semana</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center text-sm">
                    <div class="info-card !p-2">
                        <div class="info-card-title !text-xs">GANANCIA NETA</div>
                        <div class="info-card-value !text-base text-green-400">${results.totalProfitVes.toFixed(2)} VES</div>
                        <div class="info-card-details text-orange-400">${results.totalProfitUsdc.toFixed(4)} USDC</div>
                    </div>
                    <div class="info-card !p-2"><div class="info-card-title !text-xs">VOLUMEN TOTAL</div><div class="info-card-value !text-lg">${results.totalVolume.toFixed(2)} USDC</div></div>
                    <div class="info-card !p-2"><div class="info-card-title !text-xs">RENTABILIDAD</div><div class="info-card-value !text-lg text-blue-400">${(results.totalProfitUsdc / results.totalVolume * 100).toFixed(2)}%</div></div>
                    <div class="info-card !p-2"><div class="info-card-title !text-xs">OPERACIONES</div><div class="info-card-value !text-lg">${results.totalOps}</div></div>
                </div>
                <hr class="border-gray-700 !my-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div><strong>Día de mayor volumen:</strong> <span class="float-right font-mono">${new Date(results.dayWithMostVolume.date+'T00:00:00').toLocaleDateString()} (${results.dayWithMostVolume.value.toFixed(2)} USDC)</span></div>
                    <div><strong>Día de mayor ganancia:</strong> <span class="float-right font-mono text-green-400">${new Date(results.dayWithMostProfit.date+'T00:00:00').toLocaleDateString()} (${results.dayWithMostProfit.valueVes.toFixed(2)} VES)</span></div>
                    <div><strong>Método de pago más usado:</strong> <span class="float-right font-mono">${results.mostUsedPaymentMethod.method} (${results.mostUsedPaymentMethod.count} veces)</span></div>
                    <div><strong>Usuario más valioso (Vol.):</strong> <span class="float-right font-mono">${results.mostValuableUser.user} (${results.mostValuableUser.volume.toFixed(2)} USDC)</span></div>
                    <div><strong>Hora de mayor actividad:</strong> <span class="float-right font-mono">${formatHour(results.hottestHour.hour)} (${results.hottestHour.count} ops)</span></div>
                    <div><strong>Tasa promedio de la semana:</strong> <span class="float-right font-mono">${results.avgRate.toFixed(2)}</span></div>
                    ${results.hourWithMinBrecha ? `<div><strong>Hora con menor brecha:</strong> <span class="float-right font-mono text-green-400">${formatHour(results.hourWithMinBrecha.hour)} (${results.hourWithMinBrecha.brecha.toFixed(2)}%)</span></div>` : ''}
                    ${results.hourWithMaxBrecha ? `<div><strong>Hora con mayor brecha:</strong> <span class="float-right font-mono text-red-400">${formatHour(results.hourWithMaxBrecha.hour)} (${results.hourWithMaxBrecha.brecha.toFixed(2)}%)</span></div>` : ''}
                </div>
            `;
        }

        function closeMonthlyAnalysisModal() {
    document.getElementById('monthlyAnalysisModal').classList.remove('show');
    if (monthlyChartInstance) {
        monthlyChartInstance.destroy();
    }
}

function openMonthlyAnalysisModal() {
    document.getElementById('monthlyAnalysisModal').classList.add('show');
    // Si el selector ya tiene opciones, ejecuta el análisis. Si no, espera.
    if (document.getElementById('monthSelector').options.length > 0) {
        runMonthlyAnalysis();
    }
}

function populateMonthSelector() {
    const selector = document.getElementById('monthSelector');
    if (!operations || operations.length === 0) return;

    // Limpiamos opciones previas
    selector.innerHTML = '';

    const oldestOp = operations.sort((a, b) => a.timestamp - b.timestamp)[0];
    const startDate = new Date(oldestOp.timestamp);
    const currentDate = new Date();

    let loopDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);

    while (loopDate >= new Date(startDate.getFullYear(), startDate.getMonth(), 1)) {
        const monthName = loopDate.toLocaleDateString('es-VE', { month: 'long', year: 'numeric' });
        const monthValue = `${loopDate.getFullYear()}-${String(loopDate.getMonth() + 1).padStart(2, '0')}`;

        const option = document.createElement('option');
        option.value = monthValue;
        option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
        selector.appendChild(option);

        // Retroceder un mes
        loopDate.setMonth(loopDate.getMonth() - 1);
    }
}

function runMonthlyAnalysis() {
    const selector = document.getElementById('monthSelector');
    const summaryContainer = document.getElementById('monthlyAnalysisSummary');
    const selectedMonth = selector.value; // ej. "2025-10"

    if (!selectedMonth) return;

    summaryContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="loader mx-auto"></div>
            <p class="mt-2 text-sm text-gray-400">Analizando ${selector.options[selector.selectedIndex].text}...</p>
        </div>`;

    setTimeout(() => {
        const monthlyOps = operations.filter(op => op.fecha.startsWith(selectedMonth));
        if (monthlyOps.length === 0) {
            summaryContainer.innerHTML = `<p class="text-center text-gray-400 py-4">No hay operaciones para el mes seleccionado.</p>`;
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            return;
        }
        const analysisResults = analyzeMonthlyData(monthlyOps);
        renderMonthlyChart(analysisResults.weeklyData);
        renderMonthlySummary(analysisResults);
    }, 50);
}

function analyzeMonthlyData(monthlyOps) {
            // Agrupar por semana y por día al mismo tiempo
            const weeklyData = {};
            const dailyData = {};
            monthlyOps.forEach(op => {
                const opDate = new Date(op.fecha + 'T00:00:00');
                const weekOfMonth = Math.ceil(opDate.getDate() / 7);
                if (!weeklyData[weekOfMonth]) {
                    weeklyData[weekOfMonth] = { ops: [], profitVes: 0, profitUsdc: 0, volume: 0 };
                }
                weeklyData[weekOfMonth].ops.push(op);

                if (!dailyData[op.fecha]) dailyData[op.fecha] = [];
                dailyData[op.fecha].push(op);
            });

            // --- INICIO DE LA LÓGICA CORREGIDA ---

            // 1. Cálculo acumulativo para el gráfico semanal
            const sortedWeeks = Object.keys(weeklyData).sort((a,b) => a - b);
            let cumulativeWeeklyOps = [];
            let lastWeekCumulativeProfitVes = 0;
            let lastWeekCumulativeProfitUsdc = 0;

            sortedWeeks.forEach(week => {
                const opsOfTheWeek = weeklyData[week].ops;
                cumulativeWeeklyOps.push(...opsOfTheWeek);
                
                const [cumulativeProfitVes, cumulativeProfitUsdc] = calculateFIFOGainsForOps(cumulativeWeeklyOps);
                
                weeklyData[week].profitVes = cumulativeProfitVes - lastWeekCumulativeProfitVes;
                weeklyData[week].profitUsdc = cumulativeProfitUsdc - lastWeekCumulativeProfitUsdc;
                
                lastWeekCumulativeProfitVes = cumulativeProfitVes;
                lastWeekCumulativeProfitUsdc = cumulativeProfitUsdc;
            });
            
            // 2. Cálculo acumulativo para encontrar el mejor día
            const sortedDates = Object.keys(dailyData).sort();
            let cumulativeDailyOps = [];
            let lastDayCumulativeProfit = -Infinity;
            let bestDay = { date: null, profitVes: -Infinity };
            let positiveProfitDays = 0;

            sortedDates.forEach(date => {
                cumulativeDailyOps.push(...dailyData[date]);
                const [totalGainsForPeriod] = calculateFIFOGainsForOps(cumulativeDailyOps);
                const dailyProfit = totalGainsForPeriod - (lastDayCumulativeProfit === -Infinity ? 0 : lastDayCumulativeProfit);

                if (dailyProfit > 0) positiveProfitDays++;
                if (dailyProfit > bestDay.profitVes) {
                    bestDay = { date, profitVes: dailyProfit };
                }
                lastDayCumulativeProfit = totalGainsForPeriod;
            });

            // --- FIN DE LA LÓGICA CORREGIDA ---

            const bestWeek = Object.entries(weeklyData).sort((a, b) => b[1].profitVes - a[1].profitVes)[0];
            const totalProfitVes = Object.values(weeklyData).reduce((sum, week) => sum + week.profitVes, 0);
            const totalProfitUsdc = Object.values(weeklyData).reduce((sum, week) => sum + week.profitUsdc, 0);
            const totalVolume = monthlyOps.reduce((sum, op) => sum + op.montoUsdc, 0);
            const mostUsedPaymentMethod = Object.entries(monthlyOps.reduce((acc, op) => { acc[op.metodoPago] = (acc[op.metodoPago] || 0) + 1; return acc; }, {})).sort((a,b) => b[1]-a[1])[0];
            const mostValuableUser = Object.entries(monthlyOps.reduce((acc, op) => { acc[op.usuario] = (acc[op.usuario] || 0) + op.montoUsdc; return acc; }, {})).sort((a,b) => b[1]-a[1])[0];

            return {
                totalProfitVes,
                totalProfitUsdc,
                totalVolume,
                totalOps: monthlyOps.length,
                daysInMonth: Object.keys(dailyData).length,
                positiveProfitDays,
                bestWeek: { week: bestWeek[0], data: bestWeek[1] },
                bestDay,
                mostUsedPaymentMethod,
                mostValuableUser,
                weeklyData
            };
        }

function renderMonthlyChart(weeklyData) {
    Chart.register(ChartDataLabels);
    const ctx = document.getElementById('monthlyChart').getContext('2d');
    const sortedWeeks = Object.keys(weeklyData).sort();

    const labels = sortedWeeks.map(week => `Semana ${week}`);
    const profitDataVes = sortedWeeks.map(week => weeklyData[week].profitVes);
    const profitDataUsdc = sortedWeeks.map(week => weeklyData[week].profitUsdc);

    if (monthlyChartInstance) {
        monthlyChartInstance.destroy();
    }

    monthlyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ganancia (VES)',
                data: profitDataVes,
                backgroundColor: 'rgba(34, 211, 238, 0.7)', // Color teal
                borderColor: 'rgba(34, 211, 238, 1)',
                borderWidth: 1,
                datalabels: {
                    labels: {
                        usdc: {
                            formatter: (value, context) => `${profitDataUsdc[context.dataIndex].toFixed(3)} USDC`,
                            color: '#FBBF24',
                            anchor: 'end',
                            align: 'end',
                            offset: -5,
                            font: { weight: 'bold', size: 11 }
                        }
                    }
                }
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Ganancia (VES)' } } },
            plugins: { legend: { display: false } }
        }
    });
}

function renderMonthlySummary(results) {
    const container = document.getElementById('monthlyAnalysisSummary');
    container.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center text-sm">
            <div class="info-card !p-2">
                <div class="info-card-title !text-xs">GANANCIA NETA</div>
                <div class="info-card-value !text-base text-green-400">${results.totalProfitVes.toFixed(2)} VES</div>
                <div class="info-card-details text-orange-400">${results.totalProfitUsdc.toFixed(4)} USDC</div>
            </div>
            <div class="info-card !p-2"><div class="info-card-title !text-xs">VOLUMEN TOTAL</div><div class="info-card-value !text-lg">${results.totalVolume.toFixed(2)} USDC</div></div>
            <div class="info-card !p-2"><div class="info-card-title !text-xs">RENTABILIDAD</div><div class="info-card-value !text-lg text-blue-400">${(results.totalProfitUsdc / results.totalVolume * 100).toFixed(2)}%</div></div>
            <div class="info-card !p-2">
                <div class="info-card-title !text-xs">CONSISTENCIA</div>
                <div class="info-card-value !text-lg text-purple-400">${results.positiveProfitDays} / ${results.daysInMonth}</div>
                <div class="info-card-details">días con ganancia</div>
            </div>
        </div>
        <hr class="border-gray-700 !my-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm">
            <div><strong>Mejor semana del mes:</strong> <span class="float-right font-mono text-teal-400">Semana ${results.bestWeek.week} (${results.bestWeek.data.profitVes.toFixed(2)} VES)</span></div>
            <div><strong>Mejor día del mes:</strong> <span class="float-right font-mono text-teal-400">${new Date(results.bestDay.date+'T00:00:00').toLocaleDateString()} (${results.bestDay.profitVes.toFixed(2)} VES)</span></div>
            <div><strong>Método de pago más usado:</strong> <span class="float-right font-mono">${results.mostUsedPaymentMethod[0]} (${results.mostUsedPaymentMethod[1]} veces)</span></div>
            <div><strong>Usuario más valioso (Vol.):</strong> <span class="float-right font-mono">${results.mostValuableUser[0]} (${results.mostValuableUser[1].toFixed(2)} USDC)</span></div>
        </div>
    `;
}


// ===================================================================
// == INICIO: BLOQUE DE CÓDIGO PARA EL NUEVO MODAL DE ANÁLISIS USD   ==
// ===================================================================

function openUsdAnalysisModal() {
    document.getElementById('usdAnalysisModal').classList.add('show');
    populateUsdMonthSelector();
    switchUsdAnalysisTab('weekly'); // Inicia en la pestaña semanal por defecto
}

function closeUsdAnalysisModal() {
    document.getElementById('usdAnalysisModal').classList.remove('show');
    // Destruir todos los gráficos para liberar memoria
    if (usdWeeklyChartInstance) usdWeeklyChartInstance.destroy();
    if (usdWeeklyPaymentMethodChartInstance) usdWeeklyPaymentMethodChartInstance.destroy();
    if (usdWeeklyP2pPlatformChartInstance) usdWeeklyP2pPlatformChartInstance.destroy();
    if (usdMonthlyChartInstance) usdMonthlyChartInstance.destroy();
    if (usdMonthlyPaymentMethodChartInstance) usdMonthlyPaymentMethodChartInstance.destroy();
    if (usdMonthlyP2pPlatformChartInstance) usdMonthlyP2pPlatformChartInstance.destroy();
}

function switchUsdAnalysisTab(tabName) {
    currentUsdAnalysisTab = tabName;
    document.getElementById('usd-analysis-tab-weekly').classList.toggle('active', tabName === 'weekly');
    document.getElementById('usd-analysis-tab-monthly').classList.toggle('active', tabName === 'monthly');
    document.getElementById('usd-month-selector-container').classList.toggle('hidden', tabName !== 'monthly');
    renderUsdAnalysis();
}

function populateUsdMonthSelector() {
    const selector = document.getElementById('usdMonthSelector');
    if (!wallyOperations || wallyOperations.length === 0) return;
    selector.innerHTML = '';
    const uniqueMonths = [...new Set(wallyOperations.map(op => op.fecha.substring(0, 7)))].sort().reverse();
    
    uniqueMonths.forEach(monthValue => {
        const [year, month] = monthValue.split('-');
        const date = new Date(year, month - 1, 1);
        const monthName = date.toLocaleDateString('es-VE', { month: 'long', year: 'numeric' });
        const option = document.createElement('option');
        option.value = monthValue;
        option.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
        selector.appendChild(option);
    });
}

// REEMPLAZA ESTA FUNCIÓN COMPLETA
// REEMPLAZA ESTA FUNCIÓN COMPLETA
function renderUsdAnalysis() {
    const contentContainer = document.getElementById('usdAnalysisContent');
    contentContainer.innerHTML = `<div class="text-center py-8"><div class="loader mx-auto"></div><p class="mt-2 text-sm text-gray-400">Calculando análisis...</p></div>`;

    setTimeout(() => {
        let opsToAnalyze = [];
        let periodTitle = "";
        let groupBy = 'day';

        if (currentUsdAnalysisTab === 'weekly') {
            periodTitle = "Semana Actual";
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            const monday = new Date();
            monday.setDate(today.getDate() - diff);
            monday.setHours(0, 0, 0, 0);
            const formatDate = (d) => d.toISOString().split('T')[0];
            const mondayStr = formatDate(monday);
            const todayStr = formatDate(today);
            opsToAnalyze = wallyOperations.filter(op => op.fecha >= mondayStr && op.fecha <= todayStr);
        } else {
            const selectedMonth = document.getElementById('usdMonthSelector').value;
            periodTitle = document.getElementById('usdMonthSelector').options[document.getElementById('usdMonthSelector').selectedIndex]?.text || "Mes Seleccionado";
            if (selectedMonth) {
                opsToAnalyze = wallyOperations.filter(op => op.fecha.startsWith(selectedMonth));
            }
            groupBy = 'week';
        }

        if (opsToAnalyze.length === 0) {
            contentContainer.innerHTML = `<p class="text-center text-gray-400 py-8">No hay operaciones en '${periodTitle}' para analizar.</p>`;
            return;
        }

        const analysisResults = analyzeUsdData(opsToAnalyze, groupBy);
        contentContainer.innerHTML = generateUsdAnalysisHTML(analysisResults, currentUsdAnalysisTab);

        if (currentUsdAnalysisTab === 'weekly') {
            renderUsdChart(analysisResults.groupedData, 'usdWeeklyChart', 'usdWeeklyChartInstance');
            // --- LLAMADAS A LOS NUEVOS GRÁFICOS ---
            renderUsdP2pPlatformChart(analysisResults.gainsByP2pPlatform, 'usdWeeklyP2pPlatformChart', 'usdWeeklyP2pPlatformChartInstance');
            renderUsdPaymentMethodChart(analysisResults.gainsByPaymentMethod, 'usdWeeklyPaymentMethodChart', 'usdWeeklyPaymentMethodChartInstance');
        } else {
            renderUsdChart(analysisResults.groupedData, 'usdMonthlyChart', 'usdMonthlyChartInstance');
            // --- LLAMADAS A LOS NUEVOS GRÁFICOS ---
            renderUsdP2pPlatformChart(analysisResults.gainsByP2pPlatform, 'usdMonthlyP2pPlatformChart', 'usdMonthlyP2pPlatformChartInstance');
            renderUsdPaymentMethodChart(analysisResults.gainsByPaymentMethod, 'usdMonthlyPaymentMethodChart', 'usdMonthlyPaymentMethodChartInstance');
        }
    }, 50);
}

// REEMPLAZA ESTA FUNCIÓN COMPLETA EN TU SCRIPT
function analyzeUsdData(ops, groupBy = 'day') {
    const groupedData = {};
    const gainsByPaymentMethod = {};
    const gainsByP2pPlatform = {};
    let totalProfitUsd = 0, totalProfitUsdc = 0, totalCryptoVolume = 0, totalFiatVolume = 0;
    let compraOps = 0, ventaOps = 0;

    // --- INICIO DE LA LÓGICA CORREGIDA ---
    // Obtenemos la lista de nombres de las plataformas P2P reales desde la configuración.
    // Asumimos que estas son las que manejan intercambios, no solo transferencias USD.
    const p2pPlatformNames = userConfig.p2pPlatforms
        .filter(p => p.type === 'CRIPTO' || p.type === 'VES')
        .map(p => p.name);
    // --- FIN DE LA LÓGICA CORREGIDA ---

    ops.forEach(op => {
        const opDate = new Date(op.fecha + 'T12:00:00');
        let key;
        if (groupBy === 'week') {
            key = Math.ceil(opDate.getDate() / 7);
        } else {
            key = op.fecha;
        }

        if (!groupedData[key]) {
            groupedData[key] = { profitUsd: 0, profitUsdc: 0 };
        }
        groupedData[key].profitUsd += op.gananciaUsd || 0;
        groupedData[key].profitUsdc += op.gananciaUsdc || 0;

        // 1. Agrupar por Método de Pago (sin cambios, esto es correcto)
        const paymentMethod = op.metodoPago || 'No especificado';
        if (!gainsByPaymentMethod[paymentMethod]) {
            gainsByPaymentMethod[paymentMethod] = { profitUsd: 0, profitUsdc: 0 };
        }
        gainsByPaymentMethod[paymentMethod].profitUsd += op.gananciaUsd || 0;
        gainsByPaymentMethod[paymentMethod].profitUsdc += op.gananciaUsdc || 0;

        // --- INICIO DE LA LÓGICA CORREGIDA ---
        // 2. Agrupar por Plataforma P2P, pero SOLO si la plataforma está en nuestra lista filtrada.
        if (op.platform && p2pPlatformNames.includes(op.platform)) {
            const p2pPlatform = op.platform;
            if (!gainsByP2pPlatform[p2pPlatform]) {
                gainsByP2pPlatform[p2pPlatform] = { profitUsd: 0, profitUsdc: 0 };
            }
            gainsByP2pPlatform[p2pPlatform].profitUsd += op.gananciaUsd || 0;
            gainsByP2pPlatform[p2pPlatform].profitUsdc += op.gananciaUsdc || 0;
        }
        // --- FIN DE LA LÓGICA CORREGIDA ---

        totalProfitUsd += op.gananciaUsd || 0;
        totalProfitUsdc += op.gananciaUsdc || 0;
        
        if(op.operacion === 'Compra') {
            compraOps++;
            totalCryptoVolume += op.reciboUsdc || 0;
            totalFiatVolume += op.envioUsd || 0;
        } else { // Venta
            ventaOps++;
            totalCryptoVolume += op.envioUsdc || 0;
            totalFiatVolume += op.reciboUsd || 0;
        }
    });

    const topUser = Object.entries(ops.reduce((acc, op) => {
        acc[op.usuario] = (acc[op.usuario] || 0) + (op.reciboUsdc || op.envioUsdc || 0);
        return acc;
    }, {})).sort((a,b) => b[1]-a[1])[0];

    return {
        totalProfitUsd, totalProfitUsdc,
        totalCryptoVolume, totalFiatVolume,
        totalOps: ops.length, compraOps, ventaOps,
        roi: totalFiatVolume > 0 ? ((totalProfitUsd + totalProfitUsdc) / totalFiatVolume) * 100 : 0,
        groupedData,
        gainsByPaymentMethod,
        gainsByP2pPlatform,
        topUser: { name: topUser ? topUser[0] : 'N/A', volume: topUser ? topUser[1] : 0 }
    };
}

function generateUsdAnalysisHTML(results, period) {
    // IDs para los gráficos de ganancias por período (semanal/mensual)
    const chartId = period === 'weekly' ? 'usdWeeklyChart' : 'usdMonthlyChart';
    // IDs para los gráficos de desglose (Método de Pago / Plataforma)
    const paymentMethodChartId = period === 'weekly' ? 'usdWeeklyPaymentMethodChart' : 'usdMonthlyPaymentMethodChart';
    const p2pPlatformChartId = period === 'weekly' ? 'usdWeeklyP2pPlatformChart' : 'usdMonthlyP2pPlatformChart';

    return `
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
            <div class="xl:col-span-2 h-72 md:h-80">
                <p class="text-center font-semibold text-sm text-gray-400 mb-2">Ganancias por ${period === 'weekly' ? 'Día' : 'Semana'}</p>
                <canvas id="${chartId}"></canvas>
            </div>

            <hr class="border-gray-700 !my-6">

            <div class="space-y-6">
                <div class="h-60">
                    <p class="text-center font-semibold text-sm text-gray-400 mb-2">Ganancias por Plataforma P2P</p>
                    <canvas id="${p2pPlatformChartId}"></canvas>
                </div>
                <hr class="border-gray-700">
                <div class="h-60">
                     <p class="text-center font-semibold text-sm text-gray-400 mb-2">Ganancias por Método de Pago</p>
                    <canvas id="${paymentMethodChartId}"></canvas>
                </div>
            </div>
        </div>
        
        <hr class="border-gray-700 !my-6">

        <div class="card p-4 bg-background space-y-3">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center text-sm">
                <div class="info-card !p-2"><div class="info-card-title !text-xs">GANANCIA NETA USD</div><div class="info-card-value !text-base text-green-400">${results.totalProfitUsd.toFixed(2)} USD</div></div>
                <div class="info-card !p-2"><div class="info-card-title !text-xs">GANANCIA NETA CRIPTO</div><div class="info-card-value !text-base text-orange-400">${results.totalProfitUsdc.toFixed(4)} USDC</div></div>
                <div class="info-card !p-2"><div class="info-card-title !text-xs">VOLUMEN FIAT</div><div class="info-card-value !text-lg">${results.totalFiatVolume.toFixed(2)} USD</div></div>
                <div class="info-card !p-2"><div class="info-card-title !text-xs">ROI GENERAL</div><div class="info-card-value !text-lg text-blue-400">${results.roi.toFixed(2)}%</div></div>
            </div>
            <hr class="border-gray-700 !my-4">
            <div class="space-y-2 text-sm">
                <div class="flex justify-between items-center"><span><strong>Total Operaciones:</strong></span><span class="font-mono">${results.totalOps} (C: ${results.compraOps} / V: ${results.ventaOps})</span></div>
                <div class="flex justify-between items-center"><span><strong>Usuario más valioso (Vol.):</strong></span><span class="font-mono">${results.topUser.name} (${results.topUser.volume.toFixed(2)} USDC)</span></div>
            </div>
        </div>`;
}

// REEMPLAZA ESTA FUNCIÓN COMPLETA
function renderUsdChart(data, canvasId, instanceVarName) {
    const ctx = document.getElementById(canvasId)?.getContext('2d');
    if (!ctx) return;
    if (window[instanceVarName]) window[instanceVarName].destroy();
    
    const labelsRaw = Object.keys(data).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
    
    // --- INICIO DE LÓGICA DE ETIQUETAS INTELIGENTE ---
    const labels = labelsRaw.map(key => {
        // Si la clave es un número (ej: '1', '2'), es una semana.
        if (!isNaN(key)) {
            return `Semana ${key}`;
        }
        // Si no, es una fecha.
        return new Date(key + 'T12:00:00').toLocaleDateString('es-VE', {day:'2-digit', month:'short'});
    });
    // --- FIN DE LÓGICA DE ETIQUETAS ---

    const profitUsd = labelsRaw.map(key => data[key].profitUsd);
    const profitUsdc = labelsRaw.map(key => data[key].profitUsdc);

    window[instanceVarName] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Ganancia USD', data: profitUsd, backgroundColor: 'rgba(52, 211, 153, 0.7)', yAxisID: 'y' },
                { label: 'Ganancia USDC', data: profitUsdc, backgroundColor: 'rgba(251, 191, 36, 0.7)', yAxisID: 'y1' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'USD' } },
                y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'USDC' }, grid: { drawOnChartArea: false } }
            }
        }
    });
}

// AÑADE ESTAS DOS NUEVAS FUNCIONES A TU SCRIPT

function renderUsdP2pPlatformChart(data, canvasId, instanceVarName) {
    const ctx = document.getElementById(canvasId)?.getContext('2d');
    if (!ctx) return;
    if (window[instanceVarName]) window[instanceVarName].destroy();

    // Filtramos data para solo incluir plataformas con ganancias y que no sean "No especificada"
    const labels = Object.keys(data).filter(key => key !== 'No especificada' && (data[key].profitUsd + data[key].profitUsdc) > 0);
    const chartData = labels.map(p => (data[p].profitUsd || 0) + (data[p].profitUsdc || 0));

    if (labels.length === 0) {
        ctx.font = "14px Inter";
        ctx.fillStyle = "grey";
        ctx.textAlign = "center";
        ctx.fillText("Sin datos de plataformas P2P", ctx.canvas.width/2, ctx.canvas.height/2);
        return;
    }
    
    window[instanceVarName] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels,
            datasets: [{
                data: chartData,
                backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)'],
                borderColor: 'var(--surface)', borderWidth: 3
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: '#C9D1D9', boxWidth: 12 } } } }
    });
}

function renderUsdPaymentMethodChart(data, canvasId, instanceVarName) {
    const ctx = document.getElementById(canvasId)?.getContext('2d');
    if (!ctx) return;
    if (window[instanceVarName]) window[instanceVarName].destroy();

    const labels = Object.keys(data).filter(key => key !== 'No especificado' && (data[key].profitUsd + data[key].profitUsdc) > 0);
    const chartData = labels.map(p => (data[p].profitUsd || 0) + (data[p].profitUsdc || 0));

    if (labels.length === 0) {
        ctx.font = "14px Inter";
        ctx.fillStyle = "grey";
        ctx.textAlign = "center";
        ctx.fillText("Sin datos de métodos de pago", ctx.canvas.width/2, ctx.canvas.height/2);
        return;
    }

    window[instanceVarName] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Ganancia Equivalente (USD)',
                data: chartData,
                backgroundColor: 'rgba(34, 211, 238, 0.7)',
                borderColor: 'rgba(34, 211, 238, 1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y', // Gráfico de barras horizontal
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { ticks: { color: '#C9D1D9' } },
                x: { ticks: { color: '#C9D1D9' } }
            }
        }
    });
}

function renderUsdPlatformChart(gainsByPlatform, canvasId, instanceVarName) {
    const ctx = document.getElementById(canvasId)?.getContext('2d');
    if (!ctx) return;
    if (window[instanceVarName]) window[instanceVarName].destroy();

    const labels = Object.keys(gainsByPlatform);
    const data = labels.map(p => (gainsByPlatform[p].profitUsd || 0) + (gainsByPlatform[p].profitUsdc || 0));
    
    window[instanceVarName] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels,
            datasets: [{
                data,
                backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(16, 185, 129, 0.7)'],
                borderColor: 'var(--surface)', borderWidth: 2
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
    });
}

// ===================================================================
// == FIN: BLOQUE DE CÓDIGO PARA EL NUEVO MODAL DE ANÁLISIS USD     ==
// ===================================================================

        // ===== FIN DEL CÓDIGO A PEGAR (BLOQUE PRINCIPAL) =====
        window.showPage = showPage; window.loginUser = loginUser; window.registerUser = registerUser;
        window.toggleAuthForms = toggleAuthForms; window.logoutUser = logoutUser; window.openModal = openModal;
        window.closeModal = closeModal; window.saveOperation = saveOperation; window.editOperation = editOperation;
        window.deleteOperation = deleteOperation; window.calculateAll = calculateAll; window.openConfigModal = openConfigModal;
        window.closeConfigModal = closeConfigModal; window.saveConfig = saveConfig; 
        window.renderOperations = renderOperations;
        window.openBankBreachModal = openBankBreachModal; window.closeBankBreachModal = closeBankBreachModal;
        window.openLotDetailsModal = openLotDetailsModal; window.closeLotDetailsModal = closeLotDetailsModal;
        window.openPendingDetailsModal = openPendingDetailsModal; window.closePendingDetailsModal = closePendingDetailsModal;
        window.openWallyModal = openWallyModal; window.closeWallyModal = closeWallyModal;
        window.updateWallyFormFields = updateWallyFormFields; window.updateWallyCalculations = updateWallyCalculations;
        window.saveWallyOperation = saveWallyOperation;
        window.pasteSpecial = pasteSpecial; window.pasteSpecialWally = pasteSpecialWally;
        window.openGainsSummaryModal = openGainsSummaryModal;
        window.closeGainsSummaryModal = closeGainsSummaryModal;
        window.openWallyGainsSummaryModal = openWallyGainsSummaryModal;
        window.closeWallyGainsSummaryModal = closeWallyGainsSummaryModal;
        window.addPaymentMethod = addPaymentMethod; window.deletePaymentMethod = deletePaymentMethod;
        window.addUsdPaymentMethod = addUsdPaymentMethod; window.deleteUsdPaymentMethod = deleteUsdPaymentMethod;
        window.openRatingModal = openRatingModal; window.closeRatingModal = closeRatingModal; window.submitRating = submitRating;
        window.renderRatingsPage = renderRatingsPage; window.openUserProfileModal = openUserProfileModal; 
        window.closeUserProfileModal = closeUserProfileModal; window.saveProfileNotes = saveProfileNotes;
        window.deleteWallyOperation = deleteWallyOperation;
        window.editP2PPlatform = editP2PPlatform; window.deleteP2PPlatform = deleteP2PPlatform; window.setDefaultP2PPlatform = setDefaultP2PPlatform;
        window.openInitialCapitalModal = openInitialCapitalModal;
        window.closeInitialCapitalModal = closeInitialCapitalModal;
        window.saveInitialCapital = saveInitialCapital;
        // ... (el resto de las funciones window)
        window.addManagedAccount = addManagedAccount; 
        window.deleteManagedAccount = deleteManagedAccount;
        window.switchProfileTab = switchProfileTab;
        window.renderWallyTables = renderWallyTables;
        window.openWeeklyAnalysisModal = openWeeklyAnalysisModal;
        window.closeWeeklyAnalysisModal = closeWeeklyAnalysisModal;
        // ===== PEGA ESTAS LÍNEAS AQUÍ =====
        window.openMonthlyAnalysisModal = openMonthlyAnalysisModal;
        window.closeMonthlyAnalysisModal = closeMonthlyAnalysisModal;
        window.runMonthlyAnalysis = runMonthlyAnalysis;
        window.openUsdAnalysisModal = openUsdAnalysisModal;
        window.closeUsdAnalysisModal = closeUsdAnalysisModal;
        window.switchUsdAnalysisTab = switchUsdAnalysisTab;
        window.renderUsdAnalysis = renderUsdAnalysis;
        // AÑADE ESTA LÍNEA AL FINAL
        window.enableAudio = enableAudio;
        
    </script>

    <div id="lotClosedAnimation" class="lot-animation-container">
        <div class="lot-animation-card">
            <div class="text-6xl mb-4">🎉</div>
            <h3 class="text-2xl font-bold mb-2">¡Lote Completado!</h3>
            <p class="text-lg text-gray-300">Ganancia del Lote:</p>
            <p id="lotAnimationProfit" class="text-3xl font-extrabold text-green-400 mt-1">0.00 VES</p>
        </div>
    </div>

    <audio id="notificationSound" preload="auto">
        <source src="https://cdn.jsdelivr.net/gh/basthiancasparod-cmyk/DashSY/assets/notification.mp3" type="audio/mpeg">
    </audio>

        <div id="usdAnalysisModal" class="modal">
        <div class="modal-content !max-w-4xl">
            <div class="modal-header flex justify-between items-center">
                <h2 class="modal-title text-xl font-bold">📈 Análisis de Operaciones USD</h2>
                <button class="close-btn" onclick="closeUsdAnalysisModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="flex justify-between items-center border-b border-gray-700 mb-4">
                    <div class="flex space-x-2">
                        <button id="usd-analysis-tab-weekly" class="profile-tab active" onclick="switchUsdAnalysisTab('weekly')">Análisis Semanal</button>
                        <button id="usd-analysis-tab-monthly" class="profile-tab" onclick="switchUsdAnalysisTab('monthly')">Análisis Mensual</button>
                    </div>
                    <div id="usd-month-selector-container" class="filter-item !min-w-[200px] hidden">
                        <select id="usdMonthSelector" onchange="renderUsdAnalysis()"></select>
                    </div>
                </div>

                <div id="usdAnalysisContent">
                    </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeUsdAnalysisModal()">Cerrar</button>
            </div>
        </div>
    </div>
</body>
</html>
